article id="http://dx.doi.org/10.1371/journal.pone.0202344"  #@NEW_LINE#@#  
title  #@NEW_LINE#@#  
Machine learning models in electronic health records can outperform conventional survival models for predicting patient mortality in coronary artery disease  #@NEW_LINE#@#  

Abstract  #@NEW_LINE#@#  
Prognostic modelling is important in clinical practice and epidemiology for patient management and research.  #@NEW_LINE#@#  Electronic health records (EHR) provide large quantities of data for such models, but conventional epidemiological approaches require significant researcher time to implement.  #@NEW_LINE#@#  Expert selection of variables, fine-tuning of variable transformations and interactions, and imputing missing values are time-consuming and could bias subsequent analysis, particularly given that missingness in EHR is both high, and may carry meaning.  #@NEW_LINE#@#  Using a cohort of 80,000 patients from the CALIBER programme, we compared traditional modelling and machine-learning approaches in EHR.  #@NEW_LINE#@#  First, we used Cox models and random survival forests with and without imputation on 27 expert-selected, preprocessed variables to predict all-cause mortality.  #@NEW_LINE#@#  We then used Cox models, random forests and elastic net regression on an extended dataset with 586 variables to build prognostic models and identify novel prognostic factors without prior expert input.  #@NEW_LINE#@#  We observed that data-driven models used on an extended dataset can outperform conventional models for prognosis, without data preprocessing or imputing missing values.  #@NEW_LINE#@#  An elastic net Cox regression based with 586 unimputed variables with continuous values discretised achieved a C-index of 0.801 (bootstrapped 95% CI 0.799 to 0.802), compared to 0.793 (0.791 to 0.794) for a traditional Cox model comprising 27 expert-selected variables with imputation for missing values.  #@NEW_LINE#@#  We also found that data-driven models allow identification of novel prognostic variables; that the absence of values for particular variables carries meaning, and can have significant implications for prognosis; and that variables often have a nonlinear association with mortality, which discretised Cox models and random forests can elucidate.  #@NEW_LINE#@#  This demonstrates that machine-learning approaches applied to raw EHR data can be used to build models for use in research and clinical practice, and identify novel predictive variables and their effects to inform future research.  #@NEW_LINE#@#  

Introduction  #@NEW_LINE#@#  
Advances in precision medicine will require increasingly individualised prognostic assessments for patients in order to guide appropriate therapy.  #@NEW_LINE#@#  Conventional statistical methods for prognostic modelling require significant human involvement in selection of prognostic variables (based on an understanding of disease aetiology), variable transformation and imputation, and model optimisation on a per-condition basis.  #@NEW_LINE#@#  
Electronic health records (EHR) contain large amounts of information about patients medical history including symptoms, examination findings, test results, prescriptions and procedures.  #@NEW_LINE#@#  The increasing quantity of data in EHR means that they are becoming more valuable for research [15].  #@NEW_LINE#@#  Although EHR are a rich data source, many of the data items are collected in a non-systematic manner according to clinical need, so missingness is often high [6, 7].  #@NEW_LINE#@#  The population of patients with missing data may be systematically different depending on the reason that the data are missing [8]: tests may be omitted if the clinician judges they are not necessary [9], the patient refuses [10], or the patient fails to attend.  #@NEW_LINE#@#  Multiple imputation to handle missing data can be computationally intensive, and needs to include sufficient information about the reason for missingness to avoid bias [11].  #@NEW_LINE#@#  
Conventional_versus_data-driven_approaches_to_prognostic_modelling  #@NEW_LINE#@#  
Conventional statistical models, with a priori expert selection of predictor variables [1, 12], have a number of potential shortcomings.  #@NEW_LINE#@#  First, they may be time-consuming to fit and require expert knowledge of the aetiology of a given condition [13].  #@NEW_LINE#@#  Second, such models are unable to utilise the richness of EHR data; a recent meta-analysis [1] found that EHR studies used a median of just 27 variables, despite thousands potentially being available [5].  #@NEW_LINE#@#  Third, parametric models rely on assumptions which may not be borne out in practice.  #@NEW_LINE#@#  For example Cox proportional hazards models assume that a change in a predictor variable is associated with a multiplicative response in the baseline hazard that is constant over time.  #@NEW_LINE#@#  Nonlinearity and interactions need to be built into models explicitly based on prior clinical knowledge.  #@NEW_LINE#@#  Finally, missing data need to be handled using a separate process such as multiple imputation.  #@NEW_LINE#@#  Given that most imputation techniques assume that data are missing at random [11], this may mean that their results are unreliable in this context.  #@NEW_LINE#@#  Imputation can also be time-consuming both for researchers, and computationally given the large cohorts available in EHR data.  #@NEW_LINE#@#  Categorisation of continuous variables can accommodate nonlinear relationships and allow the inclusion of missing data as an additional category [14], but may substantially increase the number of parameters in the model.  #@NEW_LINE#@#  
Machine-learning approaches include automatic variable selection techniques and non-parametric regression methods which can handle large numbers of predictors and may not require as many assumptions about the relationship between particular variables and outcomes of interest [15].  #@NEW_LINE#@#  These have the potential to reduce the amount of human intervention required in fitting prognostic models [1618].  #@NEW_LINE#@#  For example, random survival forests [1921] can accommodate nonlinearities and interactions between variables, and are not restricted to a common baseline hazard for all patients, avoiding the assumptions inherent in Cox proportional hazards models.  #@NEW_LINE#@#  
Previous studies have used machine learning on EHR data for tasks such as patient classification and diagnosis [2224] or predicting future hospitalisation [25], but we are unaware of any systematic comparison of machine learning methods for predicting all-cause mortality in a large, richly characterised EHR cohort of patients with stable coronary artery disease.  #@NEW_LINE#@#  
In this study we compared different analytic approaches for predicting mortality, using a Cox model with 27 expert-selected variables as the reference [13].  #@NEW_LINE#@#  We aimed to:  #@NEW_LINE#@#  


Methods  #@NEW_LINE#@#  
Data_sources  #@NEW_LINE#@#  
We used a cohort of over 80,000 patients from the CALIBER programme [26].  #@NEW_LINE#@#  CALIBER links 4 sources of electronic health data in England: primary care health records (coded diagnoses, clinical measurements, and prescriptions) from 244 general practices contributing to the Clinical Practice Research Datalink (CPRD); coded hospital discharges (Hospital Episode Statistics, HES); the Myocardial Ischemia National Audit Project (MINAP); and death registrations (ONS).  #@NEW_LINE#@#  CALIBER includes about 4% of the population of England [27] and is representative in terms of age, sex, ethnicity, and mortality [26].  #@NEW_LINE#@#  

Patient_population  #@NEW_LINE#@#  
Patients were eligible to enter the cohort after being registered with the general practice for a year.  #@NEW_LINE#@#  If they had pre-existing coronary artery disease (myocardial infarction [MI], unstable angina or stable angina) they entered the cohort on their eligibility date, otherwise they entered on the date of the first stable angina diagnosis after eligibility, or six months after the first acute coronary syndrome diagnosis (MI or unstable angina) after eligibility.  #@NEW_LINE#@#  The six-month delay was chosen to differentiate long-term prognosis from the high-risk period that typically follows acute coronary syndromes.  #@NEW_LINE#@#  For patients whose index diagnosis was MI, we used information in CPRD and MINAP to attempt to classify the type of MI as ST-elevation myocardial infarction (STEMI) or nonST-elevation myocardial infarction (NSTEMI).  #@NEW_LINE#@#  
Diagnoses were identified in CPRD, HES, or MINAP records according to definitions in the CALIBER data portal (www.caliberresearch.org/portal).  #@NEW_LINE#@#  Stable angina was defined by angina diagnoses in CPRD (Read codes) and HES (ICD-10 codes), repeat prescriptions for nitrates, coronary revascularisation (Read codes in CPRD or OPCS-4 codes in HES), or ischaemia test results (CPRD).  #@NEW_LINE#@#  Acute coronary syndromes were defined in MINAP or diagnoses in CPRD and HES.  #@NEW_LINE#@#  

Follow-up_and_endpoints  #@NEW_LINE#@#  
The primary endpoint was death from any cause.  #@NEW_LINE#@#  Patients were followed up until they died (as identified in ONS or CPRD) or transferred out of practice, or until the last data collection date of the practice.  #@NEW_LINE#@#  

Prognostic_factors  #@NEW_LINE#@#  
Expert-selected predictors [28] were extracted from primary care (CPRD) and coded hospital discharges (HES).  #@NEW_LINE#@#  These included cardiovascular risk factors (e.g.  #@NEW_LINE#@#  hypertension, diabetes, smoking, lipid profile), laboratory values, pre-existing diagnoses and prescribed medication.  #@NEW_LINE#@#  Small-area index of multiple deprivation (IMD) score was derived from the patients postcode.  #@NEW_LINE#@#  Table 1 shows all the expert-selected predictors used.  #@NEW_LINE#@#  


              https://doi.org/10.1371/journal.pone.0202344.t001  #@NEW_LINE#@#  
We also generated an extended set of predictor variables for the data-driven models, derived from rich data prior to the index date in CALIBER: primary care (CPRD) tables of coded diagnoses, clinical measurements and prescriptions; and hospital care (HES) tables of coded diagnoses and procedures.  #@NEW_LINE#@#  From each of these sources, we generated new binary variables for the presence or absence of a coded diagnosis or procedure, and numeric variables for laboratory or clinical measurements.  #@NEW_LINE#@#  We selected the 100 least missing variables from each source table, and the 100 least missing of both clinical history and measurements from the primary care data.  #@NEW_LINE#@#  After combining with the pre-selected predictors and removing duplicate and erroneous variables, there were 586 variables per patient in the extended dataset.  #@NEW_LINE#@#  

Ethics  #@NEW_LINE#@#  
Approval was granted by the Independent Scientific Advisory Committee (ISAC) of the Medicines and Healthcare Products Regulatory Agency (protocol 14_107).  #@NEW_LINE#@#  Approval from ISAC is equivalent to approval from an institutional review board.  #@NEW_LINE#@#  All data were fully, irreversibly anonymised before access was provided to the authors.  #@NEW_LINE#@#  

Statistical_methods  #@NEW_LINE#@#  
Imputation_of_missing_data  #@NEW_LINE#@#  
Multiple imputation was implemented using multivariate imputation by chained equations in the R package mice [29], using the full dataset of 115,305 patients.  #@NEW_LINE#@#  Imputation models included:  #@NEW_LINE#@#  
Since many of the continuous variables were non-normally distributed, all continuous variables were log-transformed for imputation and exponentiated back to their original scale for analysis.  #@NEW_LINE#@#  Imputed values were estimated separately for men and women, and five multiply imputed datasets were generated.  #@NEW_LINE#@#  We verified that the distributions of observed and imputed values of all variables were similarly distributed.  #@NEW_LINE#@#  

Training__validation_and_test_sets  #@NEW_LINE#@#  
Before building prognostic models for all-cause mortality, we randomly split the cohort into a training set ( of the patients), and a test set (the remaining ) which was used to evaluate performance of the final models.  #@NEW_LINE#@#  Performance statistics were calculated on repeated bootstrap samples from this held-out test set in order to estimate variability.  #@NEW_LINE#@#  Where cross-validation was performed other than elastic net regression, the training set was randomly split into three folds, and the model trained on two of the folds and performance validated against the third to establish optimal parameters, before those parameters were used to build a model on the full training set.  #@NEW_LINE#@#  

Continuous_Cox_proportional_hazards_models  #@NEW_LINE#@#  
Cox proportional hazards models are survival models which assume all patients share a common baseline hazard function which is multiplied by a factor based on the values of various predictor variables for an individual.  #@NEW_LINE#@#  
Missing values in continuous variables were accommodated both by imputation, and, separately, by explicit inclusion in the model.  #@NEW_LINE#@#  The latter was done by first setting the value to 0, such that it did not contribute to the patients risk, and then employing a missingness indicator with an independent coefficient, meaning an additional binary dummy variable to account for whether a value is missing or not [8, 14].  #@NEW_LINE#@#  For example, risk as a function of time (t) in a Cox model with a single continuous variable with some missingness would be expressed as  #@NEW_LINE#@#  
(1)  #@NEW_LINE#@#  
where 0(t) is the baseline hazard function, 1 is the coefficient relating to the continuous variable; x1 is the variables value (standardised if necessary), set to 0 if the value is missing; missing is the coefficient for that value being missing; and xmissing is 0 if the value is present, and 1 if it is missing.  #@NEW_LINE#@#  

Missing_categorical_data  #@NEW_LINE#@#  
Missingness in categorical data can be dealt with very simply, by adding an extra category for missing.  #@NEW_LINE#@#  This is compatible with both Cox models (in which variables with n categories are parameterised as n  1 dummy variables) and random forests (which can include categorical variables as-is).  #@NEW_LINE#@#  

Discrete_Cox_models_for_missing_values  #@NEW_LINE#@#  
Another method to incorporate missing data is to discretise all continuous predictor variables, and include missing data as an additional category [8, 14].  #@NEW_LINE#@#  Choice of category boundaries then becomes an additional hyperparameter.  #@NEW_LINE#@#  
Discretisation schemes were chosen by cross-validation to avoid overfitting.  #@NEW_LINE#@#  Discretising a value too finely may allow a model to fit the training data with spurious precision and generalise poorly to new data, whilst doing so too coarsely risks losing information carried by that variable.  #@NEW_LINE#@#  Every continuous variable i was split into 10  ni  20 bins, which were assigned in quantiles; for example, a 10-bin discretisation would split patients into deciles.  #@NEW_LINE#@#  An additional category was then assigned for missing values, resulting in ni + 1 coefficients per variable when fitting the Cox model.  #@NEW_LINE#@#  

Random_survival_forests  #@NEW_LINE#@#  
Random survival forests [1921] is an alternative method for survival analysis which has previously been used to model deaths in the context of cardiovascular disease [31].  #@NEW_LINE#@#  It is a machine-learning technique which builds a forest of decision trees, each of which calculates patient outcomes by splitting them into groups with similar characteristics.  #@NEW_LINE#@#  These hundreds to thousands of decision trees each have random imperfections, meaning that whilst individual trees are then relatively poor predictors, the averaged result from the forest is more accurate and less prone to overfitting than an individual perfect decision tree [32].  #@NEW_LINE#@#  
At each node in a decision tree, starting at its root, patients are split into two branches by looking at an individual covariate.  #@NEW_LINE#@#  The algorithm selects a split point which maximises the difference between the survival curves of patients in the two branches defined by that split.  #@NEW_LINE#@#  For a continuous parameter, this is a value where patients above are taken down one branch, and patients below are taken down the other; for a categorical variable, a subset of values is associated with each branch.  #@NEW_LINE#@#  Split points are defined so as to maximise the homogeneity within each branch, and the inhomogeneity between them.  #@NEW_LINE#@#  
Decision trees for regression or classification often use variance or Gini impurity, respectively.  #@NEW_LINE#@#  Survival forests, by contrast, maximise the difference between survival curves as measured by the logrank test [19], or optimise the C-index using which branch a patient falls into as a predictor [21].  #@NEW_LINE#@#  After testing, we found splitting on C-index to be too computationally intensive for negligible performance benefit, so logrank tests were used.  #@NEW_LINE#@#  
This process is repeated until the leaves of the tree are reached.  #@NEW_LINE#@#  These are nodes where either there are no further criteria remains by which the patients at that leaf can be distinguished, including the possibility of only a single patient remaining, or splitting may be stopped early with a minimum node size or maximum tree depth.  #@NEW_LINE#@#  
In a random forest, each tree is created using only a random sample with replacement of the training data, and only a subset of parameters is considered when splitting at each node.  #@NEW_LINE#@#  A forest comprising such trees can then use use the average, majority vote or combined survival curve, for regression, classification and survival forests, respectively, to aggregate the results of the individual trees and predict results for new data.  #@NEW_LINE#@#  
Random survival forests are thus, in principle, able to model arbitrarily shaped survival curves without assumptions such as proportional hazards, and can fit nonlinear responses to covariates, and arbitrary interactions between them.  #@NEW_LINE#@#  
One issue with random forests is that variables with a large number of different values offer many possible split points, which gives them more chances to provide the optimal split.  #@NEW_LINE#@#  One approach to combat this is to use multiple-comparisons corrections to account for the resulting increased likelihood of finding a split point in variables where there are many options [33, 34], but this is complicated by split statistics for adjacent split points being correlated.  #@NEW_LINE#@#  To avoid this issue, we instead used a value nsplit to fix the number of split points tested in continuous variables which also has the advantage of reducing computational time for model building [35].  #@NEW_LINE#@#  
Many methods have been proposed for dealing with missing data in random forests, and these primarily divide into two categories.  #@NEW_LINE#@#  Some methods effectively perform on-the-fly imputation: for example the surrogate variable method, proposed in the classic classification and regression trees (CART) decision tree algorithm, attempts to use nonmissing values to find the variable which splits the data most similarly to the variable initially selected for the split [36].  #@NEW_LINE#@#  Other methods allow missing values to continue through the network, for example by assigning them at random to a branch weighted by the ratio of nonmissing values between branches, known as adaptive tree imputation [19], or sending missing cases down both branches, but with their weights diminished by the ratio of nonmissing values between branches, as used in the C4.5 algorithm [37].  #@NEW_LINE#@#  We used adaptive tree imputation, with multiple iterations of the imputation algorithm due to the large fraction of missing data in many variables used [19].  #@NEW_LINE#@#  
The number of iterations of the imputation process, number of trees, number of split points (nsplit), and number of variables tested at each split point (mtry) were selected with cross-validation.  #@NEW_LINE#@#  

Variable_selection  #@NEW_LINE#@#  
Performance can be improved by variable selection to isolate the most relevant predictors before fitting the final model.  #@NEW_LINE#@#  We evaluated various methods for variable selection: ranking by completeness (i.e.  #@NEW_LINE#@#  retaining those variables with the fewest missing values); by permutation variable importance (which measures a variables contribution to the final model performance by randomly shuffling values for that variable and observing the decrease in C-index), similar to varSelRF [38, 39]; and by effect on survival, as measured by a logrank test between survival curves of different variable values (either true vs false, categories, or all quartiles for continuous variables).  #@NEW_LINE#@#  All of these are inherently univariate, and may neglect variables which have a large effect when in combination with others [15, 40].  #@NEW_LINE#@#  
After ranking, we fitted models to decreasing numbers of the highest-ranked variables and cross-validated to find the optimal number based on the C-index.  #@NEW_LINE#@#  
After selection, the contribution of variables to the final model was assessed by taking the permutation variable importance.  #@NEW_LINE#@#  There are a number of measures of variable importance in common use [41, 42], often using metrics which are specific to random forests, such as the number of times a variable is split upon, or the pureness of nodes following such a split.  #@NEW_LINE#@#  Permutation variable importance is more readily generalised: it is given by the reduction in performance when values of a particular variable are shuffled randomly within the dataset, thus removing its power to aid predictionsthis allows it to be used to assess the importance of variables in other types of model, such as Cox models.  #@NEW_LINE#@#  The impact on model predictivity is assessed and, the larger the impact, the more important the variable is considered to be.  #@NEW_LINE#@#  Permutation variable importance was used in this study in order to allow comparisons across different types of model.  #@NEW_LINE#@#  

Elastic_net_regression  #@NEW_LINE#@#  
Elastic net regression extends regression techniques including Cox models to penalise complex models and thus implicitly select variables during the fitting procedure [40, 43].  #@NEW_LINE#@#  It works by minimising the regularised error function  #@NEW_LINE#@#  
(2)  #@NEW_LINE#@#  
where y is the response variable, X are the input data,  is a vector of coefficients, 0    1 is a hyperparameter for adjusting the weight of the two different regularisation components, and  is a hyperparameter adjusting the overall magnitude of regularisation.  #@NEW_LINE#@#  The hyperparameter  linearly interpolates between a LASSO (least absolute shrinkage and selection operator) and ridge regression: a value  = 0 corresponds to pure LASSO, whilst  = 1 corresponds to pure ridge regression, with intermediate values representing a mixture of the two.  #@NEW_LINE#@#  
The value of  is determined to some extent by the scale of the data, and so normalisation between parameters is important before fitting.  #@NEW_LINE#@#  In our case, values were either binary true/false when referring to the presence or absence of particular codes in a patients medical history, or represented discretised continuous values with an additional missing category, binarised into a one-hot vector for fitting.  #@NEW_LINE#@#  Thus, since all values are either 0 or 1, no normalisation was undertaken before performing the elastic net procedure.  #@NEW_LINE#@#  
Hyperparameters  and  were chosen by grid search with ten-fold cross-validation over the training set.  #@NEW_LINE#@#  Having identified the optimal , this value was used to fit models on bootstrapped samples of the training set to extract model parameters along with an estimate of their variation due to sampling.  #@NEW_LINE#@#  

Model_performance  #@NEW_LINE#@#  
Model performance was assessed using both the C-index, and a calibration score derived from accuracy of five-year mortality risk predictions.  #@NEW_LINE#@#  
The C-index measures a models discrimination, its ability to discriminate low-risk cases from high-risk ones, by evaluating the probability of the model correctly predicting which of two randomly selected patients will die first.  #@NEW_LINE#@#  It ranges from 0.5 (chance) to 1 (perfect prediction).  #@NEW_LINE#@#  The C-index is widely used, but its sensitivity for distinguishing between models of different performance can be low because it is a rank-based measure [44].  #@NEW_LINE#@#  
In particular, the C-index is unable to assess the calibration of a model, which reflects the accuracy of absolute risk predictions made for individual patients.  #@NEW_LINE#@#  A well-calibrated model is particularly important in the context of a clinical risk score, where a treatment may be assigned based on whether a patient exceeds a given risk threshold [45].  #@NEW_LINE#@#  This was determined by plotting patient outcome (which is binary: dead or alive, with patients censored before the date of interest excluded) against mortality risk predicted by the model [44].  #@NEW_LINE#@#  Then, a locally smoothed regression line is calculated, and the area, a, between the regression line and the ideal line y = x provides a measure of model calibration.  #@NEW_LINE#@#  Since a smaller area is better, we define the calibration score as (1  a) such that a better performance results in a higher score.  #@NEW_LINE#@#  This means that, like the C-index, it ranges from 0.5 (very poor) to 1 (perfect calibration).  #@NEW_LINE#@#  

Variable_effects  #@NEW_LINE#@#  
The partial dependency of Cox models on each variable is given by ixi, where i is the coefficient and xi the standardised value of a variable i.  #@NEW_LINE#@#  The associated 95% confidence interval is given by ixi ± ixi where i is the uncertainty on that coefficient.  #@NEW_LINE#@#  Both the risk and the confidence interval are therefore zero at the baseline value where xi = 0.  #@NEW_LINE#@#  In discrete Cox models, coefficients for a given bin j translate directly into an associated ij value, with an 95% confidence interval ij ± ij.  #@NEW_LINE#@#  The lowest bin is defined as the baseline, and consequently has no associated uncertainty.  #@NEW_LINE#@#  
Due to their complex structure, interrogation of variable effects in random forests is more involved than for Cox models.  #@NEW_LINE#@#  They were assessed with partial dependence plots [46] for each variable.  #@NEW_LINE#@#  These are calculated by drawing many patients at random, and then predicting survival for each of them using the random forest many times, holding all variables constant for each patient except the variable of interest whose value is swept through its possible values for each prediction.  #@NEW_LINE#@#  This gives a curve of risks which we then normalised by its average, and then averaged over the set of patients to give a response to that variable.  #@NEW_LINE#@#  Relative changes of this risk can therefore be compared between models, but absolute values are not directly comparable.  #@NEW_LINE#@#  



Results  #@NEW_LINE#@#  
Patient_population  #@NEW_LINE#@#  
A summary of the patient population used in this study is shown in Table 2.  #@NEW_LINE#@#  We initially identified 115,305 patients with coronary disease in CALIBER and, after excluding patients based on criteria relating the timing of the diagnosis and follow-up, 82,197 patients remained in the cohort.  #@NEW_LINE#@#  Imputation models included all 115,305 patients in order to increase precision, with the exclusion flag as an auxiliary variable in imputation models.  #@NEW_LINE#@#  


              https://doi.org/10.1371/journal.pone.0202344.t002  #@NEW_LINE#@#  

Age-based_baseline  #@NEW_LINE#@#  
A baseline model with age as the only predictor attained a C-index of 0.74.  #@NEW_LINE#@#  To calculate the risk and assess calibration, the KaplanMeier estimator for patients of age x years in (a bootstrap sample of) the training set is used, resulting in a well-calibrated model with a calibration score of 0.935 (95% confidence interval: 0.924 to 0.944).  #@NEW_LINE#@#  

Calibration_and_discrimination_of_models  #@NEW_LINE#@#  
A summary of the performance results obtained for modelling time to all-cause mortality using various statistical methods and data is shown in Fig 1.  #@NEW_LINE#@#  
(A) shows discrimination (C-index) and (B) shows calibration (1  a, where a is the area between the observed calibration curve and an idealised one for patient risk at five years).  #@NEW_LINE#@#  Bar height indicates median performance across bootstrap replicates, with error bars representing 95% confidence intervals.  #@NEW_LINE#@#  Columns 14 represent variations on the Cox proportional hazards models using the 27 expert-selected variables used in Ref.  #@NEW_LINE#@#  [13].  #@NEW_LINE#@#  Column 1 shows a model with missing values included with dummy variables; column 2 shows a model where continuous values have been discretised and missing values included as an additional category; column 3 shows a model where missing values have been imputed; and column 4 shows a model where missing values have been imputed and then all values discretised with the same scheme as column 2.  #@NEW_LINE#@#  Columns 57 show the performance of random survival forests.  #@NEW_LINE#@#  Column 5 uses the 27 expert-selected variables with missing values included with missingness indicators, and column 6 uses the imputed dataset.  #@NEW_LINE#@#  Columns 7 and 8 show models based on a subset of the 600 least missing variables across a number of different EHR data sources, selected by cross-validation.  #@NEW_LINE#@#  7 is a random forest model with missing values left as-is, while 8 is a Cox proportional hazards model with continuous values discretised.  #@NEW_LINE#@#  Column 9 is an elastic net regression based on all 600 variables.  #@NEW_LINE#@#  


              https://doi.org/10.1371/journal.pone.0202344.g001  #@NEW_LINE#@#  
Comparing between models, the discrimination performance of random forests is similar to that of the best Cox models, but they performed worse in calibration, underperforming the Cox model with imputed data by 0.098 (0.105 to 0.091, 95% confidence interval on distribution of differences between bootstrap replicates).  #@NEW_LINE#@#  A calibration curve for this model is shown in Fig 2(A).  #@NEW_LINE#@#  In view of this unexpectedly poor calibration performance, we also attempted to fit five-year survival with a classification forest.  #@NEW_LINE#@#  The binary outcome of being dead or alive at five years is essentially a classification problem, and it was possible that metrics for node purity during classification may be more reliable than those used in survival modelling.  #@NEW_LINE#@#  However, this proved to be both worse calibrated and worse discriminating than survival-based models, perhaps due to loss of the large number of censored patients in the dataset.  #@NEW_LINE#@#  A random survival forest implicitly takes censored patients into account by splitting based on logrank scores of survival curves, whereas a simple classification forest must discard them, perhaps losing valuable information.  #@NEW_LINE#@#  
Curves show calibration of (A) model 5 (poorly-calibrated) and (B) model 9 (well-calibrated) from Fig 1.  #@NEW_LINE#@#  Each semi-transparent dot represents a patient in a random sample of 2000 from the test set, the x-axis shows their risk of death at five years as predicted by the relevant model, and the y-axis shows whether each patient was in fact dead or alive at that time.  #@NEW_LINE#@#  The curves are smoothed calibration curves derived from these points, and the area between the calibration curve and the black line of perfect calibration is a in the calibration score, 1  a.  #@NEW_LINE#@#  


              https://doi.org/10.1371/journal.pone.0202344.g002  #@NEW_LINE#@#  
Imputing missing values has some effect on model performance.  #@NEW_LINE#@#  Comparing the two continuous Cox models, column 1s model includes missingness indicators and column 3s model imputes missing values.  #@NEW_LINE#@#  Discrimination is very slightly improved in the imputed model, but calibration performance remains the same.  #@NEW_LINE#@#  Discretising continuous values without imputing has a similar effect, improving C-index slightly with little effect on calibration score.  #@NEW_LINE#@#  
To assess the impact of imputation on performance model-agnostically, we performed an empirical test by fitting a random forest model to the imputed dataset.  #@NEW_LINE#@#  The C-index remained similar, but calibration improves dramatically, almost achieving the same performance as the Cox model.  #@NEW_LINE#@#  This is suggestive but not decisive evidence that some information may leak between training and test sets, or from future observations, during imputation.  #@NEW_LINE#@#  
On the extended dataset, random forests fitted with all variables performed badly, even when cross-validated to optimise mtry.  #@NEW_LINE#@#  After trying the different techniques discussed in Methods to rank important variables, by far the best random forest performance was achieved when variables were ranked by within-variable logrank test.  #@NEW_LINE#@#  This gave rise to a model using 98 of the variables, with a C-index of 0.797 (0.796 to 0.798).  #@NEW_LINE#@#  Unfortunately, even on the extended dataset random forests are similarly poorly calibrated to those fitted to the expert-selected dataset, under-performing the Cox model with imputed data by 0.086 (0.078 to 0.093).  #@NEW_LINE#@#  
A Cox model was also fitted to the extended dataset, with all continuous variables discretised into deciles.  #@NEW_LINE#@#  Variables were again ranked by within-variable logrank tests, and cross-validated to give a model comprising 155 variables.  #@NEW_LINE#@#  Its C-index performance was comparable to other models, and also has the highest median calibration performance of 0.966 (0.961 to 0.970).  #@NEW_LINE#@#  
Finally, an elastic net model was fitted to the discretised extended dataset.  #@NEW_LINE#@#  The optimal value of the hyperparameter  = 0.90 was determined by grid-search, and fixed for the remainder of the analysis.  #@NEW_LINE#@#  The hyperparameter  was selected by ten-fold cross-validation on the full training dataset, returning nonzero coefficients for 270 variables.  #@NEW_LINE#@#  Bootstrapped replicates were again used to assess model performance, giving a calibration score of 0.075 (0.0679 to 0.0812), and the highest discrimination score of all models with a C-index of 0.801 (0.799 to 0.802).  #@NEW_LINE#@#  A calibration plot for this model is shown in Fig 2(B).  #@NEW_LINE#@#  

Effect_of_different_methods_for_missing_data  #@NEW_LINE#@#  

Fig 3(A) shows coefficients associated with variables compared between a model based on imputation, and models based on accounting for missing values with missingness indicators, and discretisation.  #@NEW_LINE#@#  Most of the risks have similar values between models, showing that different methods of dealing with missing data preserve the relationships between variables and outcome.  #@NEW_LINE#@#  
(A) Fitted coefficients for different Cox models compared.  #@NEW_LINE#@#  Values of risks from both the continuous model with missingness indicators, and the discretised model are plotted against the continuous imputed Cox model.  #@NEW_LINE#@#  There are fewer points for the discretised model as coefficients for continuous values are not directly comparable.  #@NEW_LINE#@#  The very large error bars on four of the points correspond to the risk for diagnoses of STEMI and NSTEMI.  #@NEW_LINE#@#  This is due to the majority (73%) of heart attack diagnoses being MI (not otherwise specified) from which the more specific diagnoses were imputed, introducing significant uncertainty.  #@NEW_LINE#@#  (B) For the continuous Cox model with missingness indicators, risk ranges for the ranges of values for variables present in the dataset (violin plots) with risk associated with that value being missing (points with error bars).  #@NEW_LINE#@#  CRN = creatinine, HGB = haemoglobin, HDL = high-density lipoprotein, WBC = white blood cell count, TC = total cholesterol; for smoking status, miss = missing, ex = ex-smoker and curr = current smoker, with non-smokers as the baseline.  #@NEW_LINE#@#  (C) Survival curves for selected variables, comparing patients with a value recorded for that variable versus patients with a missing value.  #@NEW_LINE#@#  These can be compared with risks associated with a missing value, seen in (B): HDL and TC show increased risk where values are missing, whilst CRN shows the opposite, which is reflected in the survival curves.  #@NEW_LINE#@#  


              https://doi.org/10.1371/journal.pone.0202344.g003  #@NEW_LINE#@#  
Explicitly coding missing data as a missingness indicator allows us to associate a risk with that variable having no value in a patients record.  #@NEW_LINE#@#  These are examined in Fig 3(B), compared to the range of risks implied by the range of values for a given variable.  #@NEW_LINE#@#  Having a missing value is associated with very different risk depending on which variable is being observed, indicating that missingness carries information about a patients prognosis.  #@NEW_LINE#@#  Where risks fall outside the range of risks associated with values found in the dataset, we validated these associations by plotting survival curves comparing patients with and without a particular value missing.  #@NEW_LINE#@#  These curves, shown in Fig 3(C), agree with the coefficients shown in Fig 3(B): variables whose missingness carries a higher risk than the normal range of values show a worse survival curve for patients with that value missing, and vice-versa.  #@NEW_LINE#@#  

Variable_and_missing_value_effects  #@NEW_LINE#@#  
Next, we examined variable effects between models.  #@NEW_LINE#@#  These are shown in Fig 4, with row (A) showing the continuous and discrete Cox models on unimputed data, and row (B) showing partial effects plots derived from the random survival forest models.  #@NEW_LINE#@#  
(A) Comparisons between relative log-risks derived from the continuous Cox models (straight blue lines, light blue 95% CI region) against those derived from the discretised models (green steps, light green 95% CI region), together with log-risks associated with those values being missing (points with error bars on the right of plots).  #@NEW_LINE#@#  Confidence intervals on the continuous models represent ixi for each variable xi, and hence increase from the value taken as the baseline where xi = 0.  #@NEW_LINE#@#  The lowest-valued bin of the discrete Cox model is taken to be the baseline and has no associated uncertainty.  #@NEW_LINE#@#  Discrete model lines are shifted on the y-axis to align their baseline values with the corresponding value in the continuous model to aid comparison; since these are relative risks, vertical alignment is arbitrary.  #@NEW_LINE#@#  (B) Partial dependence plots [46] inferred from random forests.  #@NEW_LINE#@#  Semitransparent black lines show the change in log-risk of death after five years from sweeping across possible values of the variable of interest whilst holding other variables constant.  #@NEW_LINE#@#  Results are normalised to average mortality across all values of this variable.  #@NEW_LINE#@#  Thick orange lines show the median of the 1000 replicates, indicating the average response in log-risk to changing this variable.  #@NEW_LINE#@#  


              https://doi.org/10.1371/journal.pone.0202344.g004  #@NEW_LINE#@#  
The partial effects of these variables show varying levels of agreement depending on model used.  #@NEW_LINE#@#  Risk of death rises exponentially with age, with the discrete Cox models response having a very similar gradient to the continuous model.  #@NEW_LINE#@#  Haemoglobin and total white blood cell count are in close agreement between these models too, with only slight deviations from linearity in the discrete case.  #@NEW_LINE#@#  Creatinine shows a pronounced increase in mortality at both low and high levels in the discrete model, which the linear model is unable to capture.  #@NEW_LINE#@#  The risks associated with having a missing value show broad agreement between the Cox models.  #@NEW_LINE#@#  
Random forest variable effect plots differ somewhat from the equivalent Cox model coefficients.  #@NEW_LINE#@#  The sign of the overall relationship is always the same, but all display quite pronounced deviations from linearity, especially at extreme values.  #@NEW_LINE#@#  

Variable_selection_and_importance_in_data-driven_models  #@NEW_LINE#@#  

Fig 5 shows the permutation variable importances for the 20 most important variables in the random forest and discrete Cox models fitted to the large dataset, after variable selection.  #@NEW_LINE#@#  All three models identify several variables which are also present in the expert-selected dataset, including the two most important (age and smoking status).  #@NEW_LINE#@#  There is also significant agreement within the 20 selected variables between models, with the top three appearing in the same order in the random forest and Cox model, and all appearing in the top five for the elastic net.  #@NEW_LINE#@#  
Variables which are either identical or very similar to those found in the expert-selected dataset are highlighted with a blue dot; variables appearing in two of the models are joined by a pink line (with reduced opacity for those which pass behind the middle graph); whilst variables appearing in all three are joined by green lines.  #@NEW_LINE#@#  Some variable names have been abbreviated for space: ACE inhibitors = angiotensin-converting enzyme inhibitors; ALP = alkaline phosphatase; analgesics = non-opioid and compound analgesics; ALT = alanine aminotransferase; Beta2 agonists = selective beta2 agonists; blood pressure = diastolic blood pressure; BMI = body mass index; CKD = chronic kidney disease; Insulin = intermediate- and long-acting insulins; LV failure = left ventricular failure; Hb = haemoglobin; MCV = mean corpuscular volume; Na = sodium; PVD = peripheral vascular disease; Records held date = date records held from; WCC = total white blood cell count.  #@NEW_LINE#@#  


              https://doi.org/10.1371/journal.pone.0202344.g005  #@NEW_LINE#@#  
When performing cross-validation to select variables for the Cox and random forest models, we observed large performance differences between ranking methods.  #@NEW_LINE#@#  Random forest variable importance on the full dataset performed poorly; it was a noisy measure of a variables usefulness, with significantly different variable rankings were returned on successive runs of the algorithm.  #@NEW_LINE#@#  Ranking variables by missingness performed better, but still significantly below the models using expert-selected variables.  #@NEW_LINE#@#  By far the best performance was achieved when variables were ranked by within-variable logrank test, which was used for both the random forest and discrete Cox models fitted here.  #@NEW_LINE#@#  


Discussion  #@NEW_LINE#@#  
We compared Cox modelling and data-driven approaches for all-cause mortality prediction in a cohort of over 80,000 patients in an electronic health record dataset.  #@NEW_LINE#@#  All models tested had good performance.  #@NEW_LINE#@#  This suggests that, quantified by discrimination and calibration performance, there is no need to impute EHR data before fitting predictive models, nor to select variables manually.  #@NEW_LINE#@#  It also invites the use of data-driven models in other contexts where important predictor variables are not known.  #@NEW_LINE#@#  
Advantages_of_data-driven_approaches  #@NEW_LINE#@#  
Data-driven modelling has both practical and theoretical advantages over conventional survival modelling [5, 24].  #@NEW_LINE#@#  It may require less user input, through automated variable selection.  #@NEW_LINE#@#  Further, both our method of converting continuous to categorical data (by quantiles), and random forest modelling are robust to arbitrary monotonic transformations of a variable, removing the need to manually normalise or transform data before analysis.  #@NEW_LINE#@#  
The ability to analyse data without the need for prior imputation also saves researcher time, and allows the effect of missingness in particular variables to be examined.  #@NEW_LINE#@#  It also has the potential to improve model performance in settings where missingness carries meaning.  #@NEW_LINE#@#  It is also possible for new patients to be assessed without the need for a clinician to impute, or take additional measurements, in order to obtain a risk score.  #@NEW_LINE#@#  
Discretisation of continuous values can accommodate nonlinear and nonmonotonic responses to variables, without requiring time-consuming choice and tuning of these relationships [47].  #@NEW_LINE#@#  
Machine learning techniques can also make use of more data, which in other datasets or settings may give rise to further improved performance over conventional models.  #@NEW_LINE#@#  Variable selection allows its use in contexts where risk factors are unknown.  #@NEW_LINE#@#  

Comparison_of_modelling_methods  #@NEW_LINE#@#  
We found that random forests did not outperform Cox models despite their inherent ability to accommodate nonlinearities and interactions [48, 49].  #@NEW_LINE#@#  Random forests have a number of shortcomings which may explain this.  #@NEW_LINE#@#  First, only a random subset of variables (mtry) are tried at each split, so datasets that contain a large proportion of uninformative noise variables may cause informative variables to be overlooked by chance at many splits.  #@NEW_LINE#@#  Increasing mtry can improve performance, but often at a large cost in computation time.  #@NEW_LINE#@#  Second, when random forests are used for prediction, the predictions are a weighted average of a subset of the data, and are biased away from the extremes [50].  #@NEW_LINE#@#  This may partly explain their poor calibration.  #@NEW_LINE#@#  
We did not find that discretisation of continuous variables improved model performance, probably because the majority of these variables had associations with prognosis that were close to linear, and the small improvement in fit was offset by the large increase in the number of model parameters.  #@NEW_LINE#@#  
Elastic nets achieved the highest discrimination performance of any model tested, demonstrating the ability of regularisation to select relevant variables and optimise model coefficients in an EHR context.  #@NEW_LINE#@#  

Missing_data  #@NEW_LINE#@#  
We also found that missing values may be associated with greater or lesser risk than any of the measured values depending on the potential reasons for a values presence or absence.  #@NEW_LINE#@#  For example, serum creatinine needs to be monitored in people on certain medication, and is less likely to be measured in healthy people.  #@NEW_LINE#@#  Conversely, missing high-density lipoprotein (HDL) or total cholesterol (TC), used for cardiovascular risk prediction in preventive care, was associated with worse outcomes.  #@NEW_LINE#@#  
There was little difference in model performance with or without imputation of missing values.  #@NEW_LINE#@#  It is possible that this did not have a large effect in the expert-selected dataset because only six variables carried missing values and, of these, only three had risks significantly different from the range of measured values.  #@NEW_LINE#@#  The majority of the variables were Boolean (e.g.  #@NEW_LINE#@#  presence of diagnoses) and were assumed to be completely recorded, where absence of a record was interpreted as absence of the condition.  #@NEW_LINE#@#  
One shortcoming of the use of imputation in our analysis is that, to our knowledge, no software is able to build an imputation model on a training set and then apply that model to new data.  #@NEW_LINE#@#  As a consequence, we performed imputation across the whole dataset, but this violates the principle of keeping training and test data entirely separate to prevent information leaking between them.  #@NEW_LINE#@#  Further, because future values are used in the imputation process, this adds additional potential for introducing bias to models using such data.  #@NEW_LINE#@#  We investigated this empirically by fitting a random forest model to the imputed dataset (see Results) and found some evidence that bias may be introduced.  #@NEW_LINE#@#  If this is the case, the benefits of imputation to model performance may be less than suggested here.  #@NEW_LINE#@#  

Variable_selection  #@NEW_LINE#@#  
Finally, we found that data-driven modelling with large numbers of variables is sensitive to the modelling and variable selection techniques used.  #@NEW_LINE#@#  Random forests without variable selection performed poorly, which is evident from both the poor performance of fitted models, and the lack of utility of random forest variable importance as a measure by which to rank variables during selection.  #@NEW_LINE#@#  
Variable selection using the least missing data performed better, but not as well as expert selection.  #@NEW_LINE#@#  This may be because many of the variables with low missingness were uninformative.  #@NEW_LINE#@#  Variable selection using univariate logrank tests was far more successful, allowing models with slightly higher performance than expert selection, and discrete Cox models based on this displayed the best calibration performance.  #@NEW_LINE#@#  
Elastic net regression offered the best C-index performance, by fitting a Cox model with implicit variable selection.  #@NEW_LINE#@#  Since this selection process operates simultaneously across coefficients for all variables, it is possible that this explains its improved performance over ranking by univariate measures applied to random forests.  #@NEW_LINE#@#  
High-ranking variables in our final model (Fig 5) seem plausible.  #@NEW_LINE#@#  Well-known prognostic factors such as age and smoking status were strongly associated with mortality, as expected.  #@NEW_LINE#@#  Many of the other variables identified, such as prescriptions for cardiovascular medications, are proxy indicators of the presence and severity of cardiovascular problems.  #@NEW_LINE#@#  Finally, some variables are proxies for generalised frailty, such as laxative prescriptions, home visits etc.  #@NEW_LINE#@#  These may be unlikely to considered for a prognostic model constructed by experts as they are not obviously related to cardiovascular mortality, and this demonstrates a potential benefit of data-driven modelling in EHR to both identify these novel variables, and improve model performance by incorporating them.  #@NEW_LINE#@#  
The important caveat is that these correlative relationships are not necessarily causal, and may not generalise beyond the study population or EHR system in which they were originally derived [1].  #@NEW_LINE#@#  For example, our finding that home visits are a highly ranked variable is likely to be indicative of frailty, but its contribution will change depending on the criteria for such visits and the way they are recorded, which may vary between healthcare systems or over time.  #@NEW_LINE#@#  

Disadvantages_of_data-driven_approaches  #@NEW_LINE#@#  
Data-driven and machine learning based techniques come with several disadvantages.  #@NEW_LINE#@#  Firstly, the degree of automation in these methods is not yet complete; random forests worked showed poor performance on the full 586-variable dataset without variable selection.  #@NEW_LINE#@#  Use with other datasets or endpoints currently requires some researcher effort to identify optimal algorithms and variable selection methods.  #@NEW_LINE#@#  It would be useful to develop tools which would automate this, and test them across a multitude of different EHR systems and endpoints.  #@NEW_LINE#@#  
Secondly, it can be difficult to interpret the final models.  #@NEW_LINE#@#  Whilst it is possible to use variable effect plots to understand the relationship between a few variables and an outcome, this is prohibitively complex with high-dimensional models.  #@NEW_LINE#@#  In addition, not imputing missing values makes it difficult to interpret coefficients for partially observed variables, as they include a component of the reason for missingness.  #@NEW_LINE#@#  When prognostic models are used in clinical practice, it is important to be able to trust that the data are incorporated appropriately into the model so that clinicians can justify decisions based on the models.  #@NEW_LINE#@#  
Conventional statistical modelling techniques retain advantages and disadvantages which are the converse of these: models are more readily interpretable, and may generalise better, but at the expense of requiring significant expert input to construct, potentially not making use of the richness of available data, and only being applicable to complete data.  #@NEW_LINE#@#  

Limitations_of_this_study  #@NEW_LINE#@#  
These methods were compared in a single study dataset, and replication in other settings would be needed to demonstrate the generalisability of the findings.  #@NEW_LINE#@#  
The simple approach of using the top 100 least-missing variables from each table for development of the data-driven models is unlikely to be the optimal approach.  #@NEW_LINE#@#  In particular, some highly present variables are administrative and have little prognostic value, while significant but rare variables could be overlooked.  #@NEW_LINE#@#  
There are many types of model we did not consider in this study, including support vector machines and neural networks, which may provide improved prognostic performance.  #@NEW_LINE#@#  However, machine learning libraries for survival data are not well-developed, limiting the model types which can be tested without significant time devoted to software and model development.  #@NEW_LINE#@#  

Conclusion  #@NEW_LINE#@#  
We have demonstrated that machine learning approaches on routine EHR data can achieve comparable or better performance than expert-selected, imputed data in manually optimised models for risk prediction.  #@NEW_LINE#@#  Our comparison of a range of machine learning algorithms found that elastic net regression performed best, with cross-validated variable selection based on logrank tests enabling Cox models and random forests to achieve comparable performance.  #@NEW_LINE#@#  
Data-driven methods have the potential to simplify model construction for researchers and allow novel epidemiologically relevant predictors to be identified, but achieving good performance with machine learning requires careful testing of the methods used.  #@NEW_LINE#@#  These approaches are also disease-agnostic, which invites their further use in conditions with less well-understood aetiology.  #@NEW_LINE#@#  
Eventually, machine learning approaches combined with EHR may make it feasible to produce fine-tuned, individualised prognostic models, which will be particularly valuable in patients with conditions or combinations of conditions which would be very difficult for conventional modelling approaches to capture.  #@NEW_LINE#@#  


Code_and_data  #@NEW_LINE#@#  
The scripts used for analysis in this paper are available at https://github.com/luslab/MLehealth.  #@NEW_LINE#@#  
While our data does not contain any sensitive personal identifiers, it is deemed as sensitive as it contains sufficient clinical information about patients such as dates of clinical events for there to be a potential risk of patient re-identification.  #@NEW_LINE#@#  This restriction has been imposed by the data owner (CPRD/MHRA) the data sharing agreements between UCL and the CPRD/MHRA.  #@NEW_LINE#@#  Access to data may be requested via the Clinical Practice Research Datalink (CPRD) and applying to the CPRDs Independent Scientific Advisory Committee (https://www.cprd.com/researcher/).  #@NEW_LINE#@#  

Acknowledgments  #@NEW_LINE#@#  
The authors thank Sera Aylin Cakiroglu for performing the imputation with MICE, and for her help with the data curation and preparation and the design of the study.  #@NEW_LINE#@#  This work was supported by the Francis Crick Institute which receives its core funding from Cancer Research UK (FC001110), the UK Medical Research Council (FC001110), and the Wellcome Trust (FC001110).  #@NEW_LINE#@#  NML and HH were supported by the Medical Research Council Medical Bioinformatics Award eMedLab (MR/L016311/1).  #@NEW_LINE#@#  The CALIBER programme was supported by the National Institute for Health Research (RP-PG-0407-10314, PI HH); Wellcome Trust (WT 086091/Z/08/Z, PI HH); the Medical Research Prognosis Research Strategy Partnership (G0902393/99558, PI HH) and the Farr Institute of Health Informatics Research, funded by the Medical Research Council (K006584/1, PI HH), in partnership with Arthritis Research UK, the British Heart Foundation, Cancer Research UK, the Economic and Social Research Council, the Engineering and Physical Sciences Research Council, the National Institute of Health Research, the National Institute for Social Care and Health Research (Welsh Assembly Government), the Chief Scientist Office (Scottish Government Health Directorates) and the Wellcome Trust.  #@NEW_LINE#@#  

References  #@NEW_LINE#@#  


