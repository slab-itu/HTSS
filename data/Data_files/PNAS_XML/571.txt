article id="http://dx.doi.org/10.1073/pnas.1616926114"  #@NEW_LINE#@#  
title  #@NEW_LINE#@#  
Ontogeny of collective behavior reveals a simple attraction rule  #@NEW_LINE#@#  

Significance  #@NEW_LINE#@#  
Different interaction rules among animals can produce patterns of collective motion similar to those observed in bird flocks or fish schools.  #@NEW_LINE#@#  To help distinguish which rules are implemented in animal collectives, we studied the birth of the interaction rule in zebrafish during development from hatching to the juvenile stage.  #@NEW_LINE#@#  We used newly developed machine vision algorithms to track each animal in a group without mistakes.  #@NEW_LINE#@#  A weak attraction starts after hatching and gets stronger every day during development.  #@NEW_LINE#@#  Attraction consists in each larva moving toward one other larva chosen effectively at random and then switching to another one.  #@NEW_LINE#@#  This rule, simply by statistics, makes each individual move to regions of high density of individuals to produce collective motion.  #@NEW_LINE#@#  

Abstract  #@NEW_LINE#@#  
The striking patterns of collective animal behavior, including ant trails, bird flocks, and fish schools, can result from local interactions among animals without centralized control.  #@NEW_LINE#@#  Several of these rules of interaction have been proposed, but it has proven difficult to discriminate which ones are implemented in nature.  #@NEW_LINE#@#  As a method to better discriminate among interaction rules, we propose to follow the slow birth of a rule of interaction during animal development.  #@NEW_LINE#@#  Specifically, we followed the development of zebrafish, Danio rerio, and found that larvae turn toward each other from 7 days postfertilization and increase the intensity of interactions until 3 weeks.  #@NEW_LINE#@#  This developmental dataset allows testing the parameter-free predictions of a simple rule in which animals attract each other part of the time, with attraction defined as turning toward another animal chosen at random.  #@NEW_LINE#@#  This rule makes each individual likely move to a high density of conspecifics, and moving groups naturally emerge.  #@NEW_LINE#@#  Development of attraction strength corresponds to an increase in the time spent in attraction behavior.  #@NEW_LINE#@#  Adults were found to follow the same attraction rule, suggesting a potential significance for adults of other species.  #@NEW_LINE#@#  

Results  #@NEW_LINE#@#  
We video-recorded isolated zebrafish and groups of two, four, or seven in an arena of 9 to 10 bodylengths (BL) of radius every day from 7 dpf, in which they start to swim, until 24 dpf (Fig 1A; see Fig S1A for setup).  #@NEW_LINE#@#  We used idTracker (34) to obtain the trajectory of each animal in a group using a method of image fingerprinting without the need for manual corrections (Fig 1B).  #@NEW_LINE#@#  Correct identification of individuals is necessary for tests at the individual level but also to obtain the correct values of quantities derived from trajectory data like velocities or accelerations.  #@NEW_LINE#@#  
Ontogeny_of_Collective_Behavior_in_Zebrafish  #@NEW_LINE#@#  
We first analyzed experiments that used pairs of zebrafish.  #@NEW_LINE#@#  A simple measure of whether two animals are interacting is given by their distance apart.  #@NEW_LINE#@#  We found that the most likely distance, or mode, is significantly lower than control randomized data from 9 dpf (Fig 2A).  #@NEW_LINE#@#  The median distance is significant from 11 dpf (Fig S1B), and the mean distance is significant from 12 dpf (Fig S1C); this is because the distributions of distances are asymmetric, and the mode separates better data from control early in development (Fig S1D).  #@NEW_LINE#@#  
We obtained similar results in the AB zebrafish strain, but significance in mode, median, and mean distance start from 11 dpf (Fig S2).  #@NEW_LINE#@#  Also, the analysis can be given in terms of fish BL instead of age (Fig S3).  #@NEW_LINE#@#  
Interactions may depend not only on the distance between animals but also on the relative positions in space.  #@NEW_LINE#@#  Relative positions were studied using a coordinate system with origin on the focal animal and positive y axis pointing in the direction of its velocity vector (Fig 2B, top left).  #@NEW_LINE#@#  We then computed the probability of finding the second animal in space (Fig 2B; numbers indicate age).  #@NEW_LINE#@#  At 7 dpf to 11 dpf, animals spend significantly more time side by side than in front/back positions, and during 12 dpf to 24 dpf, they spend increasingly more time close to each other.  #@NEW_LINE#@#  Around the focal animal, there is also a region of low probability of finding the second animal (Fig S1E).  #@NEW_LINE#@#  This region reduces size during development (Fig S1F).  #@NEW_LINE#@#  
Distance and relative positions do not directly distinguish whether animals repel or attract each other.  #@NEW_LINE#@#  Attraction and repulsion can be studied more directly by measuring whether an individual accelerates toward or away from another individual (9, 10).  #@NEW_LINE#@#  As acceleration values change during development also for nonsocial interactions, we found it more useful to compute the probability of accelerating toward particular places.  #@NEW_LINE#@#  Specifically, we computed the probability (Pturn) that the focal turns to the side where the other fish is.  #@NEW_LINE#@#  This probability is significant from 7 dpf and increases during development (Fig 3A).  #@NEW_LINE#@#  For the AB zebrafish strain, significance starts from 8 dpf (Fig S2D).  #@NEW_LINE#@#  
More detail about attraction can be obtained studying the probability of turning to the right side depending on the location of the second animal (Fig 3B).  #@NEW_LINE#@#  For 24 dpf, for example, the focal animal more often accelerates to the right (left) when the other animal is at its right (left) (Fig 3B, day 24).  #@NEW_LINE#@#  This attraction structure starts to be significant at 6 dpf to 7 dpf and gets stronger during development (Fig 3B).  #@NEW_LINE#@#  
Attraction can also be studied to the front or back position (Fig S4), giving that, at 10 dpf to 24 dpf, animals accelerate to another animal in front and brake when behind, and, at 6 dpf to 9 dpf, there is some repulsion from an animal behind (Fig S4B).  #@NEW_LINE#@#  

Using_Development_to_Extract_the_Rule_of_Attraction  #@NEW_LINE#@#  
We used experiments with four fish to find whether there is an attraction rule that can explain the data.  #@NEW_LINE#@#  We found best correspondence by a model in which each animal interacts a proportion of the time by moving toward a randomly chosen individual (Fig 4A).  #@NEW_LINE#@#  According to this model, when a focal has N1 animals to one side and N2 animals to the other, the probability of choosing the side with N1 animals would be given byP(N1|N1:N2)=psN1N1+N2+(1ps)12,[1]and P(N2|N1:N2)=1P(N1|N1:N2) for the other side.  #@NEW_LINE#@#  This probability has two contributions.  #@NEW_LINE#@#  The first contribution comes from the proportion of time ps spent in interactions in which the focal chooses one animal at random and thus the side with N1 animals with probability N1/(N2+N2).  #@NEW_LINE#@#  The second contribution comes from the remaining proportion of time, 1ps, in which the focal does not interact with other animals, giving, in our experiments, in which no consistent leftright asymmetry exists, a probability 1/2 for each side.  #@NEW_LINE#@#  
The model in Eq.  #@NEW_LINE#@#  1 has one parameter, the time spent in interactions, ps, but also makes predictions independent of this parameter.  #@NEW_LINE#@#  For experiments using four animals, a focal fish can be found with zero and three fish to its sides (configuration 0:3) or one and two fish (configuration 1:2).  #@NEW_LINE#@#  The model predicts a relationship between the probabilities for these two configurations that is independent of the parameter asP(1|1:2)=13+13P(0|0:3),[2]plotted as a solid red line in Fig 4B.  #@NEW_LINE#@#  Another relationship is the one between the probability of turning to the side of no animals for these experiments with four animals and those experiments with only two animals asP(0|0:3)=P(0|0:1),[3]plotted as a solid blue line in Fig 4C.  #@NEW_LINE#@#  The general parameter-free relationship between two probabilities can be found in Methods.  #@NEW_LINE#@#  
We checked that these theoretical predictions in Eqs.  #@NEW_LINE#@#  2 and 3 are also seen in agent-based simulations in which each agent turns with probability ps to the side of another agent chosen at random and, with probability 1ps, turns left or right randomly (Fig S5B, dots for different values of ps; see Methods for details of simulations).  #@NEW_LINE#@#  
For the analysis of the experimental data, we realized that the probability of turning to one side is random when another animal is very close, increases with the distance to another animal, and, at 2.5 BL, is independent of distance (Fig S6A).  #@NEW_LINE#@#  As for this first analysis we are not considering space dependencies of attraction, we used only data when animals are at 2.5 BL from the focal.  #@NEW_LINE#@#  We found that these experimental data correspond well with the theoretical predictions in Eq.  #@NEW_LINE#@#  2 (Fig 4B) and Eq.  #@NEW_LINE#@#  3 (Fig 4C), with different days marked with corresponding numbers.  #@NEW_LINE#@#  
Another prediction of the interaction rule in Eq.  #@NEW_LINE#@#  1 is that the probability of turning to the side with N1 animals grows linearly with N1 as N1/(N1+N2).  #@NEW_LINE#@#  Groups of four animals only have two possible configurations, (0:3) and (1:2), so, for a proper test of this linearity, we used the four configurations arising in groups of seven fish (Fig 4D).  #@NEW_LINE#@#  
We also checked that animals do not favor turning toward the side with the closer, intermediate, or farthest neighbor.  #@NEW_LINE#@#  The probability that the side chosen is the one with the closest animal is found to be very similar to the probability that it is the side with the animal at intermediate distance or the side with the farthest animal during all development (Fig 4E).  #@NEW_LINE#@#  Our agent-based simulations with agents turning to another randomly chosen agent also give this result (Fig S5B, column 4).  #@NEW_LINE#@#  
We simulated alternative agent-based models with one of eight other interaction rules, including turning to the side with more animals (Fig S5C), to the side of the center of mass of the rest of the group (Fig S5D), to the closest animal (Fig S5E), to the center of mass of the two closest neighbors (Fig S5F), to the second neighbor (Fig S5G), and to the third neighbor (Fig S5H), and using the nonlinear decision rules from ref.  #@NEW_LINE#@#  14 (Fig S5J) and ref.  #@NEW_LINE#@#  21 (Fig S5I).  #@NEW_LINE#@#  We found worse correspondence with experimental data using any of these eight rules in Fig S5CJ than the theoretical predictions from Eq.  #@NEW_LINE#@#  1 (Fig S5A) or its implementation with agents turning toward one animal chosen at random (Fig S5B).  #@NEW_LINE#@#  

N1_Using_the_Attraction_Rule_for_a_Quantitative_Description_of_Development  #@NEW_LINE#@#  
Once we tested the parameter-free predictions of the model, we used its attraction parameter ps in Eq.  #@NEW_LINE#@#  1 to give a compact description of changes during development.  #@NEW_LINE#@#  For each day ti, we computed three values for ps(ti) by fitting Eq.  #@NEW_LINE#@#  1 to the experimental probabilities P(2|2:1), P(0|0:3), and P(0|0:1) of that day and computed its mean value (Fig 4F, dots).  #@NEW_LINE#@#  The value of the attraction parameter increases rapidly during development and could be fitted for the period 6 dpf to 24 dpf with the exponential exp((x28.6)/6) (Fig 4F, line).  #@NEW_LINE#@#  
Inserting ps=exp((x28.6)/6) into Eq.  #@NEW_LINE#@#  1, one obtains that the change during development of the different probabilities obtained in groups of two and four fish is expected to be of the formP(2|1:2)(t)=12exp((x28.6)/6)+12[4]P(3|0:3)(t)=P(1|0:1)=16exp((x28.6)/6)+12.  #@NEW_LINE#@#  [5]These expressions correspond well with the experimental development of the probabilities P(1|0:1), P(3|0:3), and P(2|1:2) (Fig 4G).  #@NEW_LINE#@#  
We also performed experiments on adult zebrafish of 150 dpf to assess how developed interactions are by 24 dpf.  #@NEW_LINE#@#  For example, the attraction parameter ps increases exponentially from a value of 0.01 at 6 dpf to a value of 0.47 at 24 dpf, but only has a very small increase to a value of 0.54 in the adult stage of 150 dpf (Fig S7A).  #@NEW_LINE#@#  The other parameters measuring interaction also have values at 24 dpf close to those at 150 dpf (Fig S7).  #@NEW_LINE#@#  

Agent-Based_Modeling  #@NEW_LINE#@#  
We used the agent-based model to test further the ability of the attraction rule in Eq.  #@NEW_LINE#@#  1 to explain experiments.  #@NEW_LINE#@#  Agents turn in the direction of a randomly chosen neighbor with probability ps (taking values from Fig 4F), whereas, with probability 1ps, they choose randomly to turn left or right.  #@NEW_LINE#@#  As the model was designed to describe the turning dynamics, we expected that turning properties would correspond well to experiments (Fig S8A and B).  #@NEW_LINE#@#  
We also expected that agents would come together, and more so the higher the value of ps.  #@NEW_LINE#@#  It is less obvious that the model can give a quantitative description of aggregation properties, as these could depend on other factors apart from the turning properties.  #@NEW_LINE#@#  However, the match between simulations and experiments was found to be quantitative for the most likely distance between two fish (Fig 5A), their mean distance (Fig S8C), the distributions of distances (Fig S8D), and the relative positions (Fig S8E).  #@NEW_LINE#@#  
We also tested for the formation of groups of different sizes, defined by how many animals are together at a distance, say, of less than 6 BL.  #@NEW_LINE#@#  Simulations predicted, for example, that it is only from 18 dpf that the most common group configuration in experiments with four animals should be groups of 4 (Fig 5B, Top), and this is also seen in experiments (Fig 5B, Bottom).  #@NEW_LINE#@#  
Finally, we used simulations to test interaction models more complex than Eq.  #@NEW_LINE#@#  1.  #@NEW_LINE#@#  We had seen in the data that attraction depends on distance to another fish for a distance less than 2.5 BL (Fig S6A), but we ignored it in our analysis using Eq.  #@NEW_LINE#@#  1.  #@NEW_LINE#@#  A second feature seen in experiments is some repulsion from behind the focal animal (Fig S4B), and, again, this was ignored in our analysis using Eq.  #@NEW_LINE#@#  1.  #@NEW_LINE#@#  Simulations including these two additional features gave results very similar to those of the simpler version (Fig S9).  #@NEW_LINE#@#  


Discussion  #@NEW_LINE#@#  
Attraction among zebrafish was found to start at 7 dpf; by 9 dpf, they are likely found close to each other, and, by 2 weeks, they swim in groups.  #@NEW_LINE#@#  
We used this dataset of development of interactions to test the parameter-free predictions of a model according to which animals spend part of the time in interactions with conspecifics by turning toward an animal chosen at random.  #@NEW_LINE#@#  The interaction rule makes each animal likely initiate motion toward a high density of animals.  #@NEW_LINE#@#  
We also found that our proposed rule corresponds well to adult behavior in our freely moving experiments (Fig S7), even better than a rule we had previously obtained specifically for adult zebrafish (Fig S5J).  #@NEW_LINE#@#  We thus suggest that our rule may be relevant in other species.  #@NEW_LINE#@#  
An important element of our rule in Eq.  #@NEW_LINE#@#  1 is that each animal is not interacting at all times.  #@NEW_LINE#@#  The only parameter of our rule is ps, which measures the probability of interaction.  #@NEW_LINE#@#  At 67 dpf, the ps value is very close to zero (Fig 4F), and this translates into animals spending most of their time doing something different than interacting with other animals.  #@NEW_LINE#@#  The value of ps increases exponentially until 24 dpf to a value of 0.47, similar to the adult value of 0.54.  #@NEW_LINE#@#  These values of ps correspond to animals interacting with a probability close to 0.5, avoiding lumping without the need for a strong repulsion.  #@NEW_LINE#@#  In fact, most changes during development can be explained simply by an increase in the amount of time spent in interactions (Fig 4F).  #@NEW_LINE#@#  Adding two extra features seen in the experiments, a reduced attraction at less_than2.5 BL and a weak repulsion from behind at early stages, gives results very similar to those of the simpler rule alone.  #@NEW_LINE#@#  
Our rule bears some resemblance to rules from the selfish herd hypothesis (15) used to explain tight group formations in the presence of a predator at an unknown location (3540).  #@NEW_LINE#@#  Hamilton considered moving to the center of mass of the two closest neighbors as the ideal rule and moving to the closest neighbor as a simpler rule.  #@NEW_LINE#@#  These two rules make animals lump together, but adding to them a probability to interact lower than 1, as we did for Eq.  #@NEW_LINE#@#  1, avoids lumping and brings the modified rule closer to our data.  #@NEW_LINE#@#  We have tested these two rules and six other variants, and found a worse correspondence than with our proposed rule (Fig S5).  #@NEW_LINE#@#  Nevertheless, the ideal rule of Hamilton corresponded well with our data for the relationship between turning probabilities (Fig S5F, columns 1 and 2).  #@NEW_LINE#@#  The turning probabilities themselves are, however, more nonlinear than the experimental ones (Fig S5F, column 3).  #@NEW_LINE#@#  This rule also favors the two closest neighbors more than seen in the experiments (Fig S5F, column 4).  #@NEW_LINE#@#  
Our results suggest that collective behavior may be driven by an attention-like mechanism by which each individual in a group selects one out the many images of conspecifics.  #@NEW_LINE#@#  As we found attraction early in development, one could take advantage of the high transparency of zebrafish larvae to perform image processing of social information in neuronal circuits (4143).  #@NEW_LINE#@#  A natural extension of attention mechanisms to more complex rules of interaction in other contexts or species is to consider biases in attention by a variety of properties of the other animals, including their distance, speed, direction of movement, or body posture.  #@NEW_LINE#@#  

Methods  #@NEW_LINE#@#  
Trajectories of individuals in groups for the 549 videos and analysis routines named as idSocial package can be obtained from www.idtracker.es/idsocial.  #@NEW_LINE#@#  
Housing_and_Maintenance  #@NEW_LINE#@#  
We used wild-type zebrafish from ZF Biolabs and the AB strain.  #@NEW_LINE#@#  Animals were kept in Petri dishes of 15 cm diameter inside an incubator with a 14/10 lightdark cycle until 5 dpf at 27.5 °C.  #@NEW_LINE#@#  Larvae were given powder food (sera micron) three times a day once they had started foraging.  #@NEW_LINE#@#  Excess food and debris were removed twice a day, and one third of the water was replaced with fresh system water.  #@NEW_LINE#@#  At 5 dpf, zebrafish larvae were transferred to the experimental setup (Fig S1A) consisting of an external tank of dimensions 95 × 135 × 30 cm containing 180 L of system water at 27.5 °C, filtered and heated by an external filter system (Fluval 406, Teco TR 5).  #@NEW_LINE#@#  This external tank contained two 12 × 12 × 30 cm holding tanks, submerged up to 2/3 of their height in the water of the external tank to keep temperature constant.  #@NEW_LINE#@#  A weak flow of fresh water was delivered from the external tank.  #@NEW_LINE#@#  Each holding tank had approximately 100 larvae.  #@NEW_LINE#@#  During the experiments, only larvae from the same holding tank were grouped together.  #@NEW_LINE#@#  Water temperature and lightdark cycle were kept the same as in the incubator.  #@NEW_LINE#@#  The feeding protocol stayed the same as in the incubator until 12 dpf, when, for the midday feeding, the powder food was replaced by live artemia.  #@NEW_LINE#@#  Adults were transferred to the experimental setup 48 h before starting the experiments.  #@NEW_LINE#@#  They were kept in two 25 × 10 × 15 cm holding tanks, each holding 25 fish.  #@NEW_LINE#@#  They were fed dry food three times a day.  #@NEW_LINE#@#  All other conditions were the same as for larvae.  #@NEW_LINE#@#  

Recording_Conditions  #@NEW_LINE#@#  
Videos were recorded with a Basler 622f camera and a Zeiss 16-mm objective.  #@NEW_LINE#@#  We used a watch glass as experimental arena, as animals spend less time in its borders compared with a Petri dish.  #@NEW_LINE#@#  It was placed at the center of a transparent Plexiglas board, which was submerged enough to cover the watch glass from below to keep the temperature constant and to reduce reflections at the airglass boundary.  #@NEW_LINE#@#  Before each new trial, the watch glass was taken out of the setup and cleaned.  #@NEW_LINE#@#  It was then filled with a small volume of system water, and animals were transferred to it from holding tanks.  #@NEW_LINE#@#  BL of all larvae in the arena was determined using a custom-made script (www.idtracker.es/idsocial) to manually select snout and tail of each animal.  #@NEW_LINE#@#  Another custom script used the mean BL to plot a circle of radius 9 to 10 BL on the live camera image to mark the desired borders of the arena, and system water was added to this target.  #@NEW_LINE#@#  The height of the camera was then adjusted until the arena covered the whole image, resulting in a BL of 50 pixels for each animal.  #@NEW_LINE#@#  The homogeneity of the illumination was checked using a custom-made script (www.idtracker.es/idsocial), which simulated the background/foreground segmentation of idTracker (34) to guarantee tracking quality.  #@NEW_LINE#@#  We then recorded a 20-min video for each trial.  #@NEW_LINE#@#  For adults, we used a custom-made acrylic arena in the shape of a watch glass with diameter 75 cm and maximum depth of 6.5 cm.  #@NEW_LINE#@#  Experimental protocol was as for larvae.  #@NEW_LINE#@#  

Computation_of_Trajectories  #@NEW_LINE#@#  
The output of idTracker (14) is the center of mass of each animal for each frame.  #@NEW_LINE#@#  SI Text and Fig S10 give the procedure for trajectory smoothing by a moving average.  #@NEW_LINE#@#  The velocity vector of an individual in frame t is then calculated from its smoothed trajectory as the difference between its xy coordinate in frame t and frame t1, v(t)[x(t+1),y(t+1)][x(t),y(t)], and acceleration is calculated as a(t)v(t+1)v(t).  #@NEW_LINE#@#  Using distance, relative distance, and these velocity and acceleration vectors, the toolbox idSocial (downloadable from www.idtracker.es/idsocial) gives a variety of methods to study interactions, including those used in this paper (Fig S11).  #@NEW_LINE#@#  

Control_Randomized_Data  #@NEW_LINE#@#  
Control data are obtained by randomization of the original data.  #@NEW_LINE#@#  For any video of two animals with N frames, we paired the position of fish 1 in each frame ti, x1(ti), with the position of fish 2 in a random frame trand,i separated from ti by at least 16,000 frames to avoid any correlations, x2(trand,i).  #@NEW_LINE#@#  From the video with N frames, we then get the N pairs [x1(ti),x2(trand,i)].  #@NEW_LINE#@#  Repeating this 20 times with different random numbers and also for fish 2 instead of fish 1, we get 40 versions of the N pairs [x1(ti),x2(trand,i)], equivalent to having 40 control randomized videos per experimental video.  #@NEW_LINE#@#  
For control randomized data in the study of acceleration of the focal, a1(ti), depending on position of the second fish, we used analogous procedure to obtain the pairs [a1(ti),x2(trand,i)].  #@NEW_LINE#@#  

Significance_Tests  #@NEW_LINE#@#  
Significance is then obtained as the probability that the control randomized data give the experimental result.  #@NEW_LINE#@#  Using the procedure to build control randomized data, if, for a given age, we have M videos, we then obtain 40×M control videos.  #@NEW_LINE#@#  We illustrate in the following how to use these control videos for a significance analysis of the mean distance between two fish at a given age.  #@NEW_LINE#@#  For each of the M experimental videos of fish pairs taken at that age (say M=10), we obtain a mean distance, giving 10 values of mean distance, whose mean is dexp.  #@NEW_LINE#@#  From the 400 control videos, we extract 400 mean distance values.  #@NEW_LINE#@#  We then draw 10 random values from these 400 and compute their mean, d. This is repeated 10,000 times, giving 10,000 values of d and we compute the P value as the proportion of these 10,000 with values equal to or smaller than the experimental value, P(ddeq).  #@NEW_LINE#@#  
For probability maps, we run an analogous procedure, but using 1,000 repetitions for each bin of the map.  #@NEW_LINE#@#  

Parameter-Free_Relationship_Between_Pairs_of_Configurations  #@NEW_LINE#@#  
Eq.  #@NEW_LINE#@#  1 implies a parameter-free relationship between any pair of asymmetric configurations (N1:N2 with N1N2 and N1¯:N1¯ with N1¯N2¯) asP(N1|N1:N2)=12+(N1N2)(N1¯+N2¯)(N1+N2)(N1¯N2¯)(P(N1¯|N1¯:N2¯)12).[6]Eqs.  #@NEW_LINE#@#  2 and 3 are two particular cases of this expression.  #@NEW_LINE#@#  

Calculation_of_the_Mode  #@NEW_LINE#@#  
We used kernel density estimation with an Epanechnikov kernel and a bandwidth of two BL to obtain smooth continuous distributions from which the value with maximum probability was calculated.  #@NEW_LINE#@#  

Agent-Based_Model  #@NEW_LINE#@#  
The movement of N agents is simulated by fixing a set of rules for the interaction among them and with the borders of the arena.  #@NEW_LINE#@#  Agents move at constant speed and turn a fixed angle in the direction of a randomly chosen neighbor with probability ps, whereas, with probability 1ps, they choose randomly to turn left or right.  #@NEW_LINE#@#  The correspondence between the value ps and day of development is as in the data from Fig 4F.  #@NEW_LINE#@#  Fig S5 uses alternative interaction rules.  #@NEW_LINE#@#  For the nonsocial part of the model, we used as constant speed the mean experimental speed (Fig S6B), the turning at a relevant experimental value (Fig S6C), and interactions with the borders of arena mimicking experimental ones (SI Text).  #@NEW_LINE#@#  


SI_Text  #@NEW_LINE#@#  

Tracking_and_Trajectory_Smoothing  #@NEW_LINE#@#  
The extraction of the coordinates of each individual in each video frame was done automatically by idTracker.  #@NEW_LINE#@#  Those frames in which the probability of the identity assigned to an individual by idTracker was below 0.9 were neglected in all following analyses of this individual.  #@NEW_LINE#@#  
Coordinates in idTracker are calculated as the center of mass of the set of pixels corresponding to each animal in a video frame.  #@NEW_LINE#@#  As such, they are subject to noise due to fluctuations in illumination and in the posture of the animals.  #@NEW_LINE#@#  Although noise only leads to small deviations in the xy coordinates, it has a greater effect on the velocity and, especially, the acceleration of an animal, which are calculated from the coordinates.  #@NEW_LINE#@#  
Moreover, the trajectory of an animal contains information on movements belonging to different time scales, for example, quick undulating movements that fish use to propel themselves forward and slower changes of direction used to approach conspecifics or destinations within the arena.  #@NEW_LINE#@#  
To both account for the noise and be able to analyze different time scales, we applied a simple moving average smoothing, which calculates the coordinate of an individual in a frame as the mean over a fixed number of frames previous and subsequent to this frame.  #@NEW_LINE#@#  In our analysis, a trajectory obtained by idTracker is split into its x and y coordinates, which are then smoothed separately.  #@NEW_LINE#@#  The width of the smoothing window and thus the time scale was carefully chosen, applying two criteria: Firstly, we manually checked that coordinates taken from the smoothed trajectory did not deviate excessively from those taken from the original trajectory, by overlaying the resulting trajectory on top of the original video.  #@NEW_LINE#@#  Fig S10A illustrates how the smoothing parameter affects the deviation from the original trajectory.  #@NEW_LINE#@#  Secondly, we compared results from various smoothing parameters.  #@NEW_LINE#@#  Fig S10B shows maps of the probability of turning to the right depending on the relative position of the neighbor for smoothing parameters ranging from 1 to 100 frames (0.03 to 3 s).  #@NEW_LINE#@#  Although the leftright pattern in the turning maps gets more pronounced with increasing parameter values, the controls from randomization also develop a similar pattern.  #@NEW_LINE#@#  This similarity is due to the fact that both the probability of turning toward the center of the arena and the probability of finding the conspecific in the same direction as the center of the arena increase for individuals who are close to the border (Fig S6D).  #@NEW_LINE#@#  Combining these criteria, we chose a window width of 30 frames (corresponding to 0.9 s), a value for which the resulting patterns are clearly visible, but still not too pronounced in the randomized controls.  #@NEW_LINE#@#  
The velocity vector of an individual in frame t is then calculated from its smoothed trajectory as the difference between its xy coordinates in frame t and frame t1, v(t)=[x(t+1),y(t+1)][x(t),y(t)], and acceleration is calculated as a(t)=v(t+1)v(t).  #@NEW_LINE#@#  Using distance, relative distance, and these smoothed velocity and acceleration vectors, the toolbox idSocial (downloadable from www.idtracker.es/idsocial) gives a variety of methods to study interactions (Fig S11).  #@NEW_LINE#@#  

Trajectory_Filtering  #@NEW_LINE#@#  
In all analyses, only those frames were taken into account in which the focal animal was moving with a speed greater than 0.1 BL/s; this was done because the velocity and acceleration (and therefore also direction of movement) can only be calculated reliably from the trajectory if coordinates in adjacent frames are sufficiently apart from each other.  #@NEW_LINE#@#  In addition, by restricting our analyses to moving animals, we avoid ambiguous results like small interindividual distances resulting from the aggregation of motionless animals for nonsocial reasons.  #@NEW_LINE#@#  Those trials in which all animals were present simultaneously (i.e., their identities were not lost by idTracker due to crossings, and the probability of the identity assigned to each animal in the frame is 0.9) in less than 20% of all frames were discarded.  #@NEW_LINE#@#  
For some of the analyses, additional filters were applied to trajectories: The turning (Pturn) and acceleration (Pacc) probabilities in Fig 3A and Figs.  #@NEW_LINE#@#  S2D, S3D, S4A, S7H, S8A, and S9G were calculated from frames in which the distance between individuals was smaller than six BL, corresponding to the maximum radius of the maps shown in Figs.  #@NEW_LINE#@#  2B and 3B.  #@NEW_LINE#@#  
Turning probabilities P(N1|N1:N2) in Fig 4 are obtained for each focal individual only from frames in which all neighbors were farther away than 2.5 BL, to exclude effects resulting from close-range interaction between animals.  #@NEW_LINE#@#  The radius of 2.5 BL coincides with the range of reduced attraction determined in Fig S6A.  #@NEW_LINE#@#  
For results shown in Fig 4, only frames in which all animals were present (i.e., their positions were successfully determined by idTracker and were not lost, for example, due to crossings of various animals) were used in the analysis to guarantee that the configuration (N1:N2) of neighbors could be determined correctly.  #@NEW_LINE#@#  To reduce the effect of the border, only frames in which the focal animal was within a radius of 0.75× (radius of the arena) from the center of the arena were taken into account for group sizes two and four animals, and 0.5× (radius of the arena) for a group size of seven animals.  #@NEW_LINE#@#  

Simulation  #@NEW_LINE#@#  
Outline  #@NEW_LINE#@#  
The movement of N agents a1,a2aN is simulated by fixing a set of rules for the interaction between various agents and interactions between the agents and the borders of a circular arena.  #@NEW_LINE#@#  Agents turn in the direction of a randomly chosen neighbor with a probability ps, whereas, with a probability 1ps, they choose randomly to turn left or right.  #@NEW_LINE#@#  Repulsion from the border is obtained by increasing the probability of turns toward the center when agents get close to the border of the arena and by letting them move parallel to the walls when they touch the border.  #@NEW_LINE#@#  In addition, simulations presented in Fig S9 incorporate reduced attraction at close interindividual distances by decreasing the social weight ps within a fixed radius around each agent, and repulsion is simulated by a sharp increase in speed when an agent is approached by another from behind.  #@NEW_LINE#@#  

Parameters_and_Movement_Variables  #@NEW_LINE#@#  
These rules are implemented using the following parameters and variables:  #@NEW_LINE#@#  
The border of the arena is defined by a circle with radius Rarena=9.5 BL.  #@NEW_LINE#@#  The BL for each age is obtained from experiments.  #@NEW_LINE#@#  Because the ratio of radius and absolute BL is kept constant throughout all experiments, the BL in pixels stays approximately constant at around 50 pixels (whereas the absolute BL increases as in Fig S3A), and so does the diameter, which is 950 pixels.  #@NEW_LINE#@#  The arena is centered at xy coordinates carena=(Rarena,Rarena).  #@NEW_LINE#@#  
The sampling time tsim determines with which frequency the position and orientation of each agent is updated.  #@NEW_LINE#@#  In our simulations, we choose tsim=0.015 s, which is half the time between frames in our experimental videos (at a frame rate of 33 fps to 34 fps).  #@NEW_LINE#@#  
The update time  determines the frequency at which the interaction state of each agent is updated (social or nonsocial; see Simulation, Update of Interaction State).  #@NEW_LINE#@#  The updated state will stay the same for a period of /t time steps.  #@NEW_LINE#@#  At the beginning of each period, each agent is selected to either interact socially with one of its neighbors or not to interact with any agent.  #@NEW_LINE#@#  The update time is set to =0.03 s, matching the frame rate of our experimental videos.  #@NEW_LINE#@#  Simulations with different update times between 0.015 s and 0.45 s do not differ strongly from results for =0.03 s.  #@NEW_LINE#@#  
The step width s(Age) by which each agent can move between adjacent time steps is taken from the mean speed obtained from experimental results (Fig S6B).  #@NEW_LINE#@#  Because the experimental speed is calculated for a fixed frame rate rexp=1/texp, the step width is extrapolated according to the sampling rate of the simulation rsim=1/tsim66.71/s, and thus ssim=tsim/texpsexp12sexp, with sexp=1.7 pixels/frame.  #@NEW_LINE#@#  
The turning angle  by which an agent can change its orientation between two time steps is set to =tsim/texp0.07 rad, a value that was chosen considering the distribution of experimentally obtained turning angles, which show no clear change with age (Fig S6C).  #@NEW_LINE#@#  The chosen value corresponds approximately to the 83rd percentile of the distributions.  #@NEW_LINE#@#  
Repulsion from the borders of the arena is simulated in terms of an increase in the probability of turns away from the border/toward the center of the arena.  #@NEW_LINE#@#  Experimental results that we obtain by pooling data from single-animal experiments of age 6 dpf to 24 dpf show that animals tend to increase the probability of turning toward the center of the arena (Fig S6D) when they are close to the borders of the arena.  #@NEW_LINE#@#  We approximate the probability of turning toward the center by a piecewise linear fit: In an arena of radius Rarena, the probability pc(dan,c) of an individual turning toward the center when being at a distance dan,c from the center is given bypc(dan,c)={0.5ifdan,cless_than0.7Rarena0.0133+0.73dan,cif0.7Rarenadan,cless_thanRarena,[S1]where dan,c is defined bydan,c(t)=(xan(t)Rarena)2+(yan(t)Rarena)2.  #@NEW_LINE#@#  [S2]To determine if an agent has to turn to the left or to the right to turn toward the center, the angle between the direction of movement nan(t) of agent an and the unit vector han,c(t)=(hx(t)hy(t)) pointing from agent an to the center of the arena c is calculated froman,c(t)=atan2(nxhyhxny,nxny+hxhy).  #@NEW_LINE#@#  [S3]The angle an,c lies in the range [] and is (in contrast to standard use) measured clockwise, i.e., an,c is positive (negative) if the center is at the right (left) hand side of agent an.  #@NEW_LINE#@#  
Here, atan2 is the four-quadrant inverse tangent (as calculated by the Matlab function atan2) defined byatan2(y,x)={arctanyxifx0arctanyx+ifxless_than0,y0arctanyxifxless_than0,yless_than02ifx=0,y02ifx=0,yless_than00ifx=0,y=0.  #@NEW_LINE#@#  [S4]The probability of interacting socially with a neighbor is captured by the social weight ps(Age).  #@NEW_LINE#@#  We perform simulations with values of ps(Age) taken from experimental data (Fig 4F).  #@NEW_LINE#@#  
As can be seen from experimental data, the probability of an animal turning toward its conspecific depends on the distance between the two animals (Fig S6A) and increases steadily from 0.5 (corresponding to randomly turning toward or away from the neighbor) at distance 0 until reaching a limit value at a distance of about 2.5 BL.  #@NEW_LINE#@#  This behavior is simulated by adjusting the social weight when a neighbor is found within the radius of reduced attraction rred from the focal,psred(dan,am)={ps(Age)dan,amrredifdan,amless_thanrredps(Age)ifdan,amrred.  #@NEW_LINE#@#  [S5]For the results presented in Fig S9, rred is set to 2.5 BL.  #@NEW_LINE#@#  
In addition, animals tend to accelerate when a conspecific is approaching them from behind (Fig S4B).  #@NEW_LINE#@#  For the results presented in Fig S9, this acceleration is simulated by increasing the step width s(Age) of the focal agent by the forward acceleration arep when a neighbor is behind and within the repulsion radius rrep,srep=s(Age)+arepifdan,amless_thanrrep.  #@NEW_LINE#@#  [S6]Acceleration is set to arepexp=15 pixels per frame2, coinciding with the range of highest values of acceleration we observe in our data, and rrep=rred=2.5 BL.  #@NEW_LINE#@#  In analogy with the step width, acceleration is extrapolated to take into account the sampling rate of the simulation, resulting in arep=tsim/texparepsim.  #@NEW_LINE#@#  
Neither repulsion nor reduced attraction is included in the simulations presented in Agent-Based Modeling (Fig 5) or Figs.  #@NEW_LINE#@#  S5 and S8.  #@NEW_LINE#@#  
The position of each agent within the arena at time step t is defined by itsx and y coordinates [x(t),y(t)].  #@NEW_LINE#@#  
The orientation or direction of movement of each agent is given by the angle an(t) between the direction of movement of the agent and the x axis.  #@NEW_LINE#@#  Because the orientation determines the direction of movement, it is connected to the position by the update conditionxan(t+1)=xan(t)+s(Age)cos[an(t)]yan(t+1)=yan(t)+s(Age)sin[an(t)].  #@NEW_LINE#@#  [S7]The interindividual distance between two agents an and am is calculated as the euclidean distance given bydan,am(t)=[xan(t)xam(t)]2+[yan(t)yam(t)]2.  #@NEW_LINE#@#  [S8]  #@NEW_LINE#@#  
Social interactions between agents are calculated on the basis of the relative positions between agents, which determine if a neighbor is at the right- or left-hand side of an agent.  #@NEW_LINE#@#  For that purpose, the angle an,am between the direction of movement nan(t)=(nxny)=(cos[an(t)]sin[an(t)]) of agent an and the unit vector ran,am=(rxry)=1dan,am(t)(xam(t)xan(t)yam(t)yan(t)) pointing from agent an to its neighbor am is calculated froman,am=atan2(nxryrxny,nxny+rxry).  #@NEW_LINE#@#  [S9]The angle an,am lies in the range [] and is (in contrast to standard use) measured clockwise, i.e., an,am is positive (negative) if neighbor am is at the right (left) hand side of agent an.  #@NEW_LINE#@#  

Initial_Step  #@NEW_LINE#@#  
In the initial step (t=0), the position [xan(0),yan(0)] of each agent an is randomly chosen from the set of all possible combinations of xy coordinates (x¯g,y¯h) for which the euclidean distance from the center of the arena is smaller than 0.7Rarena,(x¯gRarena)2+(y¯hRarena)2less_than0.7Rarena.  #@NEW_LINE#@#  [S10]The initial orientation an(0) at t=0 for each agent is randomly chosen from the range [02].  #@NEW_LINE#@#  

Update_of_Interaction_State  #@NEW_LINE#@#  
Every /t time steps, it is determined whether an agent is interacting socially or not in the following way: The real number san is randomly drawn from a uniform distribution on the interval [01].  #@NEW_LINE#@#  If sanless_thanps(Age), agent an is selected for interacting socially with one of its neighbors.  #@NEW_LINE#@#  Otherwise, if sanps(Age), its movement will be updated independently of its neighbors.  #@NEW_LINE#@#  

Update_of_Position_and_Orientation  #@NEW_LINE#@#  
In every time step t=t,2tT, the position and orientation of each agent is updated using the following rules, which correspond to nonsocial behavior, attractive (social) behavior, interaction between individuals at close range, repulsion, and interactions with the arena borders.  #@NEW_LINE#@#  The duration of the simulation T corresponds to the 20-min duration of our experiments.  #@NEW_LINE#@#  

Analysis  #@NEW_LINE#@#  
For the analyses presented in Fig 5 and Figs.  #@NEW_LINE#@#  S5, S8, and S9, the same methods were used as for the corresponding analysis of experimental data, with the exception that, for simulations without repulsion and distance-dependent attraction, neighbors closer than 2.5 BL were not filtered out.  #@NEW_LINE#@#  No smoothing was applied to the trajectories obtained from simulations.  #@NEW_LINE#@#  Because the update rate rsim is twice as high in the simulations as the sampling rate (i.e., the frame rate) of the experiments, simulated trajectories are downsampled by only taking every second time step before starting the analysis.  #@NEW_LINE#@#  


Acknowledgments  #@NEW_LINE#@#  
We thank Mattia Bergomi, Iain Couzin, Andres Laan, Alfonso Perez-Escudero, and Michael Orger for discussions; Isidro Dompablo (CSIC) and Ana Catarina Certal (Fundação Champalimaud) for animal care; and Paulo Carriço (Fundação Champalimaud) for technical assistance with setups.  #@NEW_LINE#@#  This work was supported by Spanish Plan Nacional Ministerio de Economia y Competitividad Grants BFU2012-33448 and BFU2013-49512-EXP (to G.G.d.P.  #@NEW_LINE#@#  ), Fundação para a Ciência e Tecnologia PTDC/NEU-SCC/0948/2014 (to G.G.d.P.  #@NEW_LINE#@#  ), and Fundação Champalimaud (to G.G.d.P.).  #@NEW_LINE#@#  The funders had no role in study design, data collection and analysis, decision to publish, or preparation of the manuscript.  #@NEW_LINE#@#  

Footnotes  #@NEW_LINE#@#  




