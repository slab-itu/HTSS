article id="http://dx.doi.org/10.1073/pnas.1509788112"  #@NEW_LINE#@#  
title  #@NEW_LINE#@#  
Searching molecular structure databases with tandem mass spectra using CSI:FingerID  #@NEW_LINE#@#  

Significance  #@NEW_LINE#@#  
Untargeted metabolomics experiments usually rely on tandem MS (MS/MS) to identify the thousands of compounds in a biological sample.  #@NEW_LINE#@#  Today, the vast majority of metabolites remain unknown.  #@NEW_LINE#@#  Recently, several computational approaches were presented for searching molecular structure databases using MS/MS data.  #@NEW_LINE#@#  Here, we present CSI:FingerID, which combines fragmentation tree computation and machine learning.  #@NEW_LINE#@#  An in-depth evaluation on two large-scale datasets shows that our method can find 150% more correct identifications than the second-best search method.  #@NEW_LINE#@#  In comparison with the two runner-up methods, CSI:FingerID reaches 5.4-fold more unique identifications.  #@NEW_LINE#@#  We also present evaluations indicating that the performance of our method will further improve when more training data become available.  #@NEW_LINE#@#  CSI:FingerID is publicly available at www.csi-fingerid.org.  #@NEW_LINE#@#  

Abstract  #@NEW_LINE#@#  
Metabolites provide a direct functional signature of cellular state.  #@NEW_LINE#@#  Untargeted metabolomics experiments usually rely on tandem MS to identify the thousands of compounds in a biological sample.  #@NEW_LINE#@#  Today, the vast majority of metabolites remain unknown.  #@NEW_LINE#@#  We present a method for searching molecular structure databases using tandem MS data of small molecules.  #@NEW_LINE#@#  Our method computes a fragmentation tree that best explains the fragmentation spectrum of an unknown molecule.  #@NEW_LINE#@#  We use the fragmentation tree to predict the molecular structure fingerprint of the unknown compound using machine learning.  #@NEW_LINE#@#  This fingerprint is then used to search a molecular structure database such as PubChem.  #@NEW_LINE#@#  Our method is shown to improve on the competing methods for computational metabolite identification by a considerable margin.  #@NEW_LINE#@#  

Results  #@NEW_LINE#@#  
Methods_Overview  #@NEW_LINE#@#  
Recently, we used fragmentation trees to boost the performance of molecular fingerprint prediction using multiple kernel learning (19).  #@NEW_LINE#@#  Here, we further combine this method with a kernel encoding chemical elements, a kernel based on recalibrated MS/MS data, five additional kernels based on fragmentation tree similarity, and two pseudokernels based on fragmentation tree alignments (31).  #@NEW_LINE#@#  We then add PubChem (CACTVS) fingerprints (881 molecular properties) and KlekotaRoth fingerprints (32) (4,860 molecular properties) to the pool of predictable fingerprints.  #@NEW_LINE#@#  This results in 1,415 molecular properties that can be learned from the data; we will refer to these molecular properties as the fingerprint of a molecular structure.  #@NEW_LINE#@#  Finally, we use maximum likelihood considerations and Platt probabilities to refine the fingerprint similarity scoring.  #@NEW_LINE#@#  
Our method can roughly be divided into three phases (Fig 1): one phase for training the method on some reference set of known compounds and two phases for identifying unknown compounds.  #@NEW_LINE#@#  In all cases, MS/MS spectra of each compound are first transformed into a fragmentation tree by the automated method described in refs.  #@NEW_LINE#@#  22 and 33, and both the MS/MS spectra and the fragmentation tree of the compound are used as input for the subsequent analysis.  #@NEW_LINE#@#  In the learning phase, we use a database of reference compounds with known molecular structure.  #@NEW_LINE#@#  The used machine learning method falls into the class of kernel methods (34), where a kernel denotes a similarity measure for either MS/MS spectra or fragmentation trees.  #@NEW_LINE#@#  We compute several such similarity measures for each pair of compounds in the reference data and also determine weights to combine all similarity measures into one (multiple kernel learning) (19).  #@NEW_LINE#@#  In addition, we compute the molecular fingerprint of each reference compound using its known structure.  #@NEW_LINE#@#  For each molecular property in the fingerprint, we then train a support vector machine (35) (SVM) that, using the kernel similarities, tries to separate compounds into those that exhibit the molecular property and those that do not.  #@NEW_LINE#@#  Platt probabilities (36) allow for a more fine-grained prediction, replacing the 0/1 predictions of classical SVM by some (posterior) probability for the presence of the molecular property.  #@NEW_LINE#@#  
The second part, where we want to find an unknown compound in a database of molecular structures, consists of two phases.  #@NEW_LINE#@#  In the prediction phase, we are given the MS/MS spectra of an unknown compound.  #@NEW_LINE#@#  We compute kernel similarities of the unknown compound against all compounds in the reference dataset, based on MS/MS spectra and fragmentation trees.  #@NEW_LINE#@#  We then use SVMs trained above to predict the (probability of the) presence or absence of each molecular property for the unknown compound.  #@NEW_LINE#@#  This results in a predicted fingerprint of the unknown compound.  #@NEW_LINE#@#  In the scoring phase, we compare the predicted fingerprint of the unknown compound against fingerprints of compounds in a molecular structure database such as PubChem.  #@NEW_LINE#@#  For each candidate molecular structure, its fingerprint is scored against the predicted fingerprint; candidate structures are sorted with respect to this score and reported back to the user.  #@NEW_LINE#@#  We stress that the unknown compound is usually not part of the training data; in our evaluation below, we make sure that this is never the case, using cross-validation.  #@NEW_LINE#@#  

Identification_Quality  #@NEW_LINE#@#  
We first evaluate each method using compounds from the combined Agilent and GNPS (Global Natural Products Social) dataset.  #@NEW_LINE#@#  Our method strongly outperforms all other available tools for searching MS/MS data in a molecular structure database (Fig 2).  #@NEW_LINE#@#  Compared with the runner-up, FingerID, the number of correct identifications is 2.5-fold higher (34.4% vs. 13.8%) when searching PubChem.  #@NEW_LINE#@#  CFM-ID reaches third place with 13.2% identification.  #@NEW_LINE#@#  We achieve 63.5% correct identifications in the top five output; next come FingerID with 36.1% and CFM-ID with 36.0%.  #@NEW_LINE#@#  Our method reaches an identification rate of 50% at the fractional rank 2.23, far ahead of CFM-ID (fractional rank 13.5) and MAGMa (13.7).  #@NEW_LINE#@#  It reaches an identification rate of 66.7% for fractional rank 6.38, again far ahead of CFM-ID (50.0) and MAGMa (51.0).  #@NEW_LINE#@#  See Fig S1 for identification rates for all ranks.  #@NEW_LINE#@#  Searching biocompounds in the biodatabase, we achieve 68.5% correct identifications, compared with 59.5% and 57.4% for the two next-best methods, MAGMa and CFM-ID, respectively (Fig 2).  #@NEW_LINE#@#  For 92.3% of the query compounds, the correct answer is contained in the top five for our method, compared with runners-up FingerID (86.1%) and CFM-ID (84.2%).  #@NEW_LINE#@#  Searching the complete combined dataset in the biodatabase, this corresponds to 55.2% correct identifications for our method (Fig S1).  #@NEW_LINE#@#  
The Agilent dataset is proprietary and, hence, cannot be used to evaluate future methods.  #@NEW_LINE#@#  We therefore repeated our analysis, this time searching with query instances from the two datasets individually (Figs.  #@NEW_LINE#@#  S2S4).  #@NEW_LINE#@#  For the Agilent dataset, we reach 39.3% correct identifications, compared with 19.6% for FingerID and 15.3% for MAGMa.  #@NEW_LINE#@#  For the GNPS dataset, all methods suffer a slight loss in identification quality, but trends are highly similar to those reported above.  #@NEW_LINE#@#  For example, identification rates when searching PubChem decrease to 31.8% for our method, 12.1% for CFM-ID, and 11.8% for MAGMa, making the identification rate for our method 2.6-fold higher than for the runner-up.  #@NEW_LINE#@#  Our method achieves an identification rate of 50% for fractional rank 2.59, with the next-best being MAGMa (fractional rank 15.5) and CFM-ID (17.5).  #@NEW_LINE#@#  Our method reaches 66.7% identifications for fractional rank 7.62, compared with MetFrag (58.5) and MAGMa (63.1).  #@NEW_LINE#@#  When searching biocompounds in the biodatabase we reach 64.3% correct identifications, compared with 56.5% for MAGMa; the correct answer is in the top five for 90.2%, with runner-up FingerID (81.1%).  #@NEW_LINE#@#  
We also evaluated against the baseline method of randomly ordering candidates with the correct molecular formula.  #@NEW_LINE#@#  Random ordering performs well for searching biocompounds in the biodatabase, with 30.7% correct identifications and 64.3% in the top five for the combined dataset.  #@NEW_LINE#@#  This demonstrates the power of knowing the correct molecular formula for structure elucidation when searching in a restricted structure database.  #@NEW_LINE#@#  
Next, we compare methods for each individual query instance.  #@NEW_LINE#@#  See Fig 3 for the overlap in identifications of our method, CFM-ID, and MAGMa; our method reaches 5.4-fold more unique identifications (correctly identified compounds not identified by one of the other two methods) than CFM-ID and MAGMa for the combined dataset.  #@NEW_LINE#@#  A method outperforms another for some query instance if it places the correct structure on a better rank.  #@NEW_LINE#@#  On the combined dataset, our method outperforms CFM-ID for 65.6% of the instances, whereas CFM-ID outperforms our method for 23.8% of them.  #@NEW_LINE#@#  Our method outperforms MAGMa for 66.1% and is outperformed for 24.1% of the instances.  #@NEW_LINE#@#  For MIDAS, MetFrag, and FingerID, our method outperforms each of these methods for more than 68.9% of the instances and is outperformed for at most 20.6%.  #@NEW_LINE#@#  In all cases, the significance (sign test P value) is below 10127.  #@NEW_LINE#@#  See Table S1 for an all-against-all comparison of methods.  #@NEW_LINE#@#  In Fig S5 we show nine exemplar compounds that were correctly identified by our method, but not by any other method in this evaluation.  #@NEW_LINE#@#  
We evaluated several new scoring functions for CSI:FingerID and found three that perform better than the function proposed in refs.  #@NEW_LINE#@#  18 and 19 (Fig 4).  #@NEW_LINE#@#  Among these, modified Platt achieves the best identification rates and was therefore selected as the default scoring function for CSI:FingerID.  #@NEW_LINE#@#  Compared with the original scoring function based on predictor accuracy (18, 19), we reach 17.0% (4.99 percentage points) more correct identifications.  #@NEW_LINE#@#  
Because our method employs machine learning to predict molecular properties of the query compound, additional data can improve the performance of the predictors.  #@NEW_LINE#@#  To estimate the scale of this effect, we repeated the learning step for all predictors but this time presented the method with only a fraction of the data for learning.  #@NEW_LINE#@#  Average accuracy and F1 score of the predictors, as well as their performance for searching PubChem, are shown in Fig 5.  #@NEW_LINE#@#  Varying the amount of training data, a monotonic increase is observed in accuracy and F1 score of the molecular property predictions.  #@NEW_LINE#@#  This growth does not saturate with the amount of data available in our experiments.  #@NEW_LINE#@#  For the resulting identification rates, we observe an almost linear increase when varying relative training data size between 40% and 90%, whereby 400 additional compounds in the training data result in an increase of roughly one percentage point in the identification rate.  #@NEW_LINE#@#  
We found that the performance of our method is influenced by more than just the amount of available training data: To a great extent, our method depends on useful molecular properties it can predict.  #@NEW_LINE#@#  Whether or not a particular molecular property is useful is determined by a multitude of parameters, such as discriminating power in PubChem (a molecular property that is inherited by the vast majority of compounds in PubChem is of little use in filtering out wrong candidates) or availability of training data for both the presence and absence of the property.  #@NEW_LINE#@#  To estimate how additional molecular properties can further improve the power of our method in the future, we artificially restricted the properties available for prediction and evaluated the method for the reduced sets of molecular properties (Fig 5).  #@NEW_LINE#@#  We find that increasing the available molecular properties causes a monotonic, logarithm-like increase in the identification rate.  #@NEW_LINE#@#  
Finally, we evaluated all methods on an independent dataset from MassBank (Fig S6).  #@NEW_LINE#@#  For this dataset, our method reaches 39.5% correct identifications searching PubChem, compared with 19.0 and 5.77% for the runners-up FingerID and MIDAS.  #@NEW_LINE#@#  For 267 compounds, we find corresponding structures in the training data; our method correctly identifies more than two-thirds (68.8%) of these compounds.  #@NEW_LINE#@#  We observe a major drop in identification accuracy for all methods but ours and FingerID on the complete MassBank dataset, and a similar behavior for all methods on the novel compounds: Searching for the 358 novel compounds in PubChem, our method reaches 17.7% correct identifications, followed by FingerID (8.34%) and MetFrag (5.70%).  #@NEW_LINE#@#  


Discussion  #@NEW_LINE#@#  
When searching a molecular structure database using MS/MS data, CSI:FingerID achieves significantly better results than existing state-of-the-art methods.  #@NEW_LINE#@#  We observe a 2.5-fold increase of correct identifications compared with the runner-up method when searching PubChem and a 6.0- to 7.8-fold fractional rank decrease when trying to recover the correct solution for 50% or 66.7% of the instances, respectively.  #@NEW_LINE#@#  
It must be understood that finding the correct molecular structure in a molecular structure database as enormous as PubChem, being four orders of magnitude larger than existing MS/MS libraries, is highly challenging and will never be possible without a certain fraction of bogus identifications.  #@NEW_LINE#@#  We have deliberately left it to the expertise of the user to select the best molecular structure from the suggested candidates.  #@NEW_LINE#@#  Additional information such as citation frequencies or number of PubChem substances (16) can further assist the user in identifying the most promising candidates.  #@NEW_LINE#@#  We did not use such information in our evaluation to avoid overestimating the methods power: Spectral libraries mostly contain well-described compounds where pure reference standards are available, and such compounds also receive many citations and have many PubChem substance entries.  #@NEW_LINE#@#  
For the independent dataset, our method shows good identification performance, but for the 358 novel compounds where no corresponding structure is present in the training data, we observe a severe drop in identification rates for all methods.  #@NEW_LINE#@#  We manually inspected the MS/MS data but detected no peculiarities.  #@NEW_LINE#@#  Currently, we cannot convincingly explain the drop of identification rates, despite testing numerous possible explanations such as number of candidates of an instance, or structural similarity of candidates to the true solution.  #@NEW_LINE#@#  The only peculiarity we found is distinctively reduced identification rates for flavonoid compounds in the Washington subdataset.  #@NEW_LINE#@#  
Running times of FingerID are fastest, whereas our approach, MetFrag, and MAGMa are roughly on par; in contrast, those of CFM-ID and MIDAS are two orders of magnitude higher (Table S2).  #@NEW_LINE#@#  This is not a problem for CFM-ID because spectrum simulation is done only once for each molecular structure during preprocessing, whereas comparison of spectra is very fast, but it can severely hinder the use of MIDAS in practice.  #@NEW_LINE#@#  
We found that choosing the correct cross-validation setup has a huge impact on our evaluation: If we choose cross-validation batches solely based on the individual measurements of the compounds, ignoring that two batches may contain the same structure, then our identification rate for searching in PubChem increases to a staggering 58.5% (Fig S7).  #@NEW_LINE#@#  Manual inspection confirmed that different compounds with identical structure (constitution) often show highly similar MS/MS data.  #@NEW_LINE#@#  
Molecular structure databases keep growing at a pace beyond synthesizing capacities.  #@NEW_LINE#@#  To this end, CSI:FingerID and other methods for searching in molecular structure databases represent a paradigm shift in the metabolomics field.  #@NEW_LINE#@#  Clearly, CSI:FingerID can and should be combined with other search engines.  #@NEW_LINE#@#  In particular, it should be accompanied by a search in spectral libraries (37) such as GNPS itself, and alternative methods for structural elucidation (2426).  #@NEW_LINE#@#  In cases where the class of the query compound is known, more specialized approaches may be available, such as LipidBlast for lipids (5), or database searching and de novo sequencing for small peptides (38).  #@NEW_LINE#@#  
Compared with the original FingerID method of 2012 (18), identification rates of our method are 2.5-fold higher.  #@NEW_LINE#@#  With this and our experiments on limiting training data and molecular properties (Fig 5), we predict that CSI:FingerID will reach even better identification rates in the near future.  #@NEW_LINE#@#  Our method can open up new paths beyond searching in structure databases such as PubChem: An obvious next step will be to search in structure databases containing hypothetical compounds (39, 40), potentially allowing us to overcome the limits of molecular structure databases.  #@NEW_LINE#@#  

Materials_and_Methods  #@NEW_LINE#@#  
For training the method, we use a set of 4,138 small compounds from the public GNPS Public Spectral Libraries (https://gnps.ucsd.edu/ProteoSAFe/libraries.jsp) and 2,120 compounds from the MassHunter Forensics/Toxicology PCDL library (Agilent Technologies, Inc.).  #@NEW_LINE#@#  Evaluation is carried out by 10-fold cross-validation, such that no two batches may contain the same structure.  #@NEW_LINE#@#  We evaluate all methods using 3,868 compounds from GNPS and 2,055 compounds from the Agilent dataset.  #@NEW_LINE#@#  We present results for the combined Agilent and GNPS dataset, and for the two datasets individually.  #@NEW_LINE#@#  As an independent dataset, we use MS/MS data of 625 compounds from MassBank (41).  #@NEW_LINE#@#  We search a version of PubChem (downloaded on September 15, 2014) containing 52,926,405 compounds and 40,805,940 structures, and a filtered version of PubChem (biodatabase; see Table S3 and Fig S8) containing 268,633 structures of biological interest (about 300,000 compounds); 1,010 compounds from the GNPS dataset and 140 compounds from the Agilent dataset cannot be found in the biodatabase.  #@NEW_LINE#@#  We refer to the remaining 2,858+1,915=4,773 compounds as biocompounds.  #@NEW_LINE#@#  Searching the biodatabase was performed using both the complete datasets and the subsets of biocompounds.  #@NEW_LINE#@#  
We assume that we are able to identify up front the molecular formula of the unknown compound.  #@NEW_LINE#@#  For this, several approaches have been developed that analyze the MS/MS and isotope pattern data of the compound (42); for example, CFM-ID (10) identified the correct molecular formula for more than 90% of 1,491 nonpeptide metabolites using MS/MS data, and SIRIUS (43) was able to find the correct molecular for 10 out of 12 instances of the CASMI (Critical Assessment of Small Molecule Identification) 2013 contest.  #@NEW_LINE#@#  For all evaluated tools, molecular structure candidates are extracted from PubChem using the known molecular formula of the query.  #@NEW_LINE#@#  
We evaluate our method against the original FingerID method (18), CFM-ID (10), MAGMa (16), MIDAS (15), and MetFrag (14).  #@NEW_LINE#@#  FingerID was retrained on the combined training data, to enable a sensible evaluation against its successor presented here.  #@NEW_LINE#@#  CFM-ID also uses machine learning techniques but was not retrained on the new dataset due to computational limitations, resulting in an overlap (972 structures) between training and evaluation set.  #@NEW_LINE#@#  Identification rates reported here are slightly better than to those reported in ref.  #@NEW_LINE#@#  10 using cross-validation.  #@NEW_LINE#@#  Average running times per query range from 2 s (FingerID) to more than 1 d (MIDAS) (Table S2).  #@NEW_LINE#@#  To avoid proliferating running times, MIDAS was stopped after 24 h of computation (more than 10 times the estimated average running time of any other program) for any instance.  #@NEW_LINE#@#  If the output of a tool did not contain the correct candidate, then all candidates not in the output were added to the end of the output list with identical, minimal score.  #@NEW_LINE#@#  Similarly, if a tool was unable to process an instance, then all candidates received identical score.  #@NEW_LINE#@#  
Lists are sorted with respect to scores provided by each tool.  #@NEW_LINE#@#  Ties in the score of a method are broken randomly, comparable to adding weak random noise to the scores.  #@NEW_LINE#@#  A given query instance is correctly identified if the correct structure is at the top position of the output list; it is in the top k if its rank in the output list is at most k.  #@NEW_LINE#@#  
See SI Materials and Methods for details.  #@NEW_LINE#@#  

SI_Materials_and_Methods  #@NEW_LINE#@#  
Datasets_and_Structure_Databases  #@NEW_LINE#@#  
For training our method, the GNPS dataset of MS/MS spectra was downloaded from https://gnps.ucsd.edu/ProteoSAFe/libraries.jsp in December 2014 (FDA Library Pt 1 and Pt 2, PhytoChemical Library, NIH Clinical Collections 1 and 2, NIH Natural Products Library, Pharmacologically Active Compounds in the NIH Small Molecule Repository, and Faulkner Legacy Library provided by Sirenas MD).  #@NEW_LINE#@#  We analyzed compounds with mass below 1,010 Da where mass spectra were recorded in positive mode and mass accuracy of the parent peak was 10 ppm or better.  #@NEW_LINE#@#  We discarded compounds for which the structure could not be resolved and compounds containing deuterium, as well as spectra containing fewer than five peaks with relative intensity above 2%.  #@NEW_LINE#@#  After filtering, 4,138 compounds remain in the GNPS dataset.  #@NEW_LINE#@#  For each compound, GNPS provides a single collision-induced dissociation (CID) fragmentation spectrum at varying collision energies, recorded on an Agilent Q-TOF with electrospray ionization (few compounds were measured on a different experimental platform).  #@NEW_LINE#@#  The Agilent dataset is available under the name MassHunter Forensics/Toxicology PCDL (version B.04.01) from Agilent Technologies.  #@NEW_LINE#@#  The commercial library has been cleaned by idealizing peak masses and removing noise peaks, but Agilent provided us with an uncorrected version of this dataset, which is used here.  #@NEW_LINE#@#  For this dataset, 2,120 compounds fulfill the above criteria.  #@NEW_LINE#@#  Fragmentation spectra at collision energies 10, 20, and 40 eV were recorded on an Agilent 6500 series instrument with electrospray ionization.  #@NEW_LINE#@#  For this dataset, only relative intensities were recorded, so preprocessing was applied to merge spectra recorded at different collision energies (19, 22).  #@NEW_LINE#@#  
PubChem structures were downloaded from pubchem.ncbi.nlm.nih.gov/ in September 2014.  #@NEW_LINE#@#  For the biodatabase of compounds of biological interest, we start with all compounds in PubChem that have an appropriate Medical Subject Heading (MeSH; see Table S3), or at least one citation in PubMed (6) (www.ncbi.nlm.nih.gov/pubmed).  #@NEW_LINE#@#  We then include all compounds that are present in KNApSAcK (44) (kanaya.naist.jp/KNApSAcK/), the Human Metabolome DataBase (45) (HMDB, www.hmdb.ca/), or Chemical Entities of Biological Interest (46) (ChEBI, www.ebi.ac.uk/chebi/), all downloaded in July 2014.  #@NEW_LINE#@#  See Table S3 for details and Fig S8 for the overlap of the filtered PubChem, KNApSAcK, and HMDB, which constitute the three largest sources of biomolecules; 1,018 compounds from the GNPS dataset and 143 compounds from the Agilent dataset are not included in any biomolecular structure database.  #@NEW_LINE#@#  We use IUPAC International Chemical Identifier (InChI) layer 1 to represent structures.  #@NEW_LINE#@#  

Molecular_Fingerprints  #@NEW_LINE#@#  
Molecular fingerprints (or fingerprints for short) are a method to encode the structure of a molecule.  #@NEW_LINE#@#  The most common type of a molecular fingerprint is a bit vector where each bit describes the presence or absence of a particular, fixed molecular property, such as the existence of a certain substructure in the molecule.  #@NEW_LINE#@#  As an example, bit 416 of the PubChem fingerprint (discussed below) encodes for the presence of two carbon atoms connected by a double bond.  #@NEW_LINE#@#  Given the molecular structure of a compound, we can deterministically transfer this into a molecular fingerprint.  #@NEW_LINE#@#  Fingerprints have been extensively used in the field of virtual screening (47); in particular, fingerprints can be used to estimate the structural similarity of two molecular structures using the Tanimoto coefficient (Jaccard index).  #@NEW_LINE#@#  
Different fingerprints have been defined and used in the literature over the last decades, including commercial fingerprints such as the Daylight fingerprints (Daylight Chemical Information Systems, Inc.).  #@NEW_LINE#@#  We use the following fingerprints, because these can be computed using freely available software:  #@NEW_LINE#@#  
All molecular properties are computed using the Chemistry Development Kit (CDK) 1.5.8 (49, 50) (sourceforge.net/projects/cdk/).  #@NEW_LINE#@#  
In total, we use 6,269 molecular properties; of these, 3,166 are constant within the training set structures.  #@NEW_LINE#@#  That is, either all structures show a particular molecular property or none do.  #@NEW_LINE#@#  From the remaining, 338 molecular properties are redundant: For each such property, there exists another property that is present or absent for exactly the same compounds in the training dataset.  #@NEW_LINE#@#  We remove redundant molecular properties because they do not provide additional information.  #@NEW_LINE#@#  We are left with 2,765 molecular properties that can be learned from the training data.  #@NEW_LINE#@#  

Fragmentation_Tree_Calculation  #@NEW_LINE#@#  
We transform the MS/MS data of each compound into a fragmentation tree.  #@NEW_LINE#@#  Fragmentation trees were formally introduced by Böcker and Rasche in 2008 (20).  #@NEW_LINE#@#  The term fragmentation tree has been used much earlier in the MS literature (51); the important difference is that fragmentation trees in refs.  #@NEW_LINE#@#  20 and 21 are computed directly from the data by an automated method, without knowing the molecular structure of the compound, and without the need for a database of spectra or molecular structures.  #@NEW_LINE#@#  We stress that here fragmentation trees are computed using tandem MS (MS/MS) data, not multiple MS data.  #@NEW_LINE#@#  
Formally, a fragmentation tree (V,E) consists of a set of nodes V that are molecular formulas over some alphabet of elements and directed edges (arcs) E connecting these nodes.  #@NEW_LINE#@#  All edges are directed away from the root of the tree, and every node can be reached from the root via a unique series of edges.  #@NEW_LINE#@#  In small compound fragmentation, many fragments result from fragmentation cascades, that is, series of subsequent fragmentation events; these cascades are modeled by the tree structure of the fragmentation tree.  #@NEW_LINE#@#  Nodes of the fragmentation tree are molecular formulas of the unfragmented ion and its fragments; edges correspond to losses.  #@NEW_LINE#@#  For any fragmentation tree, each molecular formula can appear at most once as a node of the tree.  #@NEW_LINE#@#  For an edge (u,v)E, uv is the molecular formula of the corresponding loss; we demand that uv holds, that is, v is a subformula of u.  #@NEW_LINE#@#  
Given the molecular formula of the query compound, the optimal fragmentation tree was determined using integer linear programming (33) with the maximum a posteriori scoring scheme described in ref.  #@NEW_LINE#@#  22.  #@NEW_LINE#@#  We set the maximal allowed mass deviation to 10 ppm (relative) and 0.002 Da (absolute).  #@NEW_LINE#@#  The tree size parameter is dynamically changed per tree such that at least 90% of the intensity is explained: We start with tree size prior Ptreebonus=e0.5.  #@NEW_LINE#@#  We then sum up the intensity of peaks that are explained by the resulting tree and divide this by the sum of intensity of peaks that have a decomposition as a subformula of the parent molecular formula.  #@NEW_LINE#@#  If the resulting ratio is smaller than 0.9, we multiply the prior by e0.5 and restart computations.  #@NEW_LINE#@#  

Fingerprint_Prediction  #@NEW_LINE#@#  
Supervised learning is the machine learning task of inferring some predictor function from labeled training data.  #@NEW_LINE#@#  The learning algorithm analyzes the training data and produces a predictor function, which is then used for mapping new examples that are not part of the training data.  #@NEW_LINE#@#  To this end, the learning algorithm has to generalize from the training data to novel data with unknown labels in a reasonable way.  #@NEW_LINE#@#  To assess the power of the predictor function or to tune some external parameters, one can use cross-validation where the predictor function is trained on part of the data, then evaluated on the remainder.  #@NEW_LINE#@#  This shows whether the predictor function is able to generalize from the training data to unknown data.  #@NEW_LINE#@#  
Our goal is to predict a set of n molecular properties based on the available training data (xi,Ti,yi) for i=1,,m, where xi is an MS/MS spectrum, Ti is the corresponding fragmentation tree, and yi{+1,1}n is a vector of n molecular properties for this molecular structure (the desired output).  #@NEW_LINE#@#  Here, +1 denotes the presence and 1 the absence of a given property.  #@NEW_LINE#@#  We will learn each molecular property of the fingerprint independently.  #@NEW_LINE#@#  For classification, we use SVMs, which we will briefly review first.  #@NEW_LINE#@#  Next, the concept of kernels is explained, followed by the mass spectra kernels and fragmentation tree kernels used in this paper.  #@NEW_LINE#@#  Finally, the multiple kernel learning approach to combine different kernels is described.  #@NEW_LINE#@#  

Platt_Probabilities  #@NEW_LINE#@#  
Platt scaling allows us to transform the output of a predictor function into a probability distribution over classes: We ask for a classification that not only gives an answer, but also a degree of certainty about the answer.  #@NEW_LINE#@#  Formally, we want to estimate the posterior probability Pr(y=1|x) that our unknown molecule has a particular property, or not.  #@NEW_LINE#@#  
Platt (36) proposed using a sigmoid function as an approximation of posterior probabilities:Pr(y=1|x)PA,B(f)11+exp(Af+B),[S19]where f=f(x) is the decision value and sign(f(x)) is the predicted label.  #@NEW_LINE#@#  Given training examples xiX and labels yi{+1,1}, i=1,,m, we search for parameters A*,B* that maximize the following likelihood (36):minA,BF(z)=i=1m(tilogpi+(1ti)log(1pi)),wherepiPA,B(fi)andti{N++1N++2ifyi=+11N+2ifyi=1fori=1,,m.  #@NEW_LINE#@#  [S20]Here, N+ is the number of examples with positive labels and N the number of examples with negative labels.  #@NEW_LINE#@#  To solve this optimization problem, Lin et al.  #@NEW_LINE#@#  (56) proposed using a Newton method with backtracking line search.  #@NEW_LINE#@#  We refer readers to the original papers for more details.  #@NEW_LINE#@#  We use LIBSVM to estimate Platt probabilities.  #@NEW_LINE#@#  

Parameter_Tuning_and_Cross-Validation  #@NEW_LINE#@#  
Cross-validation is used to estimate how accurately a predictor function will perform on the unseen data and can also be used to estimate some external parameters specified by the user.  #@NEW_LINE#@#  One round of cross-validation involves partitioning a dataset into two complementary subsets, performing the analysis on one subset (the training set), and validating the analysis on the other subset (the testing set).  #@NEW_LINE#@#  Multiple rounds of cross-validation are performed using different partitions, and results are averaged over the rounds.  #@NEW_LINE#@#  
An n-fold cross-validation corresponds to partitioning the dataset into n subsets of (almost) identical size.  #@NEW_LINE#@#  Then, n rounds of cross-validation are performed, where in each round n1 subsets are concatenated to form the training set, and the remaining subset is used as the testing set.  #@NEW_LINE#@#  For our cross-validation, we ensured that all compounds in the dataset with identical structure are contained in the same subset (batch) of the cross-validation.  #@NEW_LINE#@#  
The mass and intensity variance parameters of the PPK kernels were selected by a fivefold cross-validation on an independent dataset.  #@NEW_LINE#@#  The best parameter learned for mass variance is 105 and for intensity variance is 105.  #@NEW_LINE#@#  These parameters are kept constant throughout subsequent learning steps.  #@NEW_LINE#@#  These parameters are used for the PPK and PPKr kernel of CSI:FingerID, and the FingerID method.  #@NEW_LINE#@#  
Individual SVMs were trained by 10-fold cross-validation on the combined dataset with 6,258 compounds.  #@NEW_LINE#@#  In our experiments, the parameter C in SVM is learned for each molecular property independently, using 10-fold cross-validation on the training data.  #@NEW_LINE#@#  

Performance_Measures  #@NEW_LINE#@#  
For a binary prediction, let TP, FP, TN, and FN denote the number of true positives, false positives, true negatives, and false negatives, respectively.  #@NEW_LINE#@#  The precision (positive predictive value) is TP/TP+FP, the sensitivity or recall is TP/TP+FN, and the specificity is TN/FP+TN.  #@NEW_LINE#@#  The F1 score is the harmonic mean of precision and recall, F1=2(precisionrecall/precision+recall).  #@NEW_LINE#@#  The accuracy equals TP+TN/TP+TN+FP+FN.  #@NEW_LINE#@#  
To avoid numerical instabilities, we add 0.5 pseudocounts to TP, FP, TN, and FN before estimating the above measures for any predictor of a molecular property.  #@NEW_LINE#@#  Similarly, we apply Laplace smoothing (additive smoothing) to Platt probabilities and replace probability x by x+/1+2 for some small ; here, we choose =1/n where n=5923 is the size of the evaluation dataset.  #@NEW_LINE#@#  

Fingerprint_Scores  #@NEW_LINE#@#  
A molecular property encodes the presence or absence of a particular substructure in the molecule structure as a binary value.  #@NEW_LINE#@#  To make our method robust and avoid overfitting to the training data, we discard molecular properties where the trained predictor reaches F1 score below 0.5 in cross-validation.  #@NEW_LINE#@#  We find that n1,415 of the total 2,765 molecular properties pass this criterion.  #@NEW_LINE#@#  Let 1,,n be the molecular property indices.  #@NEW_LINE#@#  A fingerprint is a subset F{1,,n}.  #@NEW_LINE#@#  Each molecular structure candidate has an associated fingerprint.  #@NEW_LINE#@#  Because our fingerprint prediction is imperfect, we compare fingerprints F,F via a scoring function (F,F).  #@NEW_LINE#@#  For finding the best-fitting candidate, we compare the predicted fingerprint F to all candidate fingerprints F, and sort candidates according to (F,F).  #@NEW_LINE#@#  A straightforward scoring function between the predicted and the database fingerprint is the Tanimoto score (Jaccard index) (F,F)=|FF|/|FF|.  #@NEW_LINE#@#  
For all other scores, the predicted fingerprint F and the candidate fingerprint F are compared via a weighted sum,(F,F)iFFai+iF\Fbi+iF\Fci+iFFdi[S21]with coefficients ai,bi,ci,di for i=1,,n.  #@NEW_LINE#@#  The accuracy score suggested in refs.  #@NEW_LINE#@#  18 and 19 sets ai=di=logacci and bi=ci=log(1acci), where acci is the accuracy of the predictor for molecular property i.  #@NEW_LINE#@#  The unit score sets ai=di=1 and bi=ci=0, simply counting the number of common molecular properties.  #@NEW_LINE#@#  The maximum likelihood score sets ai=logsensi, bi=log(1speci), ci=log(1sensi) and di=logspeci, where sensi and speci are the sensitivity and specificity of the predictor for molecular property i, respectively.  #@NEW_LINE#@#  This score can be interpreted as a log-likelihood estimate if we assume all predictors to be independent random variables.  #@NEW_LINE#@#  The Platt score sets ai=ci=logplatti and bi=di=log(1platti) where platti is the Platt approximation of the posterior probability for molecular property i.  #@NEW_LINE#@#  This score is a posterior probability estimate of the complete fingerprint.  #@NEW_LINE#@#  The modified Platt score combines maximum likelihood and Platt score considerations, and setsai=34logplatti+14log(1sensi)bi=34log(1platti)ci=34logplattidi=34log(1platti)+14log(1speci).  #@NEW_LINE#@#  [S22]  #@NEW_LINE#@#  

Evaluation  #@NEW_LINE#@#  
For evaluation, we discarded some compounds from the two datasets.  #@NEW_LINE#@#  Namely, we discarded compounds containing metal complexes and other structures not connected by covalent bonds, nonprotonated ions, and compounds that carry other charges.  #@NEW_LINE#@#  We discarded a total of 270 compounds from the GNPS dataset and 65 compounds from the Agilent dataset, including 27 compounds from Agilent that are absent from PubChem.  #@NEW_LINE#@#  This leaves us with 3,868 (GNPS) and 2,055 (Agilent) compounds, respectively.  #@NEW_LINE#@#  The reason for excluding these compounds is that some or all of the tested tools cannot process molecules that do not obey the above criteria: For example, the evaluated version of CFM-ID does not allow processing intrinsically charged molecules.  #@NEW_LINE#@#  
As an independent dataset, we downloaded MS/MS data measured in positive ion mode from MassBank (www.massbank.jp/).  #@NEW_LINE#@#  These measured compounds are provided by the Washington State University (268), the University of Connecticut (102), the Oswaldo Cruz Foundation (95), the Leibniz Institute for Plant Biochemistry (39), and the RIKEN Plant Science Center (403).  #@NEW_LINE#@#  All these compounds were measured on Q-TOF instruments.  #@NEW_LINE#@#  We discarded compounds exhibiting fewer than five peaks with relative intensity above 2% in the MS/MS data (222 compounds) and 52 compounds carrying a charge or containing nonprotonated ions as well as 8 compounds that are not contained in PubChem, leaving us with 625 compounds in the dataset.  #@NEW_LINE#@#  For 267 compounds the corresponding structure is contained in our training set, whereas 358 structures are novel.  #@NEW_LINE#@#  
Candidates from PubChem and the biodatabase were filtered by the above-mentioned criteria, that is, we discarded unconnected structures and compounds that carry charges.  #@NEW_LINE#@#  
FingerID (18) was used as described in the publication and predicts 528 molecular properties.  #@NEW_LINE#@#  Competitive Fragmentation Modeling ID (CFM-ID) (10) was downloaded from sourceforge.net/projects/cfm-id/ (version 1.5).  #@NEW_LINE#@#  As suggested in (10) we used the Combined Energy model (CE-CFM).  #@NEW_LINE#@#  From the 10 cross-validation models provided on the CFM website, we selected the first one.  #@NEW_LINE#@#  The GNPS dataset was processed using the medium energy model.  #@NEW_LINE#@#  We used the mass accuracy (maximum of 10 ppm and 0.01 Da) and probability threshold (0.001) suggested in ref.  #@NEW_LINE#@#  10.  #@NEW_LINE#@#  MetFrag (14) was downloaded from c-ruttkies.github.io/MetFrag/projects/commandline/ on June 18, 2014 (MetFrag does not provide version numbers).  #@NEW_LINE#@#  We used a 10-ppm relative mass accuracy, a 0.005-Da absolute mass accuracy, and the Java virtual machine option Djava.util.Arrays.useLegacyMergeSort = true.  #@NEW_LINE#@#  In contrast to other approaches, MetFrag uses the sum (instead of the maximum) of relative and absolute mass accuracy.  #@NEW_LINE#@#  MIDAS (15) was downloaded from midas.omicsbio.org (version 1.1).  #@NEW_LINE#@#  MIDAS does not allow us to choose a relative mass accuracy; we chose an absolute mass accuracy of 0.01 Da.  #@NEW_LINE#@#  We modified MIDAS to output all candidates, instead of the top five only.  #@NEW_LINE#@#  In view of exceedingly long running times, we stopped MIDAS for those instances where computation was not completed after 24 h; the resulting instances were counted as random.  #@NEW_LINE#@#  MAGMa (16) (version 1.0) was provided as a standalone program by Lars Ridder, Wageningen University, Wageningen, The Netherlands, and was run with options -f -b 4 -c 0 -d 0 and mass accuracies of 0.001 Da and 10 ppm.  #@NEW_LINE#@#  
In our evaluation, we performed a certain amount of parameter optimization for all methods but found that the above choices resulted in maximum identification rates for the combined dataset.  #@NEW_LINE#@#  We retrained the original FingerID on the same training data as the method proposed here, using cross-validation; this is done to allow a sensible evaluation of the impact of the methodological advances.  #@NEW_LINE#@#  For CFM-ID, we also evaluated the low-energy and high-energy model for the GNPS dataset as well as an absolute mass accuracy of 0.002 Da and an intensity baseline of 0.02%.  #@NEW_LINE#@#  For MAGMa and MetFrag, we merge spectra at different fragmentation energies by choosing mass and intensity of the largest peak within the given mass accuracy.  #@NEW_LINE#@#  For MetFrag, this resulted in significantly better identification rates than the method proposed in the original MetFrag publication (14).  #@NEW_LINE#@#  For MetFrag, we also tested absolute mass accuracies of 0.001, 0.002, and 0.01 Da.  #@NEW_LINE#@#  For MAGMa, we also tested absolute mass accuracies of 0.002, 0.005, and 0.01 Da, and option -b 3.  #@NEW_LINE#@#  
CFM-ID, MAGMa, MIDAS, and MetFrag cannot process all instances, sometimes crashing and sometimes omitting the correct answer from the output list.  #@NEW_LINE#@#  Some problems are seemingly caused by atoms that have uncommon valence states, such as chlorine with valence five in 5-chlorylsulfanyl-1-methylindazole (PubChem CID 57613613).  #@NEW_LINE#@#  Using SMILES from PubChem for CFM-ID and SDF files from PubChem for MAGMa resulted in fewer crashes and was used here.  #@NEW_LINE#@#  The following numbers are for the combined Agilent and GNPS dataset with 5,923 instances: CFM-ID crashed for 3,429 candidates (less than 0.1% of the candidates) and did not return the correct structure in its output for 19 instances (0.3%).  #@NEW_LINE#@#  MAGMa crashed for 20 instances (0.3%) and did not return the correct answer in its output for 357 instances (6.0%).  #@NEW_LINE#@#  For 2,148 instances (36.3%), MIDAS crashed or ran into the time-out of 24 h; for 21 instances (0.4%), it did not return the correct answer in its output list.  #@NEW_LINE#@#  Finally, MetFrag did not return the correct answer in its output list for 45 instances (0.8%).  #@NEW_LINE#@#  Without crashes, identification rates of these methods would be slightly increased.  #@NEW_LINE#@#  For example, assuming MAGMa shows the same performance for the 377 instances as for the successfully processed 5,546, identification rate for the combined dataset would increase by 0.9 percentage points to 13.9%, making MAGMa runner-up after CSI:FingerID but before FingerID (13.8%).  #@NEW_LINE#@#  
Assume a method assigns the correct structure the same score x as other candidates in the ranked output list, so that all candidate structures from rank i to rank j have identical score x, with i minimal and j maximal.  #@NEW_LINE#@#  Then, we increase the number of correct identifications for rank k by 1/(ji+1), for each k=i,,j.  #@NEW_LINE#@#  This corresponds to uniformly choosing some order among the candidates with identical score.  #@NEW_LINE#@#  If a method reaches ykless_thanx correct identifications in the top k, and yk+1x correct identifications in the top k+1, we say that the method reaches x correct identifications for fractional rank k+(xyk)/(yk+1yk).  #@NEW_LINE#@#  
For the all-against-all comparison of methods, we process tied ranks as follows: If method A returns the correct answer on ranks 58 (all candidates on these ranks have identical score) and method B returns it on ranks 79, we iterate over all 12 possibilities and count this as (3+3+2+1)/12=9/12 wins for method A, 2/12 ties, and 1/12 wins for method B.  #@NEW_LINE#@#  For computing sign tests, we multiply percentages from Table S1 by N and round conservatively to the nearest integer (rounding down for larger class, rounding up for smaller class).  #@NEW_LINE#@#  We use approximation by the normal distribution to compute P values.  #@NEW_LINE#@#  


Acknowledgments  #@NEW_LINE#@#  
We thank Agilent Technologies, Inc. for providing uncorrected peak lists of their spectral library and Lars Ridder (Wageningen University) for the MAGMa software.  #@NEW_LINE#@#  We are particularly grateful to Pieter Dorrestein and Nuno Bandeira (University of California) and the GNPS (Global Natural Products Social) community for making their data publicly accessible.  #@NEW_LINE#@#  This work was funded in part by Deutsche Forschungsgemeinschaft Grant BO 1910/16 (to K.D.  #@NEW_LINE#@#  and M.M.)  #@NEW_LINE#@#  and Academy of Finland Grant 268874/MIDAS (to H.S.  #@NEW_LINE#@#  and J.R.).  #@NEW_LINE#@#  

Footnotes  #@NEW_LINE#@#  



