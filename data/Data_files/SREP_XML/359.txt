article id="http://dx.doi.org/10.1038/srep31625"  #@NEW_LINE#@#  
title  #@NEW_LINE#@#  
Use of Bayesian Inference in Crystallographic Structure Refinement via Full Diffraction Profile Analysis  #@NEW_LINE#@#  

Abstract  #@NEW_LINE#@#  
A Bayesian inference method for refining crystallographic structures is presented.  #@NEW_LINE#@#  The distribution of model parameters is stochastically sampled using Markov chain Monte Carlo.  #@NEW_LINE#@#  Posterior probability distributions are constructed for all model parameters to properly quantify uncertainty by appropriately modeling the heteroskedasticity and correlation of the error structure.  #@NEW_LINE#@#  The proposed method is demonstrated by analyzing a National Institute of Standards and Technology silicon standard reference material.  #@NEW_LINE#@#  The results obtained by Bayesian inference are compared with those determined by Rietveld refinement.  #@NEW_LINE#@#  Posterior probability distributions of model parameters provide both estimates and uncertainties.  #@NEW_LINE#@#  The new method better estimates the true uncertainties in the model as compared to the Rietveld method.  #@NEW_LINE#@#  

Introduction  #@NEW_LINE#@#  
X-ray diffraction is a powerful technique for characterizing the atomic structure of materials.  #@NEW_LINE#@#  Diffraction relies on scattering of X-rays from planes of atoms resulting in either constructive or destructive interference.  #@NEW_LINE#@#  Figure 1 shows example peaks observed in diffraction patterns, and the inset is a schematic of X-ray scattering from planes of atoms that results in constructive interferences.  #@NEW_LINE#@#  The constructive interference is observed in the diffraction pattern as intensity vs scattering angle (2).  #@NEW_LINE#@#  Over the past 100 years a variety of approaches have been developed to determine and refine the crystallographic structure from single crystal and powder diffraction patterns1,2.  #@NEW_LINE#@#  The pervasive application of these approaches is evidenced by over 200,000 structures being cataloged in the International Centre for Diffraction Data Database.  #@NEW_LINE#@#  Moving forward, X-ray techniques and analysis methods will continue to advance, particularly in the areas of combining data from different experimental or theoretical sources3, and in situ measurements during materials processing or performance1,2,4.  #@NEW_LINE#@#  It is also expected that new crystallographic structures will be used in global materials databases for property prediction, as articulated by the Materials Genome Initiative (MGI)5,6.  #@NEW_LINE#@#  
In diffraction, observed intensities (Yi) at angle 2i can be represented as intensities from the material of interest (f(2i|)), background scattering (b(2i|)), and errors (i), where i represents the ith data point in the measurement range.  #@NEW_LINE#@#  We write the observed intensity as  #@NEW_LINE#@#  
Here  is a collection of structural, microstructural, and instrumental parameters that determines the scattered intensity from a sample, and  are parameters used to construct the background scattering.  #@NEW_LINE#@#  Most current approaches in crystallographic refinement infer the structure by minimizing the difference between a calculated and experimental pattern.  #@NEW_LINE#@#  The difference is minimized by adjusting model parameters.  #@NEW_LINE#@#  One example is the Rietveld method7,8, in which the structure is refined in a least-squares (LSQ) minimization routine using a weighted sum of squares residual:  #@NEW_LINE#@#  
This minimization procedure results in estimates for each model parameter  and background parameter , and large-sample theory can be used to construct standard errors for these estimates.  #@NEW_LINE#@#  
While immensely powerful and widely applied, the Rietveld method can be subject to errors associated with false minima and uncertainty quantification8,9.  #@NEW_LINE#@#  In recent years, stochastic global optimization methods have been developed to improve the likelihood of reaching the global minimum10,11,12,13,14,15,16.  #@NEW_LINE#@#  However, the Rietveld method, and more recently developed stochastic methods, do not allow for the extraction of probability distributions of model parameters without prior knowledge of the distribution, a limitation that precludes the characterization of parameters in which a distribution is expected, e.g., unit cell descriptors (a, b, c, , , and ).  #@NEW_LINE#@#  It is also well known that the Rietveld method handles statistical uncertainties using Hessian propagation9, and accounts for systematic errors by multiplying the resulting standard uncertainty in model parameters by the goodness of fit (i.e.  #@NEW_LINE#@#  scaling)17,18.  #@NEW_LINE#@#  The practice of scaling the obtained standard uncertainty is an approximation for the effect of systematic errors on uncertainty in model parameters18.  #@NEW_LINE#@#  Instead, a more complete model that formally accounts for systematic errors may obtain standard uncertainties without scaling.  #@NEW_LINE#@#  
The application of alternative statistical approaches can address these deficiencies.  #@NEW_LINE#@#  For example, Bayesian statistical inference19 can be used to compute posterior probability distributions of model parameters.  #@NEW_LINE#@#  Though not yet widely applied in full profile refinement for atomic structure determination, Bayesian statistical inference has been used in related areas of crystallography and measurement science17,20,21,22,23,24,25,26,27,28.  #@NEW_LINE#@#  For example, Wiessner and Angerer demonstrated the use of Bayesian approaches to determine probability distributions in the phase fractions of austenite and martensite during heating and cooling of a steel sample29.  #@NEW_LINE#@#  Recently, Gagin and Levin developed a Bayesian approach to account for unknown systematic errors in Rietveld refinements.  #@NEW_LINE#@#  Their method, paired with a least-squares minimization algorithm provided significantly more accurate estimates of structural parameters and their uncertainties than the standard analysis17.  #@NEW_LINE#@#  
In this paper, we introduce and employ an alternative and unique Bayesian statistical approach to solve the crystallographic structure refinement problem.  #@NEW_LINE#@#  Similar to the Rietveld method, a diffraction pattern is calculated from a modeled crystallographic unit cell.  #@NEW_LINE#@#  However the difference between the modeled and measured diffraction pattern is not minimized to reach single point value estimates of model parameters.  #@NEW_LINE#@#  Instead, the parameter space is explored by sampling multiple combinations of model parameters using a Markov chain Monte Carlo (MCMC) algorithm30.  #@NEW_LINE#@#  The results of the analysis are the posterior probability distributions of all modeled parameters, which yield both estimates of all parameters and quantifiable uncertainty.  #@NEW_LINE#@#  This work introduces a formal framework to account for unknown systematic errors (e.g.  #@NEW_LINE#@#  those manifested by correlated residuals), correlated and complex error variance patterns to help solve the problem of uncertainty quantification9, and a Monte Carlo simulation study that verifies the statistical validity of this approach.  #@NEW_LINE#@#  Measures of uncertainty are important for formally testing for differences between samples, comparing properties of the new sample to a historical value, and determining whether more data is required to obtain reliable results.  #@NEW_LINE#@#  While introduced in the present work using X-ray diffraction of a National Institute of Standards and Technology (NIST) standard reference material (SRM), the present approach can be readily adopted for use with data from other measurement probes and materials and should serve as a new structure refinement approach.  #@NEW_LINE#@#  

Results  #@NEW_LINE#@#  
Data_collection_and_Rietveld_analysis  #@NEW_LINE#@#  
A high resolution synchrotron diffraction pattern of a NIST Silicon standard (SRM 640d) was measured at the state-of-the art beamline 11-BM-B of the Advanced Photon Source (APS) at Argonne National Laboratory.  #@NEW_LINE#@#  The sample was held at constant temperature (22.5°C) during the measurement.  #@NEW_LINE#@#  A Rietveld refinement analysis was first performed as a reference for a Bayesian approach.  #@NEW_LINE#@#  The execution of a Rietveld refinement also provides starting values for the MCMC algorithm.  #@NEW_LINE#@#  
The software package General Structure Analysis Software-II (GSAS-II) (version 0.2.0 revision 1466)31 was used to complete the Rietveld analysis.  #@NEW_LINE#@#  Traditionally, estimates are obtained by weighted least-squares minimization with weights proportional to the inverse of the intensity (Equation 1).  #@NEW_LINE#@#  The lattice parameter was fixed to the NIST reported value parameter (5.43123(8) Å at 22.5°C)32,33.  #@NEW_LINE#@#  The Finger-Cox-Jephcoat peak profile function was used to account for axial divergence.  #@NEW_LINE#@#  Reported instrumental parameters (Caglioti (U=1.163, V=0.126, and W=0.063) and axial divergence (SH/L=0.0011)) were used.  #@NEW_LINE#@#  The space group and Wycoff positions were set to that of diamond cubic, and the isotropic thermal parameter (Uiso) was initially set to be 0.001 (Å2).  #@NEW_LINE#@#  The parameter refinement sequence suggested by Young was followed to facilitate optimization and reduce the risk for nonconvergence of the least squares routine8.  #@NEW_LINE#@#  Additionally, Rietveld analyses were completed using various background orders (4th, 5th, 10th, and 15th) to confirm that the use of high order polynomial background does not yield an unstable least-squares refinement.  #@NEW_LINE#@#  Parameters obtained from all refinements were within two standard uncertainties, demonstrating that the 15th order Chebyshev polynomial used in this work does not inhibit the Rietveld refinement.  #@NEW_LINE#@#  
A representative fit of the refinement result is presented in Fig 2.  #@NEW_LINE#@#  The refined structural, microstructural, and instrumental parameters and goodness of fit indicators obtained from the Rietveld refinement are summarized in Table 1.  #@NEW_LINE#@#  A satisfactory fit could not be achieved without refining the Caglioti (U, V, and W) parameters.  #@NEW_LINE#@#  Instrumental parameters (Lx and Ly) associated with crystallite size and microstrain broadening were set to 0 and not refined; instead the crystallite size and microstrain broadening terms introduced in GSAS-II were used.  #@NEW_LINE#@#  The refined crystallite size (1.00006(6)m) and microstrain (0.0298(2)%) parameters were found to differ from the values reported in the NIST SRM 640D data sheet: 0.6m and 0, respectively32,33.  #@NEW_LINE#@#  The origin of the discrepancy between the refined and NIST reported value might arise from a difference in resolution of the measured data (i.e.  #@NEW_LINE#@#  synchrotron vs laboratory) or the implementation of methods used to infer crystallite size and strain broadening contributions (i.e.  #@NEW_LINE#@#  GSAS-II vs TOPAS)34.  #@NEW_LINE#@#  It should be noted that the previous NIST Si standard (SRM 640c) did report a non-zero microstrain.  #@NEW_LINE#@#  

Simulation_study  #@NEW_LINE#@#  
Before describing a Bayesian analysis of the NIST silicon standard, we present a simulation study to illustrate the importance of properly modeling the variance and correlation of the residuals and compare the proposed method with more standard approaches.  #@NEW_LINE#@#  We performed this study on a face centered cubic structure as a model system.  #@NEW_LINE#@#  We have chosen to study a simple system with idealized data generation mechanisms in which we can model gross features of diffraction data to explore the impact of not accounting for correlated residuals when estimating parameters and uncertainties.  #@NEW_LINE#@#  
Our simulation study proceeds by generating synthetic data from a model with known parameter values.  #@NEW_LINE#@#  We then fit the synthetic data using Bayesian inference to obtain estimates and credible intervals for model parameters, and compare the estimated values and intervals with the true values used to generate the data.  #@NEW_LINE#@#  By repeating this process many times we can study the statistical properties of the method, including estimating the accuracy and coverage of credible intervals.  #@NEW_LINE#@#  In particular, we demonstrate that models that do not account for heteroskedastic and correlated residuals give poor estimates of model parameters, and that the actual coverage of 90% credible intervals can be far less than 90%.  #@NEW_LINE#@#  
Synthetic data are generated from Equation 1.  #@NEW_LINE#@#  Observations are indexed by i, with i=1,..., n=901 observations made on a grid of 2 spanning 10 to 100 degrees 2 with 0.1 2 step.  #@NEW_LINE#@#  An arbitrary background intensity (Fig 3) is simulated to mimic a background that is typically observed in experiment  #@NEW_LINE#@#  
We set f(2|) to be  #@NEW_LINE#@#  
where SFhkl and L(2) represent the structure factor for the hkl reflection and Lorentz-polarization correction, respectively.  #@NEW_LINE#@#  Structure factors of gold were utilized.  #@NEW_LINE#@#  The vector  is comprised of six parameters: incident X-ray intensity (); wavelength (); 2 offset (); and Caglioti (U, V, and W) parameters.  #@NEW_LINE#@#  Diffraction peaks were modeled as Gaussian distributions with a full width half maximum that follows the Caglioti function35.  #@NEW_LINE#@#  Synthetic data were generated using =100, =1.54 Å, =0.10, U=0.10, V=0.05, W=0.03.  #@NEW_LINE#@#  The errors i are normally distributed with variance 2[f(2i|)/10000+0], where 2=20002 and 0=0.1.  #@NEW_LINE#@#  Errors on intensity are typically approximated using Poisson statistics, though in the limit of high counts this error can be approximated using a normal distribution.  #@NEW_LINE#@#  The stationary correlation between adjacent errors is set to =0.9, and autocorrelation between observations at angles 2i and 2j is |ij|.  #@NEW_LINE#@#  We generate N=100 data sets from this model.  #@NEW_LINE#@#  Representative true and background intensities are shown in Fig 3.  #@NEW_LINE#@#  
For each simulated data set, we fit four models that vary by their treatment of the residuals i.  #@NEW_LINE#@#  The goal of this simulation study is to examine the impact of fitting successively more complex models on the accuracy and precision of parameter estimates, as measured by relative mean squared error (RMSE) and the coverage of our credible intervals.  #@NEW_LINE#@#  We fit the model with independent residuals (correlation fixed at =0) and dependent residuals (0).  #@NEW_LINE#@#  We also fit model with equal residual variance Var(i)=2 (analogous to least-squares minimization) and unequal residual variance Var(i)=2[f(2i|)/10000+0] (analogous to weighted least-squares minimization).  #@NEW_LINE#@#  For all models, we capture the background process using a b-spline basis expansion with 20 degrees of freedom, which is sufficiently rich to capture the true background intensity.  #@NEW_LINE#@#  We use MCMC to generate 5,000 posterior samples, discarding the first 1,000 as burn-in.  #@NEW_LINE#@#  Additional details about the specification of the models, including prior distributions, can be found in the supplementary materials.  #@NEW_LINE#@#  
For each data set and each of the four models, we compute an estimate of the parameter (specifically, the posterior mean) and 90% (equal-tailed) credible interval for each parameter in .  #@NEW_LINE#@#  A 90% credible interval should have a 90% probability of containing the true parameter.  #@NEW_LINE#@#  Let j be the true value of the jth element of  and  be posterior mean for data set s=1,..., N. Methods are compared using relative mean squared error,  #@NEW_LINE#@#  
We also compute the empirical coverage of the 90% intervals.  #@NEW_LINE#@#  That is, for each data set we compute the posterior 90% interval for each element of  and report the sample proportion of the S intervals that contain the true value j (as illustrated in Fig 4).  #@NEW_LINE#@#  Methods with small RMSE for all parameters and coverage at or above 90% are preferred.  #@NEW_LINE#@#  
RMSE and coverage of the 90% credible intervals for each model are summarized in Table 2.  #@NEW_LINE#@#  The simplest model (independent residuals and constant (homoskedastic) variance) has the largest RMSE and lowest coverage of the 90% intervals.  #@NEW_LINE#@#  Including additional complexity (correlated residuals or variable (heteroskedastic) variance) decreases the RMSE and increases the coverage of the 90% interval.  #@NEW_LINE#@#  The coverage of the 90% intervals for the full model is near or above the nominal 90% level for all parameters while the coverage sinks far below 90% for simpler models.  #@NEW_LINE#@#  Therefore, we conclude that it is essential to adequately model the residual distribution of  to obtain valid statistical inference.  #@NEW_LINE#@#  It is noted that the model implemented in Rietveld refinement method uses independent residuals and variable (heteroskedastic) variance.  #@NEW_LINE#@#  The Bayesian model we propose in the next section uses a more complex residual structure that should improve our estimates and credible intervals.  #@NEW_LINE#@#  

Bayesian_Analysis_of_the_NIST_silicon_standard  #@NEW_LINE#@#  
Bayesian analyses begin by specifying a prior probability distribution that captures any knowledge about parameters that we have before the experiment.  #@NEW_LINE#@#  Based on observed data, this knowledge is updated to a posterior probability distribution, which reflects the resulting uncertainty about the model parameters.  #@NEW_LINE#@#  Figure 5 compares the posterior distributions for select model parameters (wavelength, U, Uiso, and crystallite size) to point estimates and the corresponding standard uncertainty (s.u.)  #@NEW_LINE#@#  determined by Rietveld analysis.  #@NEW_LINE#@#  Posterior distributions for all model parameters are reported in supplemental information (Supplementary Figs 1, 2, 3, 4 and 5).  #@NEW_LINE#@#  
Figure 5 and Supplementary Figs 1, 2, 3, 4 and 5 demonstrate that model parameters estimated by Bayesian inference are in reasonable agreement with point estimates determined by Rietveld.  #@NEW_LINE#@#  With the exception of Uiso and scale, the posterior distributions overlap with the Rietveld point estimates.  #@NEW_LINE#@#  Figure 5 suggests that, for a NIST Si standard measured at 11-BM-B, the uncertainties in model parameters estimated by LSQ minimization are comparable to those estimated by Bayesian inference.  #@NEW_LINE#@#  In the case of the 2 offset (zero) the s.u.  #@NEW_LINE#@#  is significantly larger than the uncertainty determined by Bayesian inference (Supplementary Fig 5).  #@NEW_LINE#@#  


Discussion  #@NEW_LINE#@#  
The two analysis approaches, Rietveld (non-Bayesian) and Bayesian inference, are fundamentally different.  #@NEW_LINE#@#  The most important distinction of the Bayesian approach is that prior distributions are created and propagated through the analysis to posterior distributions for parameters and predictive distributions for observables.  #@NEW_LINE#@#  A posterior distribution offers a richer set of information regarding the uncertainty in model parameters than the s.u.  #@NEW_LINE#@#  obtained from LSQ minimization.  #@NEW_LINE#@#  For example, a posterior distribution can be used to demonstrate that a model parameter has a multimodal or asymmetric distribution of values.  #@NEW_LINE#@#  This is evident in the posterior distribution of U (Fig 5),  (Fig 5), crystal size (Fig 5), V (Supplementary Fig 3) and 2 offset (Supplementary Fig 5) where the posterior distributions are asymmetric.  #@NEW_LINE#@#  
Distributions of certain parameters can be determined from other refinement approaches.  #@NEW_LINE#@#  For example, the Whole Powder Pattern Modeling (WPPM) method has been used to model distributions of crystallite size using assumed distributional forms such as normal and lognormal36.  #@NEW_LINE#@#  However, the present approach enables the determination of general posterior densities without requiring these assumptions a priori.  #@NEW_LINE#@#  
To determine the quality of fit, crystallographers typically plot the modeled intensity against the observed intensities.  #@NEW_LINE#@#  Because Bayesian inference does not converge to a single-valued estimate for model parameters, any single diffraction profile generated from a MCMC sample should be thought of as one observation from an ensemble.  #@NEW_LINE#@#  One may construct a representative pattern from the ensemble by 1) choosing a single pattern or 2) averaging the calculated patterns from many MCMC samples.  #@NEW_LINE#@#  We use the second method and present in Fig 2 a single pattern that is the average of the patterns produced using the parameters from the final 1000 MCMC samples.  #@NEW_LINE#@#  We employ method 2 because it incorporates correlations, asymmetries, and uncertainties in the parameter distributions when computing predicted patterns.  #@NEW_LINE#@#  Though this representation overly simplifies the result of the Bayesian approach, it does demonstrate that the modeled patterns match well to the measured data.  #@NEW_LINE#@#  
Figure 2 shows the fit of the modeled pattern to the measured data for the Rietveld and Bayesian approaches.  #@NEW_LINE#@#  The insets in Fig 2 highlight various reflections to illustrate that the Bayesian and Rietveld methods achieve a similar quality of fit.  #@NEW_LINE#@#  From Fig 2 it is difficult to determine any subtle difference in the the fitting quality of the Bayesian and Rietveld analysis.  #@NEW_LINE#@#  The measured data and Rietveld and Bayesian results are overlaid, and a residual curve is also shown to highlight differences in the Rietveld and Bayesian results in Fig 6.  #@NEW_LINE#@#  The difference curve demonstrates that Bayesian inference method better reproduces the observed diffraction profiles.  #@NEW_LINE#@#  This is evidenced by a positive and negative difference curve in regions where the Rietveld method under and over estimates the observed intensity.  #@NEW_LINE#@#  The 911/953 profile highlights that the Rietveld method underestimates the peak position, while Bayesian inference estimates a peak positions that more closely reproduces the observed peak position.  #@NEW_LINE#@#  
In addition to these graphical comparisons, Table 3 provides several numerical summaries of the Rietveld and Bayesian analyses.  #@NEW_LINE#@#  Each goodness-of-fit measure in Table 3 uses the discrepancy between the observed intensities Yi and the calculated intensities .  #@NEW_LINE#@#  The goodness-of-fit measures differ by whether they use absolute or squared errors, and whether observations are weighted by the observed intensities.  #@NEW_LINE#@#  Results of the residual analysis presented in Table 3 demonstrate that the Bayesian inference method achieves a final result that more closely reproduces the measured diffraction data than the Rietveld method, as for each of the measurements of discrepancy, the results obtained by Bayesian inference are smaller.  #@NEW_LINE#@#  The improved performance provided by Bayesian inference is likely due to the manner in which parameters are optimized in Rietveld refinement.  #@NEW_LINE#@#  As described by Young8, Rietveld refinement employs a one-by-one turn-on sequence to facilitate optimization and avoid unstable least squares behavior, which can cause optimization to fail.  #@NEW_LINE#@#  In this sequence, uncorrelated parameters are optimized first, followed by those that are considered to be correlated or potentially less stable.  #@NEW_LINE#@#  Young notes that this strategy improves the robustness of the optimization procedure.  #@NEW_LINE#@#  The disadvantage is that coordinate descent in this manner is prone to termination in local minima, even when multiple initial values are employed.  #@NEW_LINE#@#  In contrast, the inherently stochastic nature of the MCMC approach mitigates being trapped in a false minimum because the parameter space (bounded by the priors) is randomly sampled and no turn-on sequence is employed.  #@NEW_LINE#@#  The Bayesian approach is thus less sensitive to the potential instabilities in parameters that can be observed in the Rietveld method.  #@NEW_LINE#@#  We note that the MCMC approach does not preclude chains from being trapped in local minima.  #@NEW_LINE#@#  However, the chance of becoming trapped in a local minimum can be reduced through the use of multiple initial starting values, careful consideration of algorithm diagnostics, and appropriate parameter transformation.  #@NEW_LINE#@#  We have employed all of these methods in the development of our algorithm, and details are discussed in the methods and supplementary materials.  #@NEW_LINE#@#  
The development and tuning of MCMC algorithms to perform Bayesian inference can be a complex process, especially when incorporating computations from other codes.  #@NEW_LINE#@#  In the example utilizing our approach, the computational expense of accurately modeling a diffraction pattern with 50,000 data points, 30 reflections, and complex peak shapes (required to account for axial divergence) is a substantial bottleneck for the MCMC analysis.  #@NEW_LINE#@#  At each MCMC iteration a model diffraction pattern must be calculated using GSAS-II for each of the ten model parameters.  #@NEW_LINE#@#  One thousand iterations required, on average, 900s on an Intel CoreTM i5-3750.  #@NEW_LINE#@#  [The identification of any commercial product or trade name does not imply endorsement or recommendation by the National Institute of Standards and Technology.]  #@NEW_LINE#@#  To be conservative, we ran the MCMC algorithm for 100,000 iterations.  #@NEW_LINE#@#  Diagnostic plots, like those in Supplementary Figs 6, 7 and 8, show the convergence of the algorithm.  #@NEW_LINE#@#  
One particular advantage of Bayesian inference is its ability to incorporate prior knowledge.  #@NEW_LINE#@#  With the exception of rigid body constraints, there is no framework for incorporating prior knowledge about the sample of interest (e.g., crystallite size obtained by electron microscopy analysis) into a Rietveld analysis.  #@NEW_LINE#@#  A prior distribution, which makes a probabilistic specification of prior knowledge, is required in the Bayesian approach.  #@NEW_LINE#@#  While this can be defined by physical expectations at the outset of an analysis, it is also possible to employ iterative or hierarchical calculations in the Bayesian approach.  #@NEW_LINE#@#  For example, posterior distributions obtained from a Bayesian inference of LaB6 NIST SRM 660a can serve as priors for subsequent analyses.  #@NEW_LINE#@#  I.e., one might first complete a Bayesian analysis on a NIST SRM designed to quantify line broadening to obtain posterior distributions for instrumental parameters (e.g., wavelength, axial divergence, and Caglioti peak shape parameters).  #@NEW_LINE#@#  These results could be used in analyses of structurally more complex materials (such as relaxor ferroelectrics or high entropy alloys) where well-calibrated instrumental parameters are critical for obtaining posterior distributions that precisely describe the structure of the material of interest, for example, the lattice and atomic parameters (displacements, occupancies, and thermal factors)8.  #@NEW_LINE#@#  Additionally, the MCMC algorithm has an important advantage over a deterministic least-squares minimization: the ability to escape from local minima.  #@NEW_LINE#@#  The stochastic aspect of the MCMC algorithm enables the method to overcome barriers that would otherwise trap a least-squares method in a confined region of parameter space.  #@NEW_LINE#@#  This advantage makes the use of the present method advantageous despite its computationally-intensive nature.  #@NEW_LINE#@#  
In summary, we present a new Bayesian inference method for refining crystallographic structures.  #@NEW_LINE#@#  This approach is fundamentally different from that of the Rietveld method, which is currently the predominant analysis method for structure refinement.  #@NEW_LINE#@#  This analysis approach is applied to an example where the structure of a standard reference material is refined using synchrotron X-ray diffraction data.  #@NEW_LINE#@#  The approach can be readily adopted to refine other structures as well as integrating additional or different data sources (e.g., area detector patterns and neutron diffraction patterns).  #@NEW_LINE#@#  The Bayesian approach offers a richer description of the model and model uncertainties than has been available previously.  #@NEW_LINE#@#  

Methods  #@NEW_LINE#@#  
Data_collection_and_Rietveld_analysis  #@NEW_LINE#@#  
An X-ray wavelength of 0.413848Å (30.1keV) was utilized.  #@NEW_LINE#@#  Diffracted X-rays were measured using an array of twelve detectors with Si (111) analyzer crystals37,38.  #@NEW_LINE#@#  Measured data was merged into a single data set using previously reported methods38.  #@NEW_LINE#@#  
A 15th order Chebyshev polynomial background was used to account for an irregular background due to amorphous scattering from the Kapton® capillary.  #@NEW_LINE#@#  Parameters refined include the zero, profile shape (U, V, and W), scale, wavelength, isotropic displacement parameter (Uiso), microstrain and crystallite size.  #@NEW_LINE#@#  

Prior_distributions_for_simulation_study  #@NEW_LINE#@#  
Within the simulation study, the coefficients for the background model have prior distribution .  #@NEW_LINE#@#  The other prior distributions used are 2, 2~InvGamma(0.01, 0.01), log(0)~N(0, 102) (for the heteroskedastic models), Io~Unif(90, 110), ~Unif(1.5, 1.6), ~Unif(0, 1), U~Unif(0.08, 0.12), V~Unif(0.06, 0.03), W~Unif(0.015, 0.45), and ~Unif(0, 1) (for the models with correlated residuals).  #@NEW_LINE#@#  

Bayesian_inference  #@NEW_LINE#@#  
The Bayesian inference method uses Equation 1 to model the observed data.  #@NEW_LINE#@#  The background intensity is approximated using the spline basis expansion,  #@NEW_LINE#@#  
where Bl are known basis functions and l are unknown coefficients that determine the shape of b.  #@NEW_LINE#@#  In our analysis we use b-spline basis functions.  #@NEW_LINE#@#  B-splines are a flexible piecewise polynomial functions used for curve fitting that provide results similar to higher degree polynomials while avoiding potential instabilities39.  #@NEW_LINE#@#  The coefficients l have priors l~Normal(0, 2).  #@NEW_LINE#@#  This prior was selected because we do not have prior information about the background intensity; it does not imply that our resulting estimates are centered at 0.  #@NEW_LINE#@#  By treating these coefficients as part of the Bayesian hierarchical model we propagate uncertainty about the background correction through to the posterior distributions.  #@NEW_LINE#@#  
Since the counts are large, we approximate their distribution as Gaussian with variance depending on the mean.  #@NEW_LINE#@#  Specifically, the residuals are modeled as Gaussian with mean zero and variance Var(i)=2[f(2i|)/C+0], where C is a large constant to scale the variance.  #@NEW_LINE#@#  Therefore, the overall variance is determined by 2, but the variance increases with the intensity f(2i|)  0.  #@NEW_LINE#@#  The constant 00 is included so that the variance remains positive for observations with f(2i|)=0.  #@NEW_LINE#@#  This approach is in contrast with the frequent assumption that the residual variance is proportional to the observed intensity, Yi, and is a common statistical approach for count data.  #@NEW_LINE#@#  In addition to heteroskedasticity, we account for dependence between the residuals for intensities with similar angles using an AR(1) process, so that correlation between residuals h observations is h. The correlation parameter is given an uninformative prior and is estimated as part of the MCMC process.  #@NEW_LINE#@#  Autocorrelation in residuals could arise from background scattering.  #@NEW_LINE#@#  If the modeled background is lower-order than required to fit the diffuse scattering, then autocorrelation would be expected.  #@NEW_LINE#@#  Likewise, an imprecise peak position would lead to autocorrelation.  #@NEW_LINE#@#  This is because many data points are used to sample a smooth peak and the left and right hand sides of the peaks would both exhibit correlated residuals.  #@NEW_LINE#@#  
To complete the Bayesian model we specify prior distributions for the remaining parameters.  #@NEW_LINE#@#  As examples, the prior distribution for X-ray wavelength is uniform between 0.41 and 0.42, and the prior distribution for the Uiso is uniform between 0.0 and 0.1.  #@NEW_LINE#@#  The remaining parameters are summarized in Supplementary Table 1.  #@NEW_LINE#@#  For this analysis, we use L=15 b-spline basis functions to mirror the Rietveld analysis.  #@NEW_LINE#@#  
Modeled diffraction patterns used for the Bayesian analysis were calculated using routines extracted from GSAS-II.  #@NEW_LINE#@#  A standalone Python class was developed to interface with GSAS-II routines utilized to calculate a diffraction pattern (i.e., peak intensity, position, and profile shape).  #@NEW_LINE#@#  This Python class enabled calculating a modeled diffraction pattern and modification of parameters that controls the modeled pattern (e.g., lattice parameters, atomic occupancy and position, Uiso factor, peak profile parameters, etc.).  #@NEW_LINE#@#  The Python code is included in a Supplementary note.  #@NEW_LINE#@#  

MCMC_Details  #@NEW_LINE#@#  
MCMC is an iterative, general-purpose algorithm to draw samples from a complex, multivariate distribution30: in this case, the posterior distribution of the parameters of the model.  #@NEW_LINE#@#  The algorithm requires starting values, which we initialize using the point estimates from the Rietveld refinement in our analyses.  #@NEW_LINE#@#  To improve convergence, we transform bounded parameters to take values on the real line and linearly transform correlated parameters.  #@NEW_LINE#@#  We run 100,000 iterations and verify convergence using standard diagnostics.  #@NEW_LINE#@#  Since the procedure is iterative, observations near the beginning of the chain (called burn-in) have not converged and are not draws from the appropriate distribution, so they are discarded.  #@NEW_LINE#@#  Here, the first 10,000 runs are discarded for burn-in.  #@NEW_LINE#@#  The posterior distributions are summarized using the posterior mean, which is calculated as the average of the posterior samples, and posterior credible intervals.  #@NEW_LINE#@#  Since a posterior distribution is a probability distribution, it integrates to 1.  #@NEW_LINE#@#  A p% credible interval is an interval over which the posterior distribution integrates to p/100.  #@NEW_LINE#@#  
Since MCMC is an iterative procedure, there are a variety of diagnostics used to diagnose when samples are being drawn from the desired distribution and how many samples should be discarded as burn-in.  #@NEW_LINE#@#  Supplementary Fig 6 plots sample pairs for three parameters (and marginal density estimates).  #@NEW_LINE#@#  If the sample pairs indicate high correlation (e.g., the point clouds are elongated instead of round), this may indicate that the MCMC should be adjusted to allow for faster convergence.  #@NEW_LINE#@#  Supplementary Fig 7 plots successive samples from a single parameter.  #@NEW_LINE#@#  These plots are termed trace plots.  #@NEW_LINE#@#  As convergence is reached, the samples stabilize around a value; the early samples are burn-in.  #@NEW_LINE#@#  This is also illustrated by Supplementary Fig 8.  #@NEW_LINE#@#  
We perform MCMC sampling using an equivalent and convenient parameterization.  #@NEW_LINE#@#  The priors for the elements of =(1,...,p) are independent and uniform j~Uniform(lj, uj), where the prior intervals (lj, uj) are chosen to give a scientifically plausible range of values.  #@NEW_LINE#@#  MCMC sampling is easier for parameters defined on the real line, so we perform computing using the parameterization j=lj+(ujlj)(zj), where  is the standard normal cumulative distribution function and zi have standard normal priors.  #@NEW_LINE#@#  This induces a Uniform(lj, uj) prior for j, and so the parameterization is equivalent to the desired model.  #@NEW_LINE#@#  
For i1 the auto-regression model can be written:  #@NEW_LINE#@#  
where z=(z1,..., zp), i~Normal[0, 2(12)i(z)] independent over i, and i(z)=f(2i|z)/C+0.  #@NEW_LINE#@#  Since the first observation provides negligible information, we ignore the first observation and express the remaining n1 observations in matrix notation,  #@NEW_LINE#@#  
where Y=(Y2,..., Yn)T, B is the (n1)×L matrix of basis coefficients, , , ,  are lagged matrices, e.g., , W(z) is diagonal with diagonal elements , , , and (z) is diagonal with diagonal elements (12)2(z), , (12)n(z).  #@NEW_LINE#@#  
We explore the posterior by generating MCMC samples.  #@NEW_LINE#@#  MCMC sampling begins by specifying initial values for all parameters, , Z, , 2 and 2.  #@NEW_LINE#@#  For each iteration of the algorithm, the parameters are updated in sequence conditioned on all other parameters.  #@NEW_LINE#@#  The parameters , 2, 2 have conjugate full conditional distributions and are thus updated using Gibbs sampling.  #@NEW_LINE#@#  The full conditional distributions are  #@NEW_LINE#@#  
where , ,  and the priors are 2~InvGamma(a1, b1) and 2~InvGamma(a2, b2).  #@NEW_LINE#@#  
The remaining parameters  and z do not have conjugate full conditionals and are thus updated using Metropolis sampling.  #@NEW_LINE#@#  We use random-walk Gaussian candidate distributions for both  and z.  #@NEW_LINE#@#  The standard deviation for s candidate distribution is tuned to give acceptance probability near 0.4; candidates outside the prior range (0, 1) are discarded.  #@NEW_LINE#@#  The parameter vector z is updated as a block.  #@NEW_LINE#@#  The proposal covariance matrix is c , where c is a tuning parameter selected to give acceptance probability near 0.4 and the matrix  is taken to be the posterior covariance matrix of z from an initial MCMC sample.  #@NEW_LINE#@#  




