article id="http://dx.doi.org/10.1038/srep24169"  #@NEW_LINE#@#  
title  #@NEW_LINE#@#  
A stochastic model for immunotherapy of cancer  #@NEW_LINE#@#  

Abstract  #@NEW_LINE#@#  
We propose an extension of a standard stochastic individual-based model in population dynamics which broadens the range of biological applications.  #@NEW_LINE#@#  Our primary motivation is modelling of immunotherapy of malignant tumours.  #@NEW_LINE#@#  In this context the different actors, T-cells, cytokines or cancer cells, are modelled as single particles (individuals) in the stochastic system.  #@NEW_LINE#@#  The main expansions of the model are distinguishing cancer cells by phenotype and genotype, including environment-dependent phenotypic plasticity that does not affect the genotype, taking into account the effects of therapy and introducing a competition term which lowers the reproduction rate of an individual in addition to the usual term that increases its death rate.  #@NEW_LINE#@#  We illustrate the new setup by using it to model various phenomena arising in immunotherapy.  #@NEW_LINE#@#  Our aim is twofold: on the one hand, we show that the interplay of genetic mutations and phenotypic switches on different timescales as well as the occurrence of metastability phenomena raise new mathematical challenges.  #@NEW_LINE#@#  On the other hand, we argue why understanding purely stochastic events (which cannot be obtained with deterministic models) may help to understand the resistance of tumours to therapeutic approaches and may have non-trivial consequences on tumour treatment protocols.  #@NEW_LINE#@#  This is supported through numerical simulations.  #@NEW_LINE#@#  

Introduction  #@NEW_LINE#@#  
Immunotherapy of cancer received a lot of attention in the medical as well as the mathematical modelling communities during the last decades1,2,3,4,5,6.  #@NEW_LINE#@#  Many different therapeutic approaches were developed and tested experimentally.  #@NEW_LINE#@#  As for the classical therapies such as chemo- and radiotherapy, resistance is an important issue also for immunotherapy: although a therapy leads to an initial phase of remission, very often a relapse occurs.  #@NEW_LINE#@#  The main driving forces for resistance are considered to be the genotypic and phenotypic heterogeneity of tumours, which may be enhanced during therapy, see5,6,7 and references therein.  #@NEW_LINE#@#  A tumour is a complex tissue which evolves in mutual influence with its environment8.  #@NEW_LINE#@#  
In this article, we consider the example of melanoma (tumours associated to skin cancer) under T-cell therapy.  #@NEW_LINE#@#  Our work is motivated by the experiments of Landsberg et al.9, which investigate melanoma in mice under adoptive cell transfer (ACT) therapy.  #@NEW_LINE#@#  This therapeutic approach involves the injection of T-cells which recognise a melanocyte-specific antigen and are able to kill differentiated types of melanoma cells.  #@NEW_LINE#@#  The therapy induces an inflammation and the melanoma cells react to this environmental change by switching their phenotype, i.e.  #@NEW_LINE#@#  by passing from a differentiated phenotype to a dedifferentiated one (neural-crest progenitor-like phenotype).  #@NEW_LINE#@#  The T-cells recognise the cancerous cells through the melanocytic antigens which are downregulated in the dedifferentiated types.  #@NEW_LINE#@#  Thus, they are not capable of killing these cancer cells, and a relapse is often observed.  #@NEW_LINE#@#  The phenotype switch is enhanced, if pro-inflammatory cytokines, called TNF- (Tumour Necrosis Factor), are present.  #@NEW_LINE#@#  A second reason for the appearance of a relapse is that the T-cells become exhausted and are not working efficiently anymore.  #@NEW_LINE#@#  This problem was addressed by re-stimulation of the T-cells, but this led only to a delay in the occurrence of the relapse.  #@NEW_LINE#@#  Of course, other immune cells and cytokines are also present.  #@NEW_LINE#@#  However, according to the careful control experiments, their influence can be neglected in the context of the phenomena considered here.  #@NEW_LINE#@#  
Cell division is not required for switching, and switching is reversible.  #@NEW_LINE#@#  This means that the melanoma cells can recover their initial (differentiated) phenotype9.  #@NEW_LINE#@#  The switch is thus a purely phenotypic change which is not induced by a mutation.  #@NEW_LINE#@#  The state of the tumour is a mixture of differentiated and dedifferentiated cells.  #@NEW_LINE#@#  One possibility to avoid a relapse is to inject two types of T-cells (one specific to differentiated cells as above, and the other specific to dedifferentiated cells) as suggested also in9.  #@NEW_LINE#@#  
In this paper, we propose a quantitative mathematical model that can reproduce the phenomena observed in the experiments of9, and which allows to simulate different therapy protocols, including some where several types of T-cells are used.  #@NEW_LINE#@#  The model we propose is an extension of the individual-based stochastic models for adaptive dynamics that were introduced in Metz et al.10 and developed and analysed by many authors in recent years (see e.g.11,12,13,14,15,16,17,18,19,40) to the setting of tumour growth under immunotherapy.  #@NEW_LINE#@#  Such models are also referred to as agent-based models or particle systems.  #@NEW_LINE#@#  Note that we use the term individual for T-cells, cytokines or cancer cells, in particular not for patients or mice.  #@NEW_LINE#@#  
These stochastic models describe the evolution of interacting cell populations, in which the relevant events for each individual (e.g.  #@NEW_LINE#@#  birth and death) occur randomly.  #@NEW_LINE#@#  It is well known that in the limit of large cell-populations, these models are approximated by deterministic kinetic rate models, which are widely used in the modelling of cell populations.  #@NEW_LINE#@#  However, these approximations are inaccurate and fail to account for important phenomena, if the numbers of some sub-populations become small.  #@NEW_LINE#@#  In such situations, random fluctuation may become highly significant and completely alter the long-term behaviour of the system.  #@NEW_LINE#@#  For example, in a phase of remission during therapy, the cancer and the T-cell populations drop to a low level and may die out due to fluctuations.  #@NEW_LINE#@#  
A number of (mostly deterministic) models have been proposed that describe the development of a tumour under treatment, focusing on different aspects.  #@NEW_LINE#@#  For example, a deterministic model for ACT therapy is presented in3.  #@NEW_LINE#@#  Stochastic approaches were used to understand certain aspects of tumour development, for example rate models20 or multi-type branching processes; see the book by Durrett21 or22,23,24.  #@NEW_LINE#@#  To our knowledge, however, it is a novel feature of our models to describe the coevolution of immune- and tumour cells taking into account both interactions and phenotypic plasticity.  #@NEW_LINE#@#  Our model can help understanding the interplay of therapy and resistance, in particular in the case of immunotherapy, and may be used to predict successful therapy protocols.  #@NEW_LINE#@#  

Results  #@NEW_LINE#@#  
The_model  #@NEW_LINE#@#  
We now give a more detailed description of the models we consider.  #@NEW_LINE#@#  They contain three types of actors: First, cancer cells characterised by a genotype and a phenotype.  #@NEW_LINE#@#  These cells can divide (with or without mutation), die (due to age, competition or therapy) and switch their phenotype.  #@NEW_LINE#@#  We assume that the switch is inherited by the descendants of the switched cells.  #@NEW_LINE#@#  Second, T-cells that can divide, die and produce cytokines.  #@NEW_LINE#@#  Third, cytokines which can vanish and influence the switching of cancer cells.  #@NEW_LINE#@#  
The trait space, , is a finite set of the form  #@NEW_LINE#@#  
where  denotes a cancer cell with genotype g and phenotype p,  a T-cell of type z and  a cytokine of type w. We write || for the number of elements of a set and  for disjoint unions of sets.  #@NEW_LINE#@#  Figure 1 provides a graphical representation of the transitions for a population with trait space .  #@NEW_LINE#@#  
A population at time  is represented by the measure  #@NEW_LINE#@#  
where t(x) is the number of individuals of type x at time t and x denotes the Dirac measure at x.  #@NEW_LINE#@#  Here, K is a parameter that allows to scale the population size and is usually called carrying-capacity of the environment.  #@NEW_LINE#@#  The dynamics of the population is a continuous time Markov process,  that is described by specifying the following transition rates:  #@NEW_LINE#@#  
Each cancer cell of type (g, p) is characterised by  #@NEW_LINE#@#  
Each T-cell of type z is characterised by  #@NEW_LINE#@#  
Each cytokine of type w is characterised by  #@NEW_LINE#@#  
Note that the relation between  and  is encoded in the switch kernels.  #@NEW_LINE#@#  They specify which phenotypes are expressed by a given genotype and influence the proportions of the different phenotypes in a (dynamic) environment.  #@NEW_LINE#@#  
It is an important feature of stochastic models opposed to deterministic ones that populations can die out.  #@NEW_LINE#@#  There are two main reasons for the extinction of a population for finite K: first, the trajectory of the population size is transient and passes typically through a low minimum.  #@NEW_LINE#@#  In this case, random fluctuations can lead to extinction before the population reaches its equilibrium.  #@NEW_LINE#@#  Second, fluctuations around a finite equilibrium cause extinction of a population after a long enough time.  #@NEW_LINE#@#  The second case happens at much longer times scales than the first one.  #@NEW_LINE#@#  In both cases, the value of K plays a crucial role, since it determines the amplitude of the fluctuations and thus the probability of extinction.  #@NEW_LINE#@#  
It is well-known that the sequence of Markov processes, , converges in the limit of large populations (K) to the solution of a system of quadratic, ordinary differential equations, see25.  #@NEW_LINE#@#  For this reason the deterministic system provides also (partial) information on the stochastic system.  #@NEW_LINE#@#  The deterministic system consists of a logistic part, a predator-prey relation between T-cells and cancer cells, a mutation and a switch part.  #@NEW_LINE#@#  The relevant mutations in the setup of cancer therapy are driver mutations and appear only rarely.  #@NEW_LINE#@#  In this case, more precisely, when the mutation probabilities, , tend to zero as K, mutations are invisible in the deterministic limit.  #@NEW_LINE#@#  Due to the presence of the switches the analysis of the system is difficult.  #@NEW_LINE#@#  It is not a generalised Lotka-Volterra system of the form , where f is linear in .  #@NEW_LINE#@#  For precise mathematical descriptions, see the Supporting Information (SI).  #@NEW_LINE#@#  
In the last two sections of this article we show how to deal mathematically with rare mutations and their interactions with fast phenotypic switches or therapy.  #@NEW_LINE#@#  

Therapy_with_T-cells_of_one_specificity  #@NEW_LINE#@#  
In this section we present an example which qualitatively models the experiment of Landsberg et al.9, where melanoma escape ACT therapy by phenotypic plasticity in presence of TNF-.  #@NEW_LINE#@#  Mutations are not considered here, since this was not investigated in the experiments.  #@NEW_LINE#@#  Let us denote by x :=(g, p) the differentiated cancer cells, by y :=(g, p) the dedifferentiated cancer cells, by zx the T-cells attacking only cells of type x, and by w the TNF- proteins.  #@NEW_LINE#@#  
We start with describing the deterministic system and denote by  its solution for trait i{x, y, zx, w}.  #@NEW_LINE#@#  Let us explain here an example (parameters are given in the (SI)) with three fixed points, see the black dots on Fig 2(b): P0000 where all populations sizes are zero,  #@NEW_LINE#@#  
Pxy00 where the T-cells and TNF- are absent and both melanoma populations are present and  where all populations are present.  #@NEW_LINE#@#  is the only stable fixed point and Pxy00 is stable in the invariant subspace  (i.e.  #@NEW_LINE#@#  if the T-cell population is zero).  #@NEW_LINE#@#  To highlight the qualitative features of the system, we choose parameters such that the minimum of the T-cell population during remission is low, and such that the equilibrium value of melanoma of type x in presence of T-cells is low, whereas equilibrium values of both melanoma types in absence of T-cells are high.  #@NEW_LINE#@#  
For initial conditions such that the number of differentiated melanoma cells, , is large, the number of injected T-cells, , is small, and the numbers of dedifferentiated melanoma cells, , and TNF- molecules, , are small or equal to zero, the deterministic system is attracted to : the T-cell population, , increases in presence of its target x, TNF- is secreted, and the population of differentiated melanoma cells, , shrinks due to killing and TNF- induced switching, whereas the population of dedifferentiated melanoma cells, , grows.  #@NEW_LINE#@#  
For the stochastic system, several types of behaviour can occur with certain probabilities: either the trajectory stays close to that of the deterministic system and the system reaches a neighbourhood of the fixed point  (Fig 3(a)) or the T-cell population, K(zx), dies out and the system reaches a neighbourhood of Pxy00 (Fig 3(b)).  #@NEW_LINE#@#  In the latter case the TNF- population, K(w), becomes extinct shortly after the extinction of the T-cells, K(zx), and the population of differentiated melanoma cells, K(x), can grow again.  #@NEW_LINE#@#  Moreover, TNF- inducing the switch from x to y vanishes and we observe a relapse which consists mainly of differentiated cells.  #@NEW_LINE#@#  Depending on the choice of parameters (in particular switching, therapy or cross-competition), a variety of different behavior is possible.  #@NEW_LINE#@#  

Therapy_with_T-cells_of_two_specificities  #@NEW_LINE#@#  
A therapy can only be called successful if the whole tumour is eradicated or kept small for a long time.  #@NEW_LINE#@#  A natural idea is thus to inject two types of T-cells in future therapies as suggested in9.  #@NEW_LINE#@#  To model this scenario, we just need to add T-cells attacking the dedifferentiated cells as new actors to the setting described above.  #@NEW_LINE#@#  We denote them by zy.  #@NEW_LINE#@#  The system contains one more predator-prey term between y and zy and can be found in the (SI).  #@NEW_LINE#@#  This adds two new fixed points (see the blue dots on Fig 2(b)):  is the new stable fixed point with all non-zero populations, and  corresponds to the absence of the T-cell population of type zx.  #@NEW_LINE#@#  The invariant subspaces are now , in which  is stable, , in which  is stable and , in which Pxy000 is stable.  #@NEW_LINE#@#  Note that , corresponding to  from the last section, is unstable in the enlarged space.  #@NEW_LINE#@#  
With the same initial conditions as before and  small but positive, the deterministic system is attracted to the stable fixed point : the T-cell population, , increases in presence of its target x, TNF- is secreted, and the differentiated melanoma population shrinks due to killing and switching, the population of dedifferentiated melanoma grows, but is regulated and kept at a low level by the T-cells of type zy.  #@NEW_LINE#@#  Similarly,  is regulated by .  #@NEW_LINE#@#  See (SI).  #@NEW_LINE#@#  
We choose the parameters such that the minima of the two types of T-cells during remission are low, so that they have a large enough probability to die out in the stochastic system.  #@NEW_LINE#@#  Since at the beginning of therapy no or only very few dedifferentiated melanoma cells are present, the population of T-cells of type zy starts growing only later.  #@NEW_LINE#@#  In order to avoid their early extinction a higher initial amount of these T-cells can be injected.  #@NEW_LINE#@#  There are now five main different scenarios in the stochastic system (see Fig 3).  #@NEW_LINE#@#  Either the T-cells of type zx (e), or the T-cells of type zy, or both of them die out.  #@NEW_LINE#@#  The latter two cases are similar to Fig 3(a,b) and thus only shown in the (SI).  #@NEW_LINE#@#  Also all populations can survive for some time fluctuating around their joint equilibrium (d).  #@NEW_LINE#@#  The fifth scenario is a cure, i.e.  #@NEW_LINE#@#  the extinction of the entire tumour due to the simultaneous attack of the two different T-cell types (f).  #@NEW_LINE#@#  T-cells and TNF- vanish since they are not produced any more in the absence of their target.  #@NEW_LINE#@#  Of course, transitions between the different scenarios are also possible, e.g.  #@NEW_LINE#@#  the system could pass from Case (d) to (e) or (a) and then to (b), see Fig 3(c).  #@NEW_LINE#@#  Furthermore, note that setting the switch from x to y to zero introduces an additional scenario: it is then possible that a relapse appears, which consists only of differentiated melanoma cells.  #@NEW_LINE#@#  
Starting from our choice of initial conditions, the deterministic system converges to , but the stochastic system can hit one of the invariant hyperplanes due to fluctuations, and is driven to different possible fixed points, see Fig 2(a).  #@NEW_LINE#@#  The transitions between the different scenarios can be seen as a metastability phenomenon.  #@NEW_LINE#@#  

Reproduction_of_experimental_observations_and_prediction_of_the_efficacy_of_the_therapy  #@NEW_LINE#@#  
The parameters of the previous subsection are chosen ad hoc to highlight the influence of randomness and the possible behaviour of the system.  #@NEW_LINE#@#  Let us now show that our models are capable to reproduce the experimental data of Landsberg et al.9 quantitiatvely.  #@NEW_LINE#@#  The choice of parameters is explained in the (SI).  #@NEW_LINE#@#  
Figure 4(a) shows the experimental data of9 whereas Fig 4(b) shows the results of our simulations.  #@NEW_LINE#@#  Each curve describes the evolution of the diameter of the tumour over time.  #@NEW_LINE#@#  In the stochastic system two situations can occur: first, the relapse consists mainly of differentiated melanoma cells and the tumour reaches its original size again after 90 days.  #@NEW_LINE#@#  This is the case if the T-cells die out.  #@NEW_LINE#@#  Second, the relapse consists mainly of dedifferentiated cells and the tumour reaches its original size again after roughly 190 days.  #@NEW_LINE#@#  This is the case if the T-cells survive the phase of remission, become active again and kill differentiated cancer cells.  #@NEW_LINE#@#  In the simulations the therapy with one type of T-cells pushes the tumour down to a microscopic level for 50 to 60 days, as in the experimental data.  #@NEW_LINE#@#  The curves marked ACT in the experimental data in Fig 4(a) are matched by simulation data when the T-cells die out (Differentiated Relapse in Fig 4(b)).  #@NEW_LINE#@#  In the experiments there might be T-cells which lose their function, e.g.  #@NEW_LINE#@#  due to exhaustion, and cannot kill the differentiated melanoma cells.  #@NEW_LINE#@#  This effect is to be seen as included in the death rate of T-cells in the model.  #@NEW_LINE#@#  They can be re-stimulated and become active again which is marked as ACT+Re in Fig 4(a).  #@NEW_LINE#@#  Although our model does not include re-stimulation, the case of surviving T-cells in the simulations (Dediff.  #@NEW_LINE#@#  Relapse in Fig 4(b)) can qualitatively be interpreted as the case of ACT+Re.  #@NEW_LINE#@#  Note that the scales of the axes are the same in both figures and that the experimental findings are met very well by the simulations.  #@NEW_LINE#@#  The simulated curves under treatment start at the beginning of the treatment and not at day zero.  #@NEW_LINE#@#  
As there is no data for the case of two T-cells, numerical simulations of such a therapy strategy should be seen as predictions.  #@NEW_LINE#@#  For the new T-cell population (of type zy) we choose the same parameters as for the first population (of type zx), just the target is different.  #@NEW_LINE#@#  The therapy seems to be very promising: almost all simulations show a cure for these parameters, only very few times a relapse occurs.  #@NEW_LINE#@#  Nevertheless, the behaviour of the system (e.g.  #@NEW_LINE#@#  the probability to end up in the different scenarios) depends strongly on the choice of certain parameters, as pointed out in the last two sections.  #@NEW_LINE#@#  In order to give a reliable prediction we need data to obtain safer estimates for the most important parameters, which seem to be the switching and therapy rates as well as initial values.  #@NEW_LINE#@#  
The initial values play an important role for the success of a therapy.  #@NEW_LINE#@#  In the case of therapy with T-cells of one specificity, increasing the initial amount of T-cells has the following effect: the melanoma cells are killed faster, the population of differentiated melanoma cells reaches a lower minimum and as a consequence the T-cells pass through a lower and broader minimum.  #@NEW_LINE#@#  The probability that the T-cells die out increases, and a differentiated relapse is more likely than in the case of a smaller initial T-cell population.  #@NEW_LINE#@#  Moreover, the broadening of the minima causes a delay and both kind of relapses (consisting mainly of differentiated or dedifferentiated cells) appear later.  #@NEW_LINE#@#  But since the extinction of T-cells is more likely, the tumour may reach its original size earlier, see Fig 5.  #@NEW_LINE#@#  For an initial value ten times as large as in Fig 4(b) the probability of an eradication of the tumour is still very small.  #@NEW_LINE#@#  If the number of T-cells initially is half the number of tumour cells, the probability of a favourable outcome is much higher.  #@NEW_LINE#@#  But such a high amount of T-cells is unrealistic.  #@NEW_LINE#@#  

Arrival_of_a_mutant  #@NEW_LINE#@#  
In this section, we consider the case of rare mutations in large populations on a timescale such that a population reaches equilibrium before a new mutant appears (i.e.  #@NEW_LINE#@#  ).  #@NEW_LINE#@#  The long-term behaviour of the standard models for adaptive dynamics is described in this limit by the Trait Substitution Sequence (see10,15) which is a Markov jump process on the trait space.  #@NEW_LINE#@#  A natural extension to the case where traits can coexist is the Polymorphic Evolution Sequence26.  #@NEW_LINE#@#  In the setting we consider here, several interesting new features arise that are so far only partially explored.  #@NEW_LINE#@#  One fundamental concept in the analysis of the stochastic population models is invasion fitness: for a given population in a stable equilibrium that populates a certain set of traits, say , the invasion fitness f(x, M) is the growth rate of a population consisting of a single individual with trait  in the presence of the equilibrium population  on M. Positive f(x, M) implies that a mutant with phenotype x has a positive probability (uniformly in K) to grow to a population of size of order K; negative invasion fitness implies that such a mutant population will die out with probability tending to one (as K).  #@NEW_LINE#@#  This notion needs to be generalised to the case when fast phenotypic switches are present.  #@NEW_LINE#@#  We sketch here how this can be done in the case of pure tumour evolutions, i.e.  #@NEW_LINE#@#  we ignore T-cells and TNF-, for more details see (SI).  #@NEW_LINE#@#  The stochastic system can be approximated by a multi-type branching process (MTBP) until the mutant population dies out or reaches a size K (for some small 0).  #@NEW_LINE#@#  MTBPs have been analyzed e.g.  #@NEW_LINE#@#  in27,28,29,30.  #@NEW_LINE#@#  If we assume that the switch rates s(pi, pj) are the transition rates of an irreducible Markov chain (the simplest example is when s(pi, pj)0, for all pipj), then the behaviour of MTBP is classified in terms of its mean matrix A.  #@NEW_LINE#@#  It is well-known that the MTBP is supercritical if and only if the largest eigenvalue 1 of A is strictly positive.  #@NEW_LINE#@#  In this case the mutant population will grow with positive probability to any desired population size before dying out.  #@NEW_LINE#@#  Thus 1 is the appropriate generalization of the invasion fitness.  #@NEW_LINE#@#  The proportions v of the mutant populations phenotypes at level K can be deduced from limit theorems for MTBP which are explained in the (SI).  #@NEW_LINE#@#  Note that this notion of invasion fitness of course reduces to the standard one if there is only one mutant phenotype.  #@NEW_LINE#@#  
Once the mutant population has reached level K, the behaviour of the process can be approximated by the solution of the corresponding deterministic system with initial value .  #@NEW_LINE#@#  If this system is attracted to the same stable fixed point for all initial values in a neighbourhood of , we are in the same situation as in26 and get a generalization of the Polymorphic Evolution Sequence.  #@NEW_LINE#@#  Observe that when the system has multiple attractors, and different points near the initial condition lie in different basins of attraction, the attractor approached by the system may be random for finite K. The characterization of the asymptotic behaviour of the system is needed to describe the final state of our stochastic process.  #@NEW_LINE#@#  This is in general a very difficult and complex problem, which is not doable analytically and will require numerical analysis.  #@NEW_LINE#@#  
Figure 6 shows examples where in a population consisting only of type (g, p) a mutation to genotype g occurs.  #@NEW_LINE#@#  g is associated to two possible phenotypes p1 and p2.  #@NEW_LINE#@#  The parameters are given in the (SI).  #@NEW_LINE#@#  

Interplay_of_mutation_and_therapy  #@NEW_LINE#@#  
In the previous section we considered the probability of invasion of a mutant when the resident population is at an equilibrium given by a stable fixed point.  #@NEW_LINE#@#  In the context of therapy, there are phases when populations shrink and regrow due to treatment and relapse phenomena.  #@NEW_LINE#@#  In the medical literature, there are frequent allusions to the possibility that such growth cycles may induce fixation of a super-resistant mutant, see e.g.5,31,32.  #@NEW_LINE#@#  It is important to understand whether and under what circumstances such effects may happen.  #@NEW_LINE#@#  Here we show an example where the appearance of a mutant genotype may indeed be enhanced under treatment.  #@NEW_LINE#@#  We consider birth-reducing competition (BRC) between tumour cells.  #@NEW_LINE#@#  In such a case, a large population at equilibrium may encounter fewer births and hence mutations, than a smaller population growing towards its equilibrium size.  #@NEW_LINE#@#  
For the sake of simplicity let the switch rates vanish.  #@NEW_LINE#@#  Consider a melanoma population (g, p) which is able to mutate to a fitter type of melanoma (g, p).  #@NEW_LINE#@#  If the competition is only of birth-reducing type, then the initial total mutation rate is .  #@NEW_LINE#@#  This is a quadratic function of .  #@NEW_LINE#@#  Without or before therapy, and before a mutant occurs,  is close to the solution of the logistic deterministic system, which is attracted to the stable equilibrium .  #@NEW_LINE#@#  The mutation rate at  is not maximal if d(p) is smaller than b(p)/2.  #@NEW_LINE#@#  Smaller populations can thus have a higher total mutation rate.  #@NEW_LINE#@#  More details are given in the (SI).  #@NEW_LINE#@#  
The interesting scaling of the mutation rate is  as K. In this case, there is a number of mutations of order one while the population grows by  individuals.  #@NEW_LINE#@#  For lower mutation rates, no mutant can be expected before the population reaches its equilibrium, while for higher rates, mutations occur unrealistically fast.  #@NEW_LINE#@#  Since for  the mutation term does not appear in the deterministic system, the difference between BRC and usual competition is invisible.  #@NEW_LINE#@#  The effects described in this section are intrinsically stochastic and happen on timescales that diverge with K.  #@NEW_LINE#@#  
During therapy, a tumour which is close to equilibrium (similar to Fig 7(b)) can shrink to a small size (similar to Fig 7(a)): the introduction of T-cells in the system lowers the population size of melanoma, and the total mutation rate in the tumour population of type (g, p) can be larger during treatment, see Fig 7(c).  #@NEW_LINE#@#  The simulations are obtained with parameters given in (SI).  #@NEW_LINE#@#  This means that treatment could lead to earlier mutations and thereby accelerate the evolution towards more aggressive tumour variants.  #@NEW_LINE#@#  


Discussion  #@NEW_LINE#@#  
Therapy resistance is a major issue in the treatment of advanced stages of cancer.  #@NEW_LINE#@#  We have proposed a stochastic mathematical model that allows to simulate treatment scenarios and applied it to the specific case of immunotherapy of melanomas.  #@NEW_LINE#@#  Comparison to experimental data is so far promising.  #@NEW_LINE#@#  The models pose challenging new mathematical questions, in particular due to the interplay of fast phenotypic switches and rare driver mutations.  #@NEW_LINE#@#  First numerical results point to a significant effect of stochastic fluctuations in the success of therapies.  #@NEW_LINE#@#  More precise experimental data will be needed in the future to fit crucial model parameters.  #@NEW_LINE#@#  While our models describe the actions of individual cells and cytokines, they do not by far resolve the full complexity of the biological system.  #@NEW_LINE#@#  In particular, they do not reflect the spatial structure of the tumour and its microenvironment.  #@NEW_LINE#@#  Also, the distinction of only two phenotypes of the tumour cells is a simplification.  #@NEW_LINE#@#  The same is true for the interaction with other immune cells and cytokines.  #@NEW_LINE#@#  This reflects on the one hand the limitation due to available experimental data, on the other hand the use of a model of reduced complexity also makes numerical computations and theoretical understanding of the key phenomena feasible.  #@NEW_LINE#@#  The rates entering as model parameters therefore have to be understood as effective parameters, e.g.  #@NEW_LINE#@#  the death rate of T-cells accounts for their natural death as well as the exhaustion phenomenon.  #@NEW_LINE#@#  In principle it is possible to increase the resolution of the model; this, however, increases the number of parameters that need to be determined experimentally which would pose a major challenge.  #@NEW_LINE#@#  Already at the present stage, the model parameters are not known well enough and are adjusted to reproduce the experimental findings.  #@NEW_LINE#@#  Some parameters that it would be very useful to see measured precisely are:  #@NEW_LINE#@#  
Nevertheless, we see the proposed model as a promising tool to assist the development of improved treatment protocols.  #@NEW_LINE#@#  Simulations may guide the choice of experiments such that the number of necessary experiments can be reduced.  #@NEW_LINE#@#  The obvious strength of our approach is to model reciprocal interactions and phenotypic state transitions of tumour and immune cells in a heterogeneous and dynamic microenvironment in the context of therapeutic perturbations.  #@NEW_LINE#@#  
The clinical importance of phenotypic coevolution in response to therapy has been recently documented in patients samples from melanomas acquiring resistance to MAPK inhibitors33.  #@NEW_LINE#@#  Adaptive activation of bypass survival pathways in melanoma cells was accompanied by the induction of an exhausted phenotype of cytolytic T cells.  #@NEW_LINE#@#  This has important implications for the combinatorial use of cancer immunotherapy (checkpoint inhibitors like anti PD-1) with respect to scheduling.  #@NEW_LINE#@#  We envision that our mathematical approach will help to integrate such patient omics data with experimental findings to guide novel strategies.  #@NEW_LINE#@#  Of note and similar to our previous study, dedifferentiation of melanoma cells was identified as a major mechanism of escape from MAPK inhibitors34,35.  #@NEW_LINE#@#  We recently dissected the molecular circuitries that control melanoma cell states and showed how melanoma dedifferentiation governs the composition of the immune cell compartment through a cytokine-based crosstalk in the microenvironment36,37.  #@NEW_LINE#@#  Hence, malignant melanoma is a paradigm for a phenotypic heterogeneous tumour and a future goal is to incorporate this increasing knowledge of melanoma cell plasticity into our method to refine its capability to model complex interactions with immune cells.  #@NEW_LINE#@#  
Importantly, phenotypic plasticity in response to therapy is a widespread phenomenon and non-small cell lung cancer (NSCLC) represents a prominent example.  #@NEW_LINE#@#  A subset of NSCLCs harbour activating mutations in the epidermal-growth factor receptor EGFR and respective small molecule inhibitors (EGFRi) are potent first line cancer drugs for this NSCLC subtype.  #@NEW_LINE#@#  However, tumours invariably relapse and genetic selection of subclones with the second site resistance mutation EGFRT790M is the major event.  #@NEW_LINE#@#  A substantial number of relapse tumours show remarkable transitions from an NSCLC adenocarcinoma to a neuroendocrine-related small cell lung cancer (SCLC) phenotype38.  #@NEW_LINE#@#  Given the recent success of immune checkpoint inhibitors in NSCLC39, it will be of clinical interest to investigate the phenotypic coevolution of immune cells in the context of NSCLC-SCLC lineage transitions.  #@NEW_LINE#@#  Again, our mathematical approach could represent a valuable tool to support this research.  #@NEW_LINE#@#  Finally, our results suggest that stochastic events play an unanticipated critical role in the dynamic evolution of tumours and the emergence of therapy resistance that requires further experimental and clinical investigation.  #@NEW_LINE#@#  

Methods  #@NEW_LINE#@#  
Our simulations are based on a Gillespie algorithm.  #@NEW_LINE#@#  All possible events, together with their occurrence times, are simulated, i.e.  #@NEW_LINE#@#  each jump of the stochastic process described in the section The model is contained in the output.  #@NEW_LINE#@#  See the pseudo-code in (SI).  #@NEW_LINE#@#  



