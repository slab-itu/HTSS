article id="http://dx.doi.org/10.1038/ncomms14836"  #@NEW_LINE#@#  
title  #@NEW_LINE#@#  
A BaSiC tool for background and shading correction of optical microscopy images  #@NEW_LINE#@#  

Abstract  #@NEW_LINE#@#  
'Quantitative analysis of bioimaging data is often skewed by both shading in space and background variation in time.  #@NEW_LINE#@#  We introduce BaSiC, an image correction method based on low-rank and sparse decomposition which solves both issues.  #@NEW_LINE#@#  In comparison to existing shading correction tools, BaSiC achieves high-accuracy with significantly fewer input images, works for diverse imaging conditions and is robust against artefacts.  #@NEW_LINE#@#  Moreover, it can correct temporal drift in time-lapse microscopy data and thus improve continuous single-cell quantification.  #@NEW_LINE#@#  BaSiC requires no manual parameter setting and is available as a Fiji/ImageJ plugin.'  #@NEW_LINE#@#  

Introduction  #@NEW_LINE#@#  
'Optical imaging is an indispensable tool in biomedical research.  #@NEW_LINE#@#  All modern optical imaging (whether whole slide imaging, high-content screening or high-throughput time-lapse microscopy) relies on image processing and quantification methods to analyse and interpret the acquired data.  #@NEW_LINE#@#  However, optical microscopy data, and especially fluorescence imaging, is often severely affected by shading or vignetting1, typically reflected as an attenuation of the brightness intensity from the centre of the optical axis to the edges.  #@NEW_LINE#@#  This not only degrades the visual quality of an image (for example, by causing discontinuities in whole slide images (WSIs)), but more critically compromises the downstream analysis of, for example, tissue composition or single-cell properties.  #@NEW_LINE#@#  Besides spatial shading effects, time-lapse movies often exhibit a temporal baseline drift due to background bleaching, which further skews the quantification of the dynamic behaviour of cellular and molecular properties2.  #@NEW_LINE#@#  ', 'The physical process of image formation can be approximated as a linear function3 that relates a measured image, Imeas(x) at location x, to its uncorrupted true correspondence, Itrue(x), as', '', 'where the multiplicative term S(x) represents the change in effective illumination across an image (known as flat-field); the additive term D(x), known as dark-field, is dominated by camera offset and thermal noise, which are present even if no light is incident on the sensor.  #@NEW_LINE#@#  ', 'Existing shading correction methods can be generally divided into two groups: prospective approaches that determine S(x) and D(x) from extra reference images4 (Supplementary Note 1) and retrospective approaches, which rely on the actual image data itself and hence avoid collection of extra reference images (Supplementary Note 2).  #@NEW_LINE#@#  A number of multi-image based approaches have been recently published, for example, Smith et al.5 (Fiji Plugin CIDRE), Coster et al.6 and Singh et al.7 (the default module in CellProfiler).  #@NEW_LINE#@#  These approaches take advantage of shared S(x) among an image sequence and are usually more reliable than single-image based corrections.  #@NEW_LINE#@#  Yet they require large numbers of images to reach a stable performance and a manual fine-tuning of internal parameters, and their robustness to common bioimage artefacts (such as dust and fluorescence dye particles) has not been tested.  #@NEW_LINE#@#  Moreover, none of the existing methods is able to model and correct temporal drift (e.g.  #@NEW_LINE#@#  caused by photobleaching) for time-lapse movies.  #@NEW_LINE#@#  ', 'We propose BaSiC, a retrospective method for background and shading correction of image sequences, based on a sparse and low-rank decomposition.  #@NEW_LINE#@#  In comparison to existing shading correction tools, BaSiC requires fewer input images, works for diverse imaging conditions and is robust against typical image artefacts.  #@NEW_LINE#@#  Moreover, it can correct temporal drift for time-lapse microscopy data, and hence improve single-cell quantification.  #@NEW_LINE#@#  BaSiC is available as an easy-to-use Fiji/ImageJ plugin as usually requires no manual parameter tuning.'  #@NEW_LINE#@#  

Results  #@NEW_LINE#@#  
'BaSiC workflow', 'Inspired by Smith et al.5, we build our method on the shading model (equation (1)), which accounts for the effect of both S(x) and D(x).  #@NEW_LINE#@#  Such a full model is superior as compared to a partial model that considers S(x) only5.  #@NEW_LINE#@#  As shown in the schematic plot of Fig 1, BaSiC first constructs a measurement matrix I (step I), which is then decomposed into a low-rank matrix IB and a sparse residual matrix IR (step II).  #@NEW_LINE#@#  The low-rank matrix has a maximum rank of two as each column is the sum of a scaled version of S(x) (with a scaling factor Bi) and D(x), which are all initialized with zeros (step III) and optimized by promoting the sparsity of the residual matrix with a reweighted L1-norm (step IV).  #@NEW_LINE#@#  In addition, smooth constraints are imposed on both S(x) and D(x) by regulating their sparsity in Fourier domain (Supplementary Fig 1).  #@NEW_LINE#@#  The optimization is solved in an iterative fashion using the linearized augmented Lagrangian method8, which is widely used in sparse matrix decomposition like Robust PCA (ref.  #@NEW_LINE#@#  9) and RASL (ref.  #@NEW_LINE#@#  10) (for a detailed description of the mathematical derivation and matrix updating see Methods and Supplementary Note 3).  #@NEW_LINE#@#  An automatic parameter setting strategy determines the smooth regularization parameters for S(x) and D(x), adaptive to different image contents, so that tedious manual parameter tuning is avoided (Supplementary Note 4).  #@NEW_LINE#@#  We provide a statistical interpretation of BaSiC in Supplementary Note 5.  #@NEW_LINE#@#  With the estimation of S(x) and D(x), we can correct the intensity profile of each image tile of a WSI by reversing the image formation process, equation (1), leading to a homogenous appearance and correct stitching (Fig 1d versus a).  #@NEW_LINE#@#  ', 'Figure 1: BaSiC is an automatic correction method for both static multi-image microscopy data and dynamic time-lapse data.  #@NEW_LINE#@#  (a) A mosaic whole slide image (WSI) of a mouse brain slice showing intensity discontinuities and resulting stitching errors (indicated by black arrows).  #@NEW_LINE#@#  (b) A time-lapse movie corrupted by both shading in space and photobleaching in time.  #@NEW_LINE#@#  (c) The BaSiC workflow, (see text for detailed explanation).  #@NEW_LINE#@#  (d) The corrected WSI shows improved stitching with no discontinuities.  #@NEW_LINE#@#  (e) BaSiC corrects both spatial shading and background bleaching over time.Full size image', 'BaSiC requires few images for shading correction', 'We first evaluate BaSiC using synthetic images, where the ground-truth of the shading-free image Itrue, the flat-field S(x) and the dark-field D(x) are known (Supplementary Note 6).  #@NEW_LINE#@#  We first compare BaSiC with CIDRE (ref.  #@NEW_LINE#@#  5), the only other method that is able to simultaneously estimate S and D. BaSiC requires far fewer images to achieve the same accuracy as CIDRE (for example, 10 versus 100 images to reach an estimation score (Sest)0.1 at three levels of cell density (cell density, Supplementary Fig 2).  #@NEW_LINE#@#  We subsequently evaluate BaSiC using a comprehensive microscope image collection provided by Smith et al.5, which includes 10 real microscopy data sets, one photography data set and one synthetic microscopy data set (refer to Smith et al.5 for data set details).  #@NEW_LINE#@#  We assess the correction quality by the correction score, (Icorr), which is the mean absolute difference of pixel pairs in overlapping image regions for each data set after correction, normalized by the difference of the uncorrected pairs5.  #@NEW_LINE#@#  A (Icorr) less_than 1 suggests reduced shading while (Icorr) greater than 1 implies increased shading compared to the uncorrected images.  #@NEW_LINE#@#  Besides CIDRE, we compare BaSiC also with the methods used in Coster6 and Cellprofiler7 (refer to Methods for technical details), as well as two prospective methods (Calib-zero and Empty-zero)5.  #@NEW_LINE#@#  We find that BaSiC improves image quality with as few as five images (Fig 2a).  #@NEW_LINE#@#  At around 100 images it matches prospective methods on average, although the performance varies for different data sets (Supplementary Fig 3).  #@NEW_LINE#@#  Among retrospective methods, BaSiC significantly outperforms existing approaches, when fewer than 500 images are used (Fig 2a).  #@NEW_LINE#@#  This is practically relevant since WSI acquisition typically contains 50200 tiles and high-content screening usually works with 96 and 384 well plates, where only images at the same position of each well share a shading profile6hence the number of images available for one estimation is 96 or 384.  #@NEW_LINE#@#  ', 'Figure 2: BaSiC requires significantly fewer images and is robust to image artefacts.  #@NEW_LINE#@#  (a) Method evaluation on benchmark data sets5.  #@NEW_LINE#@#  Correction quality is evaluated by the correction score, (Icorr), the mean absolute difference between overlapping regions after correction, normalized by the difference before correction.  #@NEW_LINE#@#  A lower correction score suggests better correction results.  #@NEW_LINE#@#  Each curve represents the average performance on 12 microscope image collections.  #@NEW_LINE#@#  For less than 500 images, BaSiC significantly outperforms other retrospective methods (P less_than 0.023, paired Wilcoxon signed rank test with Bonferrnoi correction for multiple testing).  #@NEW_LINE#@#  With  greater than 100 images, BaSiC outperforms two prospective methods (Calib-zero and Empty-zero).  #@NEW_LINE#@#  (b) Typical WSI artefacts: bright particles on the specimen that strongly emit light (spike-like artefact, top) or scatter light (bottom).  #@NEW_LINE#@#  (c) BaSiC is more robust to the spike-like artefacts as compared to CIDRE and Cellprofiler.  #@NEW_LINE#@#  Note that only BaSiC and CIDRE can estimate dark-field, while other methods simply neglect dark-field.  #@NEW_LINE#@#  (d) Surface plots show the averaged cell intensity of different spatial locations before and after shading correction of cell culture WSI.  #@NEW_LINE#@#  After BaSiC correction, the s.d.  #@NEW_LINE#@#  of the mean cell intensity over different regions is reduced to around 20% of the uncorrected s.d.  #@NEW_LINE#@#  (e) BaSiC significantly outperforms other methods on 45 WSIs of various types of biological specimen, imaged at different channels and diverse experimental settings, containing noise and artefacts.  #@NEW_LINE#@#  The estimation score, (Sest), is the mean absolute difference between the estimated Sest(x) and the prospectively obtained reference S(x), normalized by a baseline score.  #@NEW_LINE#@#  Besides achieving the minimum median score, BaSiC, unlike other methods, does not have a single outlier in all cases (refer to Supplementary Figs 58 for the individual scores for all 45 WSIs).Full size image', 'BaSiC is robust to typical image artefacts', 'Furthermore, we evaluate the robustness of the four considered retrospective methods with respect to typical image artefacts.  #@NEW_LINE#@#  One type of common artefacts in fluorescence images is bright particles that strongly fluoresce or scatter light (Fig 2b).  #@NEW_LINE#@#  BaSiC is robust to these artefacts as it incorporates them in the sparse residual without affecting the low-rank estimation of S(x) and D(x) (Fig 2c).  #@NEW_LINE#@#  By contrast, the estimated flat-fields Sest(x) from CIDRE and Cellprofiler are sensitive to outliers.  #@NEW_LINE#@#  While existing methods suffer from artefacts and inhomogeneities at the image edges, BaSiC correction leads to a homogenous distribution of mean cell intensities in a cell culture WSI over the whole slide (Fig 2d).  #@NEW_LINE#@#  Other typical artefacts are stray light and residual excitation light due to imperfect filtering, which are difficult to measure experimentally and hence difficult to correct with prospective methods (Supplementary Fig 4a).  #@NEW_LINE#@#  BaSiC incorporates such artefacts in the estimation of D(x) and can successfully correct their effect (Supplementary Fig 4b).  #@NEW_LINE#@#  A quantitative evaluation of 45 WSIs using the estimation score suggests that BaSiC achieves an accurate estimation of shading in all instances, outperforming existing retrospective methods (Fig 2e, Supplementary Figs 58).  #@NEW_LINE#@#  ', 'BaSiC corrects background variation in time-lapse movies', 'Finally, we apply BaSiC to improve single-cell quantification of long-term time-lapse microscopy.  #@NEW_LINE#@#  We decompose the shading-free true image (x) of the ith frame of a time-lapse microscopy movie into the sum of a spatially-constant baseline signal, Bi, and the spatially varying foreground (fluorescence) signal of biological relevance6.  #@NEW_LINE#@#  Hence the full model for a time-lapse movie becomes:', '', 'Because of background bleaching and varying experimental conditions, Bi is usually not constant between frames (Fig 1b).  #@NEW_LINE#@#  We correct the intensity profile of each frame using the estimated S(x), D(x) and Bi by reversing equation (2), which removes both spatial shading effects and the temporal drift (Fig 1e versus b).  #@NEW_LINE#@#  ', 'Continuous monitoring of single-cell differentiation dynamics is an important research tool for stem cell research11.  #@NEW_LINE#@#  Besides improving image contrast at the plate edge, BaSiC is able to remove intensity spikes for bright-field images and photo bleaching of the background medium in the fluorescence channel (Supplementary Fig 9, Supplementary Movies 1 and 2).  #@NEW_LINE#@#  We apply BaSiC on 6 day time-lapse movies of hematopoietic stem and progenitor cells that differentiate towards the granulocyte-macrophage (GM) lineage and the megakaryocyte-erythrocyte (MegE) lineage (Fig 3a, see Hoppe et al.12 for experimental details).  #@NEW_LINE#@#  The dynamic expression of the transcription factor PU.1 has been quantified in cells over many generations.  #@NEW_LINE#@#  The BaSiC-corrected intensity profile illustrates a 25-fold increase of PU.1 intensity for GM cells at the onset of the lineage marker CD16/32 (Fig 3b).  #@NEW_LINE#@#  In contrast, PU.1 levels stay roughly constant in MegE cells, when the onset of the lineage marker Gata1 is observed (Fig 3c).  #@NEW_LINE#@#  Importantly, the uncorrected intensity profiles exhibit no obvious change in PU.1 behaviour for the two lineages.  #@NEW_LINE#@#  When comparing GM versus MegE branches a significant (P=1.2 × 103, Wilcoxon rank-sum test, Fig 3d) fold-change in PU.1 expression is only observable after BaSiC correction.  #@NEW_LINE#@#  ', 'Figure 3: Single-cell quantification of time-lapse data is significantly improved after BaSiC correction.  #@NEW_LINE#@#  (a) Hematopoietic stem and progenitor cells can differentiate into two different lineages (GM or MegE).  #@NEW_LINE#@#  (b,c) PU.1 expression along two exemplary cellular branches, one committing to the GM lineage signified by CD16/32 onset (b) and the other committing to the MegE lineage signified by Gata1 onset (c).  #@NEW_LINE#@#  The BaSiC-corrected intensity profiles (red) show a PU.1 upregulation in the GM lineage prior to CD16/32 onset, but not in the MegE lineage.  #@NEW_LINE#@#  The uncorrected profiles (black) suffer from shading, temporal drift and noise.  #@NEW_LINE#@#  Bright-field, PU.1, CD16/32 and Gata1 image patches of each cell in the branch after BaSiC correction are shown on top (scale bar, 10 m).  #@NEW_LINE#@#  (d) The BaSiC-corrected PU.1 intensity fold change (right bars) between marker onset and start of the movie (averaged over 6 h) suggests that GM cell branches show a significant (n=99, P=0.0012, Wilcoxon rank-sum test) PU.1 upregulation in contrast to MegE cell branches (n=49).  #@NEW_LINE#@#  This is not observable in the uncorrected fold changes (left bars).Full size image'  #@NEW_LINE#@#  

Discussion  #@NEW_LINE#@#  
'BaSiC is an efficient tool for image correction and can be applied to high-content images, WSIs and high-throughput time-lapse movies.  #@NEW_LINE#@#  BaSiC has immediate attraction to researchers who create stitched images, since correcting uneven illumination improves stitching and mosaic image quality.  #@NEW_LINE#@#  Besides, BaSiC can be also used as a pre-processing step in conjunction with automatic methods such as cell counting or measuring the morphology of cells and thus improving down-stream analysis.  #@NEW_LINE#@#  The crucial contribution of BaSiC is to improve intensity quantification in both static and time-lapse imaging data.  #@NEW_LINE#@#  Unlike local contrast equalization methods, which could distort the true intensity variations within an original image or across multiple images, BaSiC is built on solid physical models of optical imaging and hence is able to recover biologically relevant intensities for image quantification.  #@NEW_LINE#@#  Besides of being accurate, BaSiC is also fast to compute: in our Fiji implementation, it usually processes hundreds of images within minutes on a standard laptop.  #@NEW_LINE#@#  ', 'From a methodological point of view, there are two key differences between BaSiC and the state-of-the-art shading correction tools that also model flat-field S(x) and dark-field D(x).  #@NEW_LINE#@#  The first distinctive feature of BaSiC is the reweighted L1-norm error measure, which allows for a quicker convergence when dealing with limited amount of images and, more importantly, results in increased resistance to outliers in data such as noise or debris.  #@NEW_LINE#@#  Besides S(x) and D(x), BaSiC can also estimate a per-image baseline Bi, which accounts for varying background in time-lapse movies.  #@NEW_LINE#@#  This correction of background bleaching is a unique feature of BaSiC that CIDRE and other existing methods cannot provide.  #@NEW_LINE#@#  ', 'As any shading correction method, BaSiC has limitations.  #@NEW_LINE#@#  One key assumption of BaSiC and all other previously mentioned multi-image based retrospective methods is that the foreground of every image to be processed should be uncorrelated with the foreground of every other image.  #@NEW_LINE#@#  This assumption can be violated for time-lapse movies of static and quasi-static objects, for example, for a single-cell of high-magnification that is always in the centre of the field of view.  #@NEW_LINE#@#  In such cases, BaSiC would consider the consistently higher image intensities in the centre of the field of view as a local increase in S(x), causing removal of the true fluorescence variability.  #@NEW_LINE#@#  Nevertheless in practice, BaSiC has some tolerance to such correlations, for example, it performs well in a movie of proliferating and slowly moving embryonic stem cell colonies (as shown in Supplementary Movie 2), in which consecutive frames are correlated.  #@NEW_LINE#@#  Meanwhile, the regularization parameter s (see Methods) can be used to tune the resulting model so that it is more suitable for correlated images.  #@NEW_LINE#@#  Larger values of s lead to a smoother estimation of the low-rank component, thus rejecting small static objects in the estimated S(x).  #@NEW_LINE#@#  Another useful strategy is to take samples with a large time gap in between to make images less correlated.  #@NEW_LINE#@#  In any case, we advise users to visually inspect the estimated shading profiles before making a correction in such challenging cases: a smooth S(x) usually indicates a good shading correction, while local inhomogeneities that come from highly corrected foreground objects are a hint of non-optimal correction.  #@NEW_LINE#@#  ', 'Although BaSiC can compensate background variation, no matter if it is caused by bleaching or by switching microscopy settings, it does not account for variation in the foreground sample fluorescence that may also occur due to photobleaching.  #@NEW_LINE#@#  In the presented long-term single-cell time-lapse measurements, the dominant corrupting factor is the background variation caused by medium bleaching.  #@NEW_LINE#@#  Hence subtraction of background bleaching greatly improves the intensity quantification of single cells (as shown in Fig 3).  #@NEW_LINE#@#  In fact, existing photobleaching correction methods (such as the Bleaching Correction Plugin in Fiji/ImageJ) are not suitable for correcting foreground cell bleaching in our movies: these methods either assume constant intensity or stable intensity distribution of each frame, which is certainly not the case for transcription factor expression during cell differentiation, where the signal varies depending on the cell type and time.  #@NEW_LINE#@#  It should also be noted that for fluorescence images, the estimated baseline can converge to the foreground, when the foreground fraction of an image is  greater than 50%.  #@NEW_LINE#@#  This does not affect the practical usage of BaSiC, when a high-cell density is reached only at the end of a movie.  #@NEW_LINE#@#  Typically then, the bleaching effect is already weak (bleaching usually decays exponentially), and hence the correction for those frames can be skipped.  #@NEW_LINE#@#  By contrast, for bright-field images, BaSiC is robust to different levels of cell density in background correction.  #@NEW_LINE#@#  ', 'With the limitations addressed above in mind, we believe that BaSiC will help to standardize the processing and quantification of bioimage data due to its broad applicability, robust performance, elegant mathematical formulation and easy-to-use interface.'  #@NEW_LINE#@#  

Methods  #@NEW_LINE#@#  
'Shading model and optimization', 'A measured image sequence, Imeas=(x), ..., (x), can be related to its uncorrupted true correspondence, Itrue=I1true(x),...,Intrue(x), with a multiplicative flat-field S(x) and an additive dark-field D(x):', '', 'The BaSiC correction begins by sorting the image sequence Imeas into Isort by intensities at each pixel x, converting each sorted image (x) into a column vector  (from now on, we denote the same parameter in image space with (x) and as vector without (x)).  #@NEW_LINE#@#  Hence, we construct the measurement matrix as', '', 'Each column vector of the measurement matrix I is decomposed into', '', 'where Bi is a location independent scalar and Ri is the residual.  #@NEW_LINE#@#  The sum of the first two terms forms a rank 2 matrix,  ( and  denote column-wise multiplication and addition, respectively), as all columns share the same S and D. The residual matrix, IR, is assumed to be sparse, that is, the residual (x) generally occupies only a small fraction of image pixels.  #@NEW_LINE#@#  Assuming sparsity of IR, we have the following constraint optimization problem:', '', 'where | |0 denotes the L0-norm, that is, the number of non-zero elements in IR.  #@NEW_LINE#@#  ', 'A direct optimization of equation (5) is impossible since it has no unique mathematical solution (suppose D* is one solution, then  is another solution).  #@NEW_LINE#@#  Besides, the minimization of an L0-norm is NP-hard13.  #@NEW_LINE#@#  Hence, we adapt the objective function by imposing regularization on S and D, and replace the L0-norm by a reweighted L1-norm minimization:', '', 'where the dark-field D is decomposed into the sum of its mean DZ and the residual DR. W is the weighting matrix which balances the penalty of large coefficients and small coefficients and hence better approximates the L0-norm14.  #@NEW_LINE#@#  The detailed setting of W, the mathematical derivation of equations (4, 5, 6) and the numerical solution of equation (6) are included in Supplementary Note 3.  #@NEW_LINE#@#  We have developed a strategy to automatically determine the regularization parameters, s and d, adaptive to different image content, so that tedious manual parameter tuning is avoided (Supplementary Note 4).  #@NEW_LINE#@#  We also provide a statistical interpretation of BaSiC in Supplementary Note 5.  #@NEW_LINE#@#  With the estimated S(x) and D(x), we can invert the image formation process and obtain corrected image:', '', 'After sorting intensities, the estimated Bi alongside S(x) and D(x) is no longer the baseline of the original images.  #@NEW_LINE#@#  Hence, we introduce a two-step strategy to estimate Bi: the first step is to compute S(x) and D(x) only, using the matrix with sorted intensities; in the second step, we estimate Bi using the unsorted matrix, I=, ...,  and the estimated S(x) and D(x) from step 1 as model inputs.  #@NEW_LINE#@#  Hence the optimization problem becomes:', '', 'where S* and D* are the solutions of equation (6) using sorted images.  #@NEW_LINE#@#  In comparison to equation (6), solving equation (8) numerically is much faster, due to a reduced degree of freedom.  #@NEW_LINE#@#  This is practically beneficial as it can reduce the computational complexity in the background correction of long-term time-lapse movies of many frames (details are provided in Supplementary Note 3).  #@NEW_LINE#@#  With the estimation of S(x), D(x) and Bi, the correction of a time-lapse movie will be:', '', 'where Bnorm is an arbitrarily chosen background.  #@NEW_LINE#@#  In practices, we set Bnorm=meani(Bi) for bright-field movies to ensure that the BaSiC-corrected movie is in the same intensity range as the raw movie.  #@NEW_LINE#@#  As for fluorescence movies, we can use Bnorm=0 to remove the background signal.  #@NEW_LINE#@#  ', 'Microscopy data sets', '45 WSIs of four types of specimens used often in biological investigations were collected using a Nikon Ti microscope: four fluorescence WSIs of mouse brain sections, three fluorescence WSIs of mouse kidney sections (Molecular Probes FluoCells Prepared Slide #3), four fluorescence WSIs of tissue culture cells (Molecular Probes FluoCells Prepared Slide #2), and four bright-field WSIs of H&E stained tissue section, each in three different channels.  #@NEW_LINE#@#  Images were acquired with a × 10/0.45 NA Plan Apochromat objective using a Lumencor SpectraX light source for excitation and emission filters for DAPI, Fluorescein and Cy3.  #@NEW_LINE#@#  The microscope was controlled by Manager15.  #@NEW_LINE#@#  Each WSI contains 50200 image tiles and is stitched using Grid-wise stitching Plugin in Fiji16 before and after intensity collection.  #@NEW_LINE#@#  For each data set, we also acquire reference images for the flat-field S(x) using a concentrated fluorescent dye solution (Supplementary Note 1), and the dark-field D(x) with no light entering the camera.  #@NEW_LINE#@#  For brain and cell specimens at Cy3 channel, we observed an additive light in the image background, which can be due to residual excitation light or stray light but not captured in the dark-field calibration.  #@NEW_LINE#@#  Details of all WSIs and the corresponding corrections are included in Supplementary Figs 58.  #@NEW_LINE#@#  ', 'Besides the above WSIs, the microscopy data sets used in this study also include: (i) 6,000 synthetic images with three different levels of cell density (Supplementary Note 6); (ii) The image collection used in CIDRE (ref.  #@NEW_LINE#@#  5) including 10 real microscopy data sets, one photography data set and one synthetic microscopy data set; (iii) One long-term (6 days) time-lapse movie (one bright-field and three fluorescence channels) of hematopoietic stem and progenitor cells (Hoppe et al.12), which contain 7,000 bright-field frames (acquired every 2 min) and 320 fluorescence frames for each fluorescence channel (acquired every 30 min).  #@NEW_LINE#@#  ', 'Baseline shading correction methods', 'We compare BaSiC to three state-of-the-art retrospective methods and three prospective methods for shading correction.  #@NEW_LINE#@#  Each method is summarized below:', 'CIDRE (ref.  #@NEW_LINE#@#  5) is recently published state-of-the-art illumination correction method5, as it achieves the best performance among 13 shading correction methods.  #@NEW_LINE#@#  CIDRE can estimate both S(x) and D(x) and hence does not require any reference images.  #@NEW_LINE#@#  Yet the simultaneous estimation of two unknown parameters is not stable when the available images are limited or when images are corrupted with spike-like noise.  #@NEW_LINE#@#  ', 'The background correction module in the software package CellProfiler7 approximates S(x) using the mean image intensity computed at every location and subsequently smoothed by a median filter of a user defined kernel size (we use a kernel size of 20% of the image size).  #@NEW_LINE#@#  D(x) is neglected in CellProfiler.  #@NEW_LINE#@#  ', 'Coster et al.6 proposed a shading correction method for high-throughput microscopy6.  #@NEW_LINE#@#  It first subtracts D(x), required to be obtained via a prospective method, from all images and approximates S(x) using the median image intensity computed at every location after subtraction.  #@NEW_LINE#@#  In our implementation, we further smooth S(x) with a median filter (kernel size is 20% of the image size, which is found to be optimal).  #@NEW_LINE#@#  Strictly speaking, Coster is not a complete retrospective method, as the calibration of D(x) is needed for correction.  #@NEW_LINE#@#  ', 'Calib-zero5 is a prospective method which approximates the flat-field S(x) as the average of images of a plastic fluorescent reference slide17.  #@NEW_LINE#@#  The dark-field D(x) is modelled by averaging images with the shutter closed or the light source turned off or otherwise blocked.  #@NEW_LINE#@#  The major drawback of this method is that the reference slides often have a different thickness as compared to real histology slides, which makes the approximation of S(x) inaccurate (Supplementary Note 1).  #@NEW_LINE#@#  ', 'Empty-zero5 is another prospective method that approximates the flat-field S(x) as the average of images of empty images taken at various locations18.  #@NEW_LINE#@#  The calibration of the dark-field D(x) is same as in Calib-zero.  #@NEW_LINE#@#  This method is appropriate for bright-field images or fluorescence images when the medium fluoresces5 but will be not applicable for images without a medium.  #@NEW_LINE#@#  Both the correction of Calib-zero and Empty-zero are obtained from Smith et al.5 alongside the data.  #@NEW_LINE#@#  ', 'Concentrated dye solution approximates the flat-field S using images of a thin layer of concentrated dye4.  #@NEW_LINE#@#  The calibration of the dark-field D(x) is same as in the above two prospective approaches.  #@NEW_LINE#@#  This method is usually more accurate than Calib-zero as it has a similar thickness to real specimens (Supplementary Note 1).  #@NEW_LINE#@#  In our study, we use the concentrated dye solution as the ground-truth to evaluate our correction of WSI.  #@NEW_LINE#@#  ', 'Evaluation protocol', 'For synthetic data, where the ground-truth S(x), D(x), and the true shading-free images, (x), are available, we quantify the error of the estimated flat-field, Sest(x), the estimated dark-field, Dest(x), and the corrected image, Icorr(x) with a score, , defined as the mean absolute deviation between the estimation/correction and the ground-truth, normalized by a baseline difference (the baseline for S(x), D(x), and Icorr(x) is a uniform flat-field, zero dark-field and uncorrected image Imeas(x), respectively):', '', 'The score  is in the interval 0, ), where 0 indicates perfect estimation/correction, 1 indicates the same amount of error as the uncorrected images, and  greater than 1 indicates greater disagreement.  #@NEW_LINE#@#  ', 'For real microscopy images where the ground truth is not available, a thorough evaluation of a shading correction method is not trivial.  #@NEW_LINE#@#  There are generally two different approaches in the literature to measure the shading correction quality.  #@NEW_LINE#@#  The first approach uses the prospectively obtained S as a reference and quantifies the error to a retrospectively estimated S(x) (for example in Coster et al.6).  #@NEW_LINE#@#  One key challenge of such a validation is how to acquire a reliable reference S(x).  #@NEW_LINE#@#  Generally, identical microscope settings, similar specimen thickness, and averaging of multiple reference images (or taking the median to be robust to outliers) improve the accuracy of the reference.  #@NEW_LINE#@#  In our study, we examine the reliability of our prospectively obtained reference S(x) by inspecting the smoothness of the shading-corrected WSI using S(x).  #@NEW_LINE#@#  Taking the reference S(x) as the ground-truth, we can quantitatively measure the performance of a retrospective method using the estimation score, (Sest).  #@NEW_LINE#@#  The second type of evaluation is based on a correction score5.  #@NEW_LINE#@#  In real images where the ground-truth, shading-free images are unavailable, the correction score, (Icorr), is based on the absolute difference between pairs of overlapping, corrected images (x) and (x) that are precisely aligned, normalized by the benchmark error of the uncorrected image pairs, (x) and (x), as:', '', 'This approach avoids the collection of reference images, yet a perfect correction for real images is impossible, as the disagreement between overlapping images includes many other sources besides uneven illumination, such as noise, alignment error, and photobleaching (the second image, (x), of the image pair usually has a lower signal than the first one, (x), due to the bleaching of fluorescence dyes even without shading).  #@NEW_LINE#@#  In CIDRE (ref.  #@NEW_LINE#@#  5), an extra intensity normalization process is involved, which normalizes the median and the s.d.  #@NEW_LINE#@#  of image pair before and after correction, that is, (x),  to the reference (x).  #@NEW_LINE#@#  However, we do not include any extra normalization process in our study, as an intensity normalization between the uncorrected pairs will affect the assessment of shading correction.  #@NEW_LINE#@#  Nevertheless, the scores we obtained without normalization (Fig 2a, Supplementary Fig 3) are very similar to those reported in CIDRE (ref.  #@NEW_LINE#@#  5).  #@NEW_LINE#@#  ', 'Data and software availability', 'BaSiC is available as a Fiji/ImageJ Plugin from the Fiji/ImageJ update site http://sites.imagej.net/BaSiC/ and from our software website https://www.helmholtz-muenchen.de/icb/research/groups/quantitative-single-cell-dynamics/software/basic/index.html, where we also provide five different microscopy data sets used in the manuscript to demonstrate the usage of BaSiC.  #@NEW_LINE#@#  See also Supplementary Note 7 for installation, usage details and practical tips.'  #@NEW_LINE#@#  


