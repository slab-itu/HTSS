article id="http://dx.doi.org/10.1038/NCOMMS10063"  #@NEW_LINE#@#  
title  #@NEW_LINE#@#  
Rapid antibiotic-resistance predictions from genome sequence data for Staphylococcus aureus and Mycobacterium tuberculosis  #@NEW_LINE#@#  

Abstract  #@NEW_LINE#@#  
'The rise of antibiotic-resistant bacteria has led to an urgent need for rapid detection of drug resistance in clinical samples, and improvements in global surveillance.  #@NEW_LINE#@#  Here we show how de Bruijn graph representation of bacterial diversity can be used to identify species and resistance profiles of clinical isolates.  #@NEW_LINE#@#  We implement this method for Staphylococcus aureus and Mycobacterium tuberculosis in a software package (Mykrobe predictor) that takes raw sequence data as input, and generates a clinician-friendly report within 3 minutes on a laptop.  #@NEW_LINE#@#  For S. aureus, the error rates of our method are comparable to gold-standard phenotypic methods, with sensitivity/specificity of 99.1%/99.6% across 12 antibiotics (using an independent validation set, n=470).  #@NEW_LINE#@#  For M. tuberculosis, our method predicts resistance with sensitivity/specificity of 82.6%/98.5% (independent validation set, n=1,609); sensitivity is lower here, probably because of limited understanding of the underlying genetic mechanisms.  #@NEW_LINE#@#  We give evidence that minor alleles improve detection of extremely drug-resistant strains, and demonstrate feasibility of the use of emerging single-molecule nanopore sequencing techniques for these purposes.'  #@NEW_LINE#@#  

Introduction  #@NEW_LINE#@#  
'The marked increase in antibiotic use in health care and agriculture since the 1940s has driven a rise in frequency of drug-resistant bacterial strains, which now present a global threat to public health.  #@NEW_LINE#@#  Clinical isolates resistant to most drugs have now been seen for many species including Mycobacterium tuberculosis, Enterococcus faecium, Staphylococcus aureus, Klebsiella pneumoniae, Neisseria gonorrhoeae, Acinetobacter baumannii and Pseudomonas aeruginosa1.  #@NEW_LINE#@#  Antimicrobial susceptibility testing is therefore now central to the treatment of serious bacterial infections diagnosed by culture, and is used to determine the protocols for first-line antibiotic use when culture is not available.  #@NEW_LINE#@#  At present, phenotyping tests take at least 12 days to complete for rapidly growing bacteria such as S. aureus, and can take weeks in slow-growing bacteria such as M.  #@NEW_LINE#@#  tuberculosis.  #@NEW_LINE#@#  ', 'Microbial genome sequencing has the potential to substantially increase the speed of antibiotic resistance detection for many pathogens2 and in addition provides valuable information on relatedness that could contribute to surveillance.  #@NEW_LINE#@#  The key biological constraint is the extent of our understanding of the genotype-to-phenotype correspondencethat is, the genotype needs to be sufficiently predictive of resistance.  #@NEW_LINE#@#  Increasingly, this correspondence is high for many bacterium/drug combinations.  #@NEW_LINE#@#  For example, Gordon et al.3 recently demonstrated that a curated panel of mutations and genes known to cause drug resistance in S. aureus was sufficient to predict resistance for 12 antibiotics with a sensitivity of 97% and specificity of 99%.  #@NEW_LINE#@#  Thus, at least for one species, a genotype-based method could deliver results with accuracy suitable for use in a clinical laboratory.  #@NEW_LINE#@#  ', 'We set out to develop methods applicable to standard clinical samples, and solve the multiple computational challenges that act as barrier to routine and rapid deployment of such a system in clinical practice.  #@NEW_LINE#@#  These challenges include not only the need to determine species and predict resistance, but also developing a framework extensible to many species, and ensuring accessibility of the tool to a user base who may be unskilled in bioinformatics.  #@NEW_LINE#@#  Furthermore, although clinical samples currently undergo protocols that tend to remove diversity (for example, blood culture for S. aureus and solid/liquid culture for M. tuberculosis), future developments to reduce bed-to-diagnosis time will surely involve reductions in culture time, and potentially increase the levels of diversity in the sample.  #@NEW_LINE#@#  Thus we set out to build a system robust to mixture, and to establish whether an appreciable proportion of phenotypic resistance was explained by low-frequency alleles.  #@NEW_LINE#@#  ', 'Methods using genome sequence data for species identification range from the specific4 to the sensitive5, but generally performance is measured globally in terms of detection of species presence.  #@NEW_LINE#@#  However, for clinical use we need considerable flexibility in tuning sensitivity and specificity for different species, potentially weighted to minimize clinical risk.  #@NEW_LINE#@#  For example, there may be a species associated with high mortality (for example, S. aureus) that can occur in samples mixed with other species (for example, coagulase-negative staphylococci (CoNS), which are common contaminants of blood cultures, being present on the skin through which the blood was taken), and that may even share the same resistance genes and thus confound inference.  #@NEW_LINE#@#  ', 'Various methods have been used for genotyping resistance features: mutations and genes have been detected by whole-genome assembly3, genes by assembly and BLAST6, or single nucleotide polymorphisms (SNPs) and indels by mapping7,8.  #@NEW_LINE#@#  These methods have been demonstrated to have adequate performance in some circumstances.  #@NEW_LINE#@#  However, traditional whole-genome bacterial assembly is fundamentally based on the assumption that all data comes from a single haploid genome9, and so is ill-suited for mixed samples, and mapping to a single-reference results in error rates that depend on genetic distance of the sample from the reference10.  #@NEW_LINE#@#  There are pre-existing tools for expert users that incorporate resistance prediction6,11,12, none of which handle the issue of contaminating related species in clinical samples, or minor cloneswe include comparative data below.  #@NEW_LINE#@#  ', 'Here we aim to move beyond proof-of-concept of how sequencing might work in the clinic, to a general framework for genotype-based antimicrobial-resistance prediction, with concrete implementations for two species where drug resistance is of global concern: S. aureus and M. tuberculosis.  #@NEW_LINE#@#  The user should be able to obtain a report interpretable by a clinician by simple drag-and-drop of raw sequence data file.  #@NEW_LINE#@#  We evaluate extensively against clinical gold standards using current (Illumina) sequence data, including the impact of minor population detection.  #@NEW_LINE#@#  We notice that minor alleles improve ability to distinguish multi-drug resistant (MDR) from extensively drug-resistant (XDR) tuberculosis.  #@NEW_LINE#@#  We demonstrate that our method also works with an emerging strand-sequencing technology (Oxford Nanopore Technologies (ONT), MinION), giving perfect concordance with phenotype after just 7 h of sequencing, both for SNP-based and gene-based resistance.  #@NEW_LINE#@#  Finally, we discuss what is needed to apply our framework to other species.'  #@NEW_LINE#@#  

Results  #@NEW_LINE#@#  
'Using population genome graphs for genotyping', 'We show in Fig 1a a cartoon of the genetic diversity in a bacterial species and two options for building a reference variation structure.  #@NEW_LINE#@#  In option (i) we show the standard approach, where we select an arbitrary strain (strain 1) to be the reference genome, along with one copy of each plasmid gene.  #@NEW_LINE#@#  In this work we have developed an alternate approach, shown in option (ii).  #@NEW_LINE#@#  We start with a curated knowledge base of resistant/susceptible alleles, and assemble a de Bruijn graph13 of them on different genetic backgrounds, along with many examples of resistance genes.  #@NEW_LINE#@#  This forms our reference graph.  #@NEW_LINE#@#  In Fig 1b we show the corresponding analyses of a mixed sample.  #@NEW_LINE#@#  The traditional approach is shown in option (i), whereby sequence reads are mapped to the reference genome and genes, requiring the mapping and inference to cope with the divergence between sample strains and the reference.  #@NEW_LINE#@#  Our approach (option (ii)) directly compares the de Bruijn graph of the sample with the reference graph.  #@NEW_LINE#@#  This results in statistical tests for the presence of resistance alleles that are unbiased by choice of reference or assumptions of clonality.  #@NEW_LINE#@#  Moreover, these tests will improve as the catalogue of diversity in the species grows.  #@NEW_LINE#@#  Our approach is implemented in a software application called Mykrobe predictor.  #@NEW_LINE#@#  See Methods section for details.  #@NEW_LINE#@#  ', 'Figure 1: Representation and analysis of bacterial genetic variation.  #@NEW_LINE#@#  (a) Reference construction methods.  #@NEW_LINE#@#  Left: chromosomes with SNPs (black circles) and genes (coloured blocks) from strains of a bacterial species.  #@NEW_LINE#@#  Option (i) picks strain 1 to be reference, plus one example of each plasmid resistance gene.  #@NEW_LINE#@#  In option (ii), our method is to build the de Bruijn graph of all strains, restrict to loci of interest, and annotate resistance (red) and susceptible (green) alleles.  #@NEW_LINE#@#  For SNPs, local graph topology is determined by adjacent SNPs (black dots) and indels (black blocks).  #@NEW_LINE#@#  (b) Mixed infection read analysis.  #@NEW_LINE#@#  Left: sequence data from a clinical sample harbouring major (90%) and minor (10%) strains.  #@NEW_LINE#@#  Right: option (i) maps the reads to the reference genome to detect SNPs and genes.  #@NEW_LINE#@#  In option (ii), our approach, we construct the de Bruijn graph of the sample and compare with the reference graph.  #@NEW_LINE#@#  We see a specific SNP is present both in the sample and the reference graph (marked X, Y).  #@NEW_LINE#@#  Both the resistant (red) and susceptible (green) alleles are present in the sample, and within-sample frequency is estimated from sequencing depth on each allele.Full size image', 'S.  #@NEW_LINE#@#  aureus species identification', 'All the data sets in this study are Illumina sequence data sets, and are described in Methods section, Supplementary Fig 1 and Supplementary Table 1.  #@NEW_LINE#@#  We designed several panels of probes for detection of S. aureus, S. epidermidis, S. haemolyticus or other CoNS (see Methods section for details).  #@NEW_LINE#@#  We then evaluated our predictions on a separate validation set (St_B), combining 471 S. aureus samples (St_B1, Supplementary Data 3), and 221 CoNS (St_B2, Supplementary Data 4) and show the results in Fig 2a.  #@NEW_LINE#@#  This confirmed an appropriately low rate of missing a true S. aureus sample (0/492, upper 97.5% confidence interval 0.7%).  #@NEW_LINE#@#  We studied the three non-S. aureus samples that appeared to be misclassified by Mykrobe predictor as S. aureus, and concluded that they were mis-labelled in the National Center for Biotechnology Informations Short Read Archive (SRA), as both BLAST and OneCodex ( http://beta.onecodex.com) agreed with Mykrobe predictor that these were S. aureus.  #@NEW_LINE#@#  We also created 540 in silico mixtures of S. epidermidis/S.  #@NEW_LINE#@#  aureus and S. haemolyticus/S.  #@NEW_LINE#@#  aureus (simulation 1) and correctly detected presence of S. epidermidis and S. haemolyticus minor infections in 100% of cases at frequencies above 0.7% (see Supplementary Fig 2 and Methods section).  #@NEW_LINE#@#  ', 'Figure 2: Species and susceptibility predictions for S.  #@NEW_LINE#@#  aureus.  #@NEW_LINE#@#  (a) Species classification results on species validation set St_B (n=692).  #@NEW_LINE#@#  Red shading of box indicates errors we wish to minimize.  #@NEW_LINE#@#  S.aur, S. aureus; S.epi, S. epidermidis; S.hae, S. haemolyticus; O.st, other staphylococcus; Non-st, non staphylococcal.  #@NEW_LINE#@#  Truth (SRA) is the species as annotated in the SRA metadata, which was used as truth for comparisons.  #@NEW_LINE#@#  (b) Phylogeny of S. aureus samples used in evaluating resistance prediction, with tips marked orange or blue to represent samples in training set (St_A1, n=495) or validation set (St_B1, n=471).  #@NEW_LINE#@#  Drug resistance is indicated in concentric rings around the phylogenetic tree; plasmid-mediated resistance (erythromycin in purple, tetracycline in black) is distributed across the whole tree.  #@NEW_LINE#@#  The two multi-drug resistant clades are in UK hospital clonal complexes CC22 and CC30.  #@NEW_LINE#@#  (c) Proportion of resistant S. aureus samples (St_B1) correctly identified as resistant by Mykrobe predictor (orange), disc test (dark blue) and Phoenix (light blue) compared with consensus, with false negatives in red.  #@NEW_LINE#@#  Note the break in the y axis between 80 and over 300 to show penicillin on same plot.  #@NEW_LINE#@#  (d) As c, but showing proportion of susceptible samples correctly identified as susceptiblefalse positives in red.  #@NEW_LINE#@#  A small number of failed disc tests for fusidic acid in panel c result in a lower bar.  #@NEW_LINE#@#  PEN, penicillin; ERY, erythromycin; CIP, ciprofloxacin; METH, methicillin; FUS, fusidic acid; CLIN, clindamycin; TET, tetracycline; RIF, rifampicin; GEN, gentamicin; MUP, mupirocin; TRIM, trimethoprim; VAN, vancomycin.Full size image', 'Comparing S. aureus predictions with consensus phenotype', 'We used a training set (St_A1) of 495 and a validation set (St_B1) of 471 S. aureus isolates that had been sequenced and phenotyped after being collected in Oxfordshire, UK (samples and phenotyping described in Methods section, Supplementary Fig 1; accession codes and phenotyping data are given in Supplementary Data 1 and 3).  #@NEW_LINE#@#  We show in Fig 2b a phylogeny (construction described in Methods section) of these samples, showing that both the training set (orange tips of tree) and validation set (blue) are distributed across the entire phylogeny.  #@NEW_LINE#@#  We also confirmed that, although enriched for the S. aureus clonal complexes seen in UK hospitals (CC22/CC30), all major clonal complexes were represented (Supplementary Fig 3).  #@NEW_LINE#@#  A subset of these samples (n=94) has been compared in a previous publication with international clinical strains (US, UK, Japan and Australia), animal-associated strains (bovine, ovine and poultry) and historic clinical strains (1943, 1952 and 1960) to show that Oxfordshire S. aureus diversity, while not exhaustive, broadly recapitulates that of the world14.  #@NEW_LINE#@#  ', 'All validation samples were phenotyped using two methods: a British Society for Antimicrobial Chemotherapy (BSAC) disc test15 and the Phoenix automated microbiology system (BD Biosciences, Sparks, MD, USA), except for trimethoprim, for which only disc testing was performed.  #@NEW_LINE#@#  A consensus phenotype was defined to be either that called by disc/Phoenix where they agreed, or the result of an Etest and/or nitrocefin (for penicillin) where disc and Phoenix were discrepant.  #@NEW_LINE#@#  This allowed us to estimate error rates for disc and Phoenix as well as for Mykrobe predictor.  #@NEW_LINE#@#  ', 'Considering each resistance mutation and gene in turn, our prediction algorithm first genotypes a sample into one of three categories: clonal susceptible, minor frequency-resistant allele, or major frequency-resistant allele.  #@NEW_LINE#@#  It then predicts a resistant phenotype for samples containing resistant alleles of sufficiently high frequency, where sufficiently high is estimated using the training set.  #@NEW_LINE#@#  Note that for antibiotics where resistance is mediated by genes on variable copy-number plasmids (erythromycin and tetracycline) a minor population with high copy number of a resistance-carrying plasmid may sometimes be called as major resistant.  #@NEW_LINE#@#  After using the training data set to estimate parameters for our statistical model (see Methods section, and for results on training set, see Supplementary Table 2), we applied Mykrobe predictor to the validation set.  #@NEW_LINE#@#  ', 'Figure 2c,d shows in red the false-negative calls (panel c) and false-positive calls (panel d) for Mykrobe predictor and the two laboratory methods: disc and Phoenix.  #@NEW_LINE#@#  If we consider Fig 2c first, and focus on the 7 drugs with more than 10 resistant samples, then Mykrobe predictor misses fewer resistant calls than the other individual phenotypic methods for all drugs except ciprofloxacin.  #@NEW_LINE#@#  Ciprofloxacin had a false-negative rate of 4.6%; we were unable to determine the reason for these missed resistant predictions, although we note that disc and Phoenix had similar problems, and that this drug has at least one uncharacterized mechanism for resistance16.  #@NEW_LINE#@#  For the three drugs (methicillin, penicillin and erythromycin) for which our study has enough resistant samples to meet US Food and Drug Administration (FDA) criteria (false-negative rate  less_than 1.5%, upper 95% confidence interval  less_than 7.5%), Mykrobe predictor met these criteria17.  #@NEW_LINE#@#  The data underlying this plot are presented in Table 1.  #@NEW_LINE#@#  The results for the disc and Phoenix tests on the validation set are in Supplementary Tables 3 and 4.  #@NEW_LINE#@#  ', 'Table 1 Comparison of Mykrobe predictor S. aureus resistance prediction results with consensus phenotype for validation set (St_B1).Full size table', 'The equivalent plot for false-positive calls is shown in Fig 2d.  #@NEW_LINE#@#  For all drugs except penicillin and methicillin, all methods have low false-positive rates, below the FDA threshold of 3%.  #@NEW_LINE#@#  All methods had unacceptably high error rates for penicillin (11.7% for Mykrobe predictor, 15.1% for disc and 16.0% for Phoenix).  #@NEW_LINE#@#  However, it is known that for penicillin, phenotyping methods may under-detect resistance18,19,20, and so the apparent high false-positive rate is likely to be artefactualthat is, under-detecting resistance by disc, Phoenix and nitrocefin might lead to an (incorrect) consensus susceptible call.  #@NEW_LINE#@#  Indeed it has been previously shown3 that for some samples with weak beta-lactamase activity (exhibited by a very slowly developing nitrocefin test), resistance was not detected by either disc or Phoenix.  #@NEW_LINE#@#  Mykrobe predictor had an acceptable false-positive rate for methicillin of 0.0%, compared with disc (0.5%) and Phoenix (18.9%).  #@NEW_LINE#@#  This high false-positive rate for Phoenix was unexpected; either both disc and Etest under-detected resistance (they are both diffusion methods and might have correlated errors), or these were indeed false calls from Phoenix.  #@NEW_LINE#@#  ', 'For comparison with a commercial software package, we also ran SeqSphere6 on the validation set, which made predictions for six drugs where resistance was gene based.  #@NEW_LINE#@#  Since SeqSphere predicted all 471 samples to be resistant to erythromycin and clindamycin, we excluded these drugs.  #@NEW_LINE#@#  Other results were broadly comparable to Mykrobe predictor and the phenotyping methods.  #@NEW_LINE#@#  See Supplementary Table 5 and Supplementary Figs 4 and 5 for full results.  #@NEW_LINE#@#  ', 'Finally, our strong prior expectation was that there would be limited within-sample diversity, due to blood culture followed by storage processes, and removal of contaminated samples (see Methods section).  #@NEW_LINE#@#  Mykrobe predictor confirmed this expectation and made only 6 minor calls out of 11,592 (12 drugs times 966 training and validation samples).  #@NEW_LINE#@#  However, we noted with interest that for the four samples where Mykrobe predictor made false-positive (major) resistant calls that were not made by disc or Phoenix, re-running the disc test resulted in contradictory results.  #@NEW_LINE#@#  Two changed to resistant (ciprofloxacin and erythromycin) and two produced heteroresistant phenotypes (erythromycin, tetracycline, see Fig 3).  #@NEW_LINE#@#  This behaviour is consistent with a disc test presented with mixed strains or with variable plasmid loss (that would explain the three erythromycin/tetracycline results).  #@NEW_LINE#@#  All four samples had low levels of chromosomal diversity (between 12 and 25 heterozygous SNPs, Methods section), ruling out contamination unless by a closely related strain.  #@NEW_LINE#@#  ', 'Figure 3: Photograph of BSAC disc test showing heteroresistant phenotype.Seen on re-running Erythromycin disc test on a sample (accession: ERS398183) where Mykrobe predictor had called a false positive (resistant) that neither disc nor Phoenix had called.Full size image', 'Simulating minor infections with empirical data', 'To determine the power of our method to detect minor resistant populations, we ran Mykrobe predictor on 27,000 in silico mixed infections, created by mixing sequence data from different samples (simulation 2, see Methods section).  #@NEW_LINE#@#  We show in Fig 4a the power to detect alleles at low frequency.  #@NEW_LINE#@#  Our method has greatest power to detect resistance genes that lie on multi-copy plasmids, with detection power reaching 94 and 100% by the time the population frequency is 2% for tetracycline and erythromycin, respectively.  #@NEW_LINE#@#  For other drugs, detection power exceeds 90% once the subpopulation exceeds 8% frequency.  #@NEW_LINE#@#  This ability to genotype low-frequency alleles did not come at the cost of false-positive phenotypic resistance predictionsapart from the few false-positive calls that Mykrobe predictor made in pure samples (Table 1), there were no additional false positives out of 189,000 calls (27,000 mixtures × 7 drugs).  #@NEW_LINE#@#  ', 'Figure 4: Power to detect minor populations.  #@NEW_LINE#@#  (a) Simulation 2: power to detect minor resistant alleles in 27,000 in silico mixtures created by taking 1,000 pairs of S. aureus samples and mixing each pair in 27 different ratios.  #@NEW_LINE#@#  As above, we do not estimate false-negative rates for drugs where we have  less_than 10 resistant samples, as confidence intervals would be unreasonably large.  #@NEW_LINE#@#  Power is greatest for the drugs where resistance genes reside on multi-copy plasmids, namely erythromycin and tetracycline.  #@NEW_LINE#@#  Tet, tetracycline; Ery, erythromycin; Meth, methicillin; Pen, penicillin; Fuc, fusidic acid; Cip, ciprofloxacin.  #@NEW_LINE#@#  (b) Power to detect low-frequency coagulase-negative species (red, simulation 1, N=540, described above) is consistently higher than power to detect mecA (blue, simulation 2, N=27,000, frequencies down to 1% only due to large sample numbers; dotted lines extrapolate linearly from points at 1 and 2%), which causes methicillin resistance in S. aureus.  #@NEW_LINE#@#  Thus, the risk of detecting mecA but not detecting the coagulase-negative species it comes from is limited.Full size image', 'One goal for Mykrobe predictor was to avoid the combination of detecting mecA from mecA-containing-CoNS while failing to detect the CoNS species itselfthus causing a miscall of MRSA.  #@NEW_LINE#@#  We therefore used the simulated mixtures of S. aureus and CoNS (simulation 1), to estimate the discovery power for low-frequency CoNS species, and compared with that for low-frequency mecA in simulation 2results are shown in Fig 4b.  #@NEW_LINE#@#  We were able to confirm that in these mixtures such miscalls were indeed unlikely.  #@NEW_LINE#@#  At 1% frequency, the estimated power to detect the presence of a CoNS species was 100% (red curve), but power to detect mecA was 0.33 (blue curve).  #@NEW_LINE#@#  Above 3% frequency, power to detect each was 100%.  #@NEW_LINE#@#  ', 'Virulence elements', 'Antimicrobial resistance is not the only medically relevant phenotype that might be revealed by sequencing.  #@NEW_LINE#@#  S. aureus has a large number of virulence elements that might prove valuable to genotype.  #@NEW_LINE#@#  As an example, we considered PantonValentine leukocidin, a cytotoxin that kills leukocytes and is associated with tissue necrosis21.  #@NEW_LINE#@#  We incorporated tests for presence of the PantonValentine Leukocidin genes lukPV-S and lukPV-K into Mykrobe predictor and applied to sequence data from 67 S. aureus clinical isolates from an outbreak (Supplementary Data 5).  #@NEW_LINE#@#  The results were 100% concordant with PCR tests for the presence of these genes (23 negative and 44 positive).  #@NEW_LINE#@#  ', 'Identification of mycobacterial species in clinical samples', 'Species within the M. tuberculosis complex (MTBC) cause tuberculosis, but clinical samples may be other mycobacterial species.  #@NEW_LINE#@#  We defined probes (described in Methods section) for detection of four MTBC species (M. tuberculosis, M. bovis, M. africanum and M. caprae) and 40 nontuberculous mycobacteria (NTM) species including M. abscessus, M. avium and M. intracellulare.  #@NEW_LINE#@#  Co-infection with both MTBC and NTM, which is known to occur22,23, would be reported if present.  #@NEW_LINE#@#  We also use SNPs that have been defined in a previous publication24 to identify lineages within the MTBC.  #@NEW_LINE#@#  In terms of desired error profile, the main aim would be to minimize misclassifying a MTBC as a NTM, or vice versa.  #@NEW_LINE#@#  Misidentifying species within MTBC has limited impact on choice of treatment, except that M. bovis is known to be intrinsically resistant to pyrazinamide and some substrains of the Bacille CalmetteGuérin strain of M. bovis are known to be resistant to isoniazid.  #@NEW_LINE#@#  ', 'We then evaluated species prediction on the union of data sets MTBC_A2 (1157 MTBC clinical isolates, Supplementary Data 7) and Myco_Retro (147 Mycobacterial isolates, Supplementary Data 10), where species had been identified by Hain assay, showing results in Fig 5a.  #@NEW_LINE#@#  No samples were misclassified between MTBC and NTM, but there were four M. africanum and two M. tuberculosis samples that were only resolved to MTBC, and one M. tuberculosis sample misidentified as M. africanum.  #@NEW_LINE#@#  See Supplementary Table 6 for full results.  #@NEW_LINE#@#  Finally we tested our identification of the lineages as defined by Gagneux and co-workers in ref.  #@NEW_LINE#@#  25 by comparing with the lineage as identified by their own tool, KvarQ11 on dataset MTBC_A2 and found 100% concordance.  #@NEW_LINE#@#  ', 'Figure 5: Species predictions for mycobacteria and resistance predictions for MTBC.  #@NEW_LINE#@#  (a) Species classification results on a validation set (MTBC_A2+Myco_Retro, n=1,304).  #@NEW_LINE#@#  Colours indicate misclassifications between NTM/MTBC (red), concordance with truth (dark green), or greater resolution from Mykrobe predictor than PCR (light green).  #@NEW_LINE#@#  M.tb., M. tuberculosis; M.af., M. africum; M.bv., M. bovis.  #@NEW_LINE#@#  See Supplementary Table 1 for details of truth species.  #@NEW_LINE#@#  (b) Phylogeny of MTBC samples with phenotype data, with tips marked orange or blue to indicate training set (MTBC_A, n=1,920) or validation set (MTBC_B, n=1,609).  #@NEW_LINE#@#  Drug resistance is shown in concentric rings around the phylogenetic tree.  #@NEW_LINE#@#  Resistance exists across the phylogeny, especially against isoniazid (light blue), with a clustering of multi-drug resistance in the Beijing lineage.  #@NEW_LINE#@#  (c) Proportion of resistant MTBC samples correctly identified as resistant by Mykrobe predictor (yellow) and KvarQ (light blue) compared with DST phenotypefalse negatives in red.  #@NEW_LINE#@#  (d) As c, but showing proportion of susceptible samples called as susceptiblefalse positives in red.  #@NEW_LINE#@#  ISO, isoniazid; RIF, rifampicin; ETH, ethambutol; STREP, streptomycin; MOX, moxifloxacin; OFX, ofloxacin; AMI, amikacin; CAP, capreomycin; KAN, kanamycin.Full size image', 'M.  #@NEW_LINE#@#  tuberculosis predictions match commercial assays', 'We use a training data set MTBC_A of 1,920 MTBC isolates with Illumina sequence data and associated drug-susceptibility test (DST) data (see Methods section, Supplementary Fig 1 and Supplementary Table 1 with accession codes in Supplementary Data 68) from Oxfordshire, Birmingham, Sierra Leone and South Africa to fit the frequency threshold of 10%, above which a resistance allele is modelled as causing phenotypic resistance (see Methods section).  #@NEW_LINE#@#  We used an equivalent separate data set (MTBC_B, Supplementary Data 9) of 1,609 further isolates from Uzbekistan, Germany, South Africa and the UK to validate.  #@NEW_LINE#@#  All these samples had been previously collected for an independent study26 on the discovery of mutations predictive of resistance.  #@NEW_LINE#@#  ', 'Figure 5b shows a phylogeny of these samples, with training and validation samples coloured at the branch tips in orange and blue, respectively.  #@NEW_LINE#@#  The validation set does show some clustering within the phylogeny, due to the large number of samples from Uzbekistan in the validation set, with a resulting higher number of XDR TB samples in the validation set.  #@NEW_LINE#@#  ', 'Our understanding of the genetic basis for resistance in MTBC is incomplete.  #@NEW_LINE#@#  Common resistance mutations are on commercial line-probe assays, and explain 8595% of observed resistance to the two primary first-line drugs (isoniazid and rifampicin)27,28,29.  #@NEW_LINE#@#  These assays have lower sensitivity for the third first-line drug (ethambutol) and second-line drugs30, and do not attempt to predict resistance for the fourth first-line drug (pyrazinamide), which is poorly understood.  #@NEW_LINE#@#  We built a panel of resistance mutations based on the Hain and AID line-probe assays, with a small number of additional mutations from the literature (see Methods section for details).  #@NEW_LINE#@#  For comparison with a method using a similar panel but without minor calls, we also ran the KvarQ tool11.  #@NEW_LINE#@#  ', 'Figure 5c,d shows the proportion of resistant and susceptible samples that were called correctly for each drug.  #@NEW_LINE#@#  As expected, for first-line drugs rifampicin, isoniazid and ethambutol, the two methods (Mykrobe predictor and KvarQ) have similar power to detect resistance (93.7%, 84.3%, 71.6% versus 90.8%, 83.2%, 76.3%) and similar false-positive rates (1.0%, 1.4%, 4.2% versus 1.0%, 1.4%, 4.5%)in line with expected performance of the Hain assay (Supplementary Figs 6 and 7).  #@NEW_LINE#@#  ', 'Fewer samples were phenotyped for second-line drugs, but Mykrobe predictor had noticeably higher sensitivity for amikacin and capreomycin (89.8% and 83.6%, respectively) than KvarQ (74.6 and 70.9%), see below.  #@NEW_LINE#@#  There were very few false calls for second-line drugs for either method, except for a high (7%) error rate for KvarQ for streptomycin.  #@NEW_LINE#@#  See Supplementary Tables 710 for full results.  #@NEW_LINE#@#  ', 'Slow-growth rpoB SNPs and limitations of the gold standard', 'There were 12 false-positive rifampicin-resistance calls, all major calls in the gene rpoB.  #@NEW_LINE#@#  Three were L452P mutations, known to cause only low-level resistance31,32.  #@NEW_LINE#@#  However, on examination, we found the remaining nine calls may reflect limitations of gold-standard culture-based phenotyping.  #@NEW_LINE#@#  These were either mutations known to slow growth (S450L (n=3)33, S450W (n=1)33,34, Q432 (n=1)33,35), or overlap a 10 bp deletion affecting growth (Q429H (n=1), L430P (n=3)36).  #@NEW_LINE#@#  Since the proportion method used in M. tuberculosis susceptibility tests fundamentally measures growth rate as a proxy for resistance37, slow growth can lead to false susceptible DST results for samples with these mutations38,39,40,41.  #@NEW_LINE#@#  Thus, 75% of the false-positive rifampicin calls from Mykrobe predictor may actually be resistant in vivo, but called susceptible by DST due to the nature of the test.  #@NEW_LINE#@#  Indeed there is evidence that such rpoB mutations may be associated with poor outcome42,43.  #@NEW_LINE#@#  ', 'Minor alleles increase power to distinguish XDR from MDR TB', 'Mykrobe predictor predicted 56 samples were phenotypically resistant owing to minor alleles, across the 9 drugs and 1,609 samples in the MTBC_B validation set (Supplementary Data 9).  #@NEW_LINE#@#  Whole-genome analysis of these samples (see Methods section) found a median of 16 heterozygous sites per sample, consistent with mixed infections (local transmission or in-host evolution)44, although we cannot exclude the possibility of contamination with a closely related strain.  #@NEW_LINE#@#  ', 'We show in Fig 6 the proportion of true positives due to minor resistant calls in the validation set, showing a clear demarcation between first- and second-line drugs.  #@NEW_LINE#@#  Power to predict phenotypic resistance to second-line drugs amikacin and capreomycin was significantly increased by the detection of minor populations: from 74.5 to 83.6% for capreomycin and 78.0 to 89.8% for amikacin.  #@NEW_LINE#@#  In addition, although here the numbers were small (N=13), power increased from 38.5 to 61.5% for ofloxacin.  #@NEW_LINE#@#  This increase in sensitivity did not come at the price of a loss of specificity.  #@NEW_LINE#@#  However, the effect was only seen in our validation set that had the majority of XDR samples in our datathese minor alleles were mostly (27/39) found in validation samples from Uzbekistan.  #@NEW_LINE#@#  ', 'Figure 6: Percentage of true positive resistant calls in M. tuberculosis validation set due to minor alleles.Confidence intervals are calculated using the ClopperPearson interval.  #@NEW_LINE#@#  Drugs with  less_than 10 resistant samples were excluded to avoid overly large confidence intervals.  #@NEW_LINE#@#  For aminoglycosides and quinolones, minor populations explain between 1138% of true positive resistance predictions.  #@NEW_LINE#@#  ISO, isoniazid; RIF, rifampicin; ETH, ethambutol; STREP, streptomycin; OFX, ofloxacin; AMI, amikacin; CAP, capreomycin.Full size image', 'Nanopore sequencing of S. aureus', 'Having evaluated performance thoroughly on two species using Illumina data, we tested Mykrobe predictor on data from the ONT MinION single-molecule sequencing machine.  #@NEW_LINE#@#  Since the per-base error rate is high (between 10 and 30% per base, depending on whether the molecule has been sequenced in one or two directions, termed 1d reads and 2d reads, respectively), we modified Mykrobe predictor to expect an error rate of 10%, and to ignore the quality score for ONT data.  #@NEW_LINE#@#  We took a MDR S. aureus isolate from a clinical sample taken in 2014, and sequenced its genome with both the Illumina MiSeq and a ONT MinION (see Methods section for details) and ran Mykrobe predictor.  #@NEW_LINE#@#  The MiSeq run took 24 h and produced after cutting reads at bases with quality below 10, 368x of 122 bp reads.  #@NEW_LINE#@#  The MinION run took 24 h and generated 39x of 2d reads, with min/mean/max length 113 bp/4.7 kb/48 kb.  #@NEW_LINE#@#  In both cases, Mykrobe predictor correctly predicted that the sample was resistant to penicillin, methicillin, gentamicin, trimethoprim, erythromycin, ciprofloxacin and clindamycin, and susceptible to fusidic acid, rifampicin, tetracycline, vancomycin and mupirocin.  #@NEW_LINE#@#  All of the resistance calls were due to detection of genes, except for ciprofloxacin where a S- greater than L mutation at position 84 in the gene gyr was detected.  #@NEW_LINE#@#  No false-positive resistance SNPs were called.  #@NEW_LINE#@#  Furthermore, by truncating the MinION output file we showed that these results could have been obtained with just 7 h of sequencing.  #@NEW_LINE#@#  ', 'Software performance and usability', 'Mykrobe predictor memory use is comparable with that typically used by a web browser such as Chrome with multiple tabs open, and CPU requirements are low.  #@NEW_LINE#@#  Mykrobe predictor has been run on a Google Nexus 10 tablet, a Samsung Core Duos phone and a Raspberry Pi Model B.  #@NEW_LINE#@#  We give in Table 2 some performance statistics for S. aureus (abbreviated as Sa) and M. tuberculosis (abbreviated as Mtb), with comparison data from alternative tools SeqSphere6 (which uses whole-genome assembly), and KvarQ11 (which uses kmer detection).  #@NEW_LINE#@#  ', 'Table 2 Performance and feature comparison of Mykrobe predictor, SeqSphere and KvarQ software.Full size table'  #@NEW_LINE#@#  

Discussion  #@NEW_LINE#@#  
'Rapid determination of antimicrobial resistance profile is of critical importance to patient care for many serious bacterial infections and has wider implications for determination of treatment protocols and national surveillance.  #@NEW_LINE#@#  We have developed a software application, extensible to many bacterial species, called Mykrobe predictor, which can identify species, resistance profile and other genomic features such as virulence elements and phylogenetic lineage, within 3 min on a standard laptop.  #@NEW_LINE#@#  We have provided two implementations, for S. aureus and M. tuberculosis, and validated them extensively against clinical gold standards.  #@NEW_LINE#@#  Our results for S. aureus (overall sensitivity and specificity above 99%) are comparable to or better than phenotyping methods (BSAC disc test, Phoenix).  #@NEW_LINE#@#  For M. tuberculosis, specificity is high (98.5%) and sensitivity of 82.6% matches the line-probe assays from which our resistance panel was constructed, but still is below that of the gold standard of DST based on solid (LöwensteinJensen) culture.  #@NEW_LINE#@#  However, as new resistance-causing mutations are determined, Mykrobe predictor can be easily updated and tested, and unlike a line-probe assay or the automated Xpert-Mtb/Rif (Cepheid) assay, is unaffected by number of resistance-causing mutations in the panel.  #@NEW_LINE#@#  ', 'We detail in Fig 7a how the timelines for a proposed S. aureus sequencing workflow would compare with the clinical protocols implemented at Oxford University Hospitals clinical laboratory.  #@NEW_LINE#@#  Using an Illumina MiSeq 16.5 h run, our proposed sequencing workflow would provide a full set of predictions for all drugs at 36 h, ahead of Oxford University Hospital by 12 h. At other institutions, one might use MALDI-TOF or alternate rapid methods to identify the species or even methicillin resistance directly on blood culture45,46 but these cannot give the full susceptibility profile (nor any information on ancestry, epidemiology or virulence).  #@NEW_LINE#@#  ', 'Figure 7: Timelines for sequencing-based analysis and culture-based DST.The timelines are shown for (a) S. aureus and (b) M. tuberculosis.  #@NEW_LINE#@#  In (a) both culture-based (a,i) and sequencing-based (a,ii) options involve 12 h of blood culture.  #@NEW_LINE#@#  After this, the culture-based approach (at Oxford University Hospitals clinical laboratory) follows with a direct coagulase test (Coag.)  #@NEW_LINE#@#  that provides a presumptive species identification at 4 h (marked A).  #@NEW_LINE#@#  Concurrently, blood culture is subcultured to blood agar, and MALDI-TOF confirms the species at 12 h (B).  #@NEW_LINE#@#  A disc diffusion test for five antimicrobials (including methicillin) is performed directly from a positive blood culture providing first-line susceptibility information 1824 h later (C), assuming an acceptable inoculum.  #@NEW_LINE#@#  Finally, post-subculture samples are undergo extended susceptibility testing by automated broth microdilution (brandname Phoenix), giving final results after another 1824 h (D).  #@NEW_LINE#@#  For the sequencing-based workflow (a,ii), the DNA extraction plus sample preparation takes 7.5 h because samples are from blood culture, not colony isolates.  #@NEW_LINE#@#  With the Illumina MiSeq v3 reagents, a 16.5 h run is possible (giving paired 75 bp reads, adequate for this purpose), giving full susceptibility results at the same time as direct disc tests provide results for five drugs.  #@NEW_LINE#@#  (b) The culture-based process (b,i; in a typical UK reference laboratory) starts with two weeks of mycobacterial growth indicator tube (MGIT) culture, followed by a species identification test (X).  #@NEW_LINE#@#  If the species belongs to the MTBC, then DST is run in MGIT, and at decision point Y, if the sample tests susceptible to all first-line drugs, no further testing is done.  #@NEW_LINE#@#  MGIT DST is repeated for pyrazinamide if the first test revealed resistance to this drug.  #@NEW_LINE#@#  If there is resistance to any other drug, then solid culture DST is performed.  #@NEW_LINE#@#  If these tests show there is resistance to rifampicin then another round of MGIT culture followed by MGIT DST is done for second-line drugs.  #@NEW_LINE#@#  For sequencing-based approaches we show timelines for the present study (b,ii) and a potential alternative (b,iii), which would reduce time-to-results to just over 2 weeks.Full size image', 'The acceleration provided by sequencing is even greater for M. tuberculosis, where the standard process to run first-line drug tests and, if necessary, the second-line tests afterwards, takes months (Fig 7b).  #@NEW_LINE#@#  In principle these could be run in parallel, but the cost is prohibitive.  #@NEW_LINE#@#  By contrast, for the sequencing workflow, most clinical isolates become MGIT positive within 2 weeks.  #@NEW_LINE#@#  Thus, if sample preparation and sequencing is completed within 2 days of positivity47, one can get results in 2 weeks.  #@NEW_LINE#@#  This is a gain of somewhere between 5 and 17 weeks compared with gold-standard DST, depending on whether the sample is resistant to first-line drugs.  #@NEW_LINE#@#  ', 'We have demonstrated that detection of simple minor resistant infections can be achieved in a robust and automated fashion, assuming at most two strains are present.  #@NEW_LINE#@#  We are unaware of any other resistance prediction tool that allows this.  #@NEW_LINE#@#  In our study, Mykrobe predictor classified 3.5%/4.9% of our M. tuberculosis training/validation samples as having minor resistant populations, with median frequency of 6.8%/9.2%, respectively.  #@NEW_LINE#@#  However, to match the results of the in vitro gold standard, we only predicted a resistant phenotype for alleles above 10% frequency.  #@NEW_LINE#@#  It remains an open question as to whether the lower frequency alleles have a bearing on patient outcome, despite generally failing to cause in vitro resistance.  #@NEW_LINE#@#  ', 'For TB, initial treatment is with the preferred set of four first-line drugs (rifampicin, isoniazid, ethambutol and pyrazinamide) until it is identified that a drug-resistant strain is present, when treatment is changed to second-line drugs, many of which are less effective, less well-tolerated and more difficult to administer.  #@NEW_LINE#@#  The spread of MDR TB48 (resistant to rifampicin and isoniazid) and of XDR TB (MDR plus resistant to specific second-line drugs, that is, quinolones and an injectable such as capreomycin or amikacin) is a major global health concern.  #@NEW_LINE#@#  In our validation set, which contained the bulk of our XDR samples, we found minor alleles improved power to predict resistance by 9.1/11.8/23.0% for second-line drugs capreomycin, amikacin, and ofloxacin respectively (also see Fig 6).  #@NEW_LINE#@#  Thus, minor alleles (or heteroresistance) may have a significant role in distinguishing MDR from XDR TB.  #@NEW_LINE#@#  However, since only 18%/44% of our training/validation samples were phenotyped for at least one quinolone or injectable, this finding needs replication with larger data sets.  #@NEW_LINE#@#  ', 'Recognizing that lack of bioinformatics expertise is a barrier to clinical adoption, we provide drag-and-drop Windows and Mac applications (see screenshots in Supplementary Figs 810) and a linux version that could, for example, enable a cloud service.  #@NEW_LINE#@#  Our demonstration that Mykrobe predictor can work on low-specification hardware, such as a mobile phone or Raspberry Pi is intended to enable future applications of resistance determination in the field, in low-resource settings with no internet access.  #@NEW_LINE#@#  Along these lines, the advent of portable single-molecule sequencing machines that deliver long-read information in real time will change the face of clinical microbiology.  #@NEW_LINE#@#  The ability to sequence a single sample removes the need to batch samples until an Illumina MiSeq sequencing run is justified, reducing bedside-to-treatment time, and the long reads could provide vital information on mixed infection composition.  #@NEW_LINE#@#  Our N=1 test of the Oxford Nanopore MinION machine offers only proof-of-principle, but unlike one recent report49, we were able to get fully concordant results for both gene and SNP-driven resistance with only 13 × coverage, without the high per-base error rate causing any false SNP calls.  #@NEW_LINE#@#  Since Mykrobe predictor can test the de Bruijn graph and assess confidence of resistance/susceptibility approximately an order of magnitude faster than MinION reads arrive, this could be done as the reads come in from the machine, enabling a real-time decision to be made as to whether to stop sequencing.  #@NEW_LINE#@#  In this case we could have stopped after 7 h of sequencing, and throughput on this maturing platform has improved considerably since then.  #@NEW_LINE#@#  ', 'In terms of the path to clinical use of Mykrobe predictor, the next steps for S. aureus and M. tuberculosis are further clinical testing, and then obtaining regulatory approval.  #@NEW_LINE#@#  We will be running Mykrobe predictor in parallel with the clinical workflow in hospitals in Oxford, Leeds and Brighton (UK) for 3 months starting in 2015 as part of a Health Innovation Challenge Fund project.  #@NEW_LINE#@#  It is relatively simple to extend Mykrobe predictor to other bacterial species by using a panel of known sites and genes, as we did in this study.  #@NEW_LINE#@#  However, more generally, for a species where resistance mechanisms are poorly characterized, one would need to use a large training set with both whole-genome sequence data and phenotype information for hypothesis-free discovery of causal mutations or purely predictive markers.  #@NEW_LINE#@#  Some such studies have been done50,51, and we expect many more.  #@NEW_LINE#@#  ', 'There are two main limitations to the current implementation of Mykrobe predictor.  #@NEW_LINE#@#  First, we suspect that incorporating a more general model of mixtures, rather than simply major/minor clones, will be of value when analysing M. tuberculosis samples direct from sputum.  #@NEW_LINE#@#  Second, our sensitivity for M. tuberculosis is low (82.6% across all drugs) compared with traditional DST, and completely excludes the first-line drug pyrazinamide since known mutations are poorly predictive.  #@NEW_LINE#@#  This issue, shared by all molecular assays, can only be resolved by large-scale sequencing and phenotyping studies.'  #@NEW_LINE#@#  

Methods  #@NEW_LINE#@#  
'Study design', 'The objectives of this study were: ', '

a
To show that our software program could deliver automated antimicrobial-resistance predictions for two bacterial species given a pre-specified genotype-to-drug-resistance mapping.  #@NEW_LINE#@#  The limitations of the pre-specified mapping would place an upper bound on sensitivityfor S. aureus that upper bound was above 99%, but for M. tuberculosis we followed the HAIN and AID assays, expecting sensitivity of 82%.  #@NEW_LINE#@#  To achieve this, we used independent training and validation sets previously obtained in other studies3,26.  #@NEW_LINE#@#  For both species, the number of samples with resistant phenotypes was limiting, and we only estimated false-negative rates where there were sufficiently many ( greater than 10) resistant samples in the validation set, reporting confidence intervals calculated using the ClopperPearson interval.  #@NEW_LINE#@#  b
To handle contamination and mixture issues seen in clinical samples.  #@NEW_LINE#@#  We used independent data sets for design of probes and validation.  #@NEW_LINE#@#  To include some realistic sampling of species, the validation set for mycobacteria included the set Myc_Retro consisting of all mycobacterial (meaning positive MGIT culture) samples sent to the laboratories at the Oxford John Radcliffe Hospital between 2 June 2013 and 29 January 2014.


c
To observe whether minor resistant population detection could increase predictive power of phenotypic resistance without compromising specificity in the data sets collected.  #@NEW_LINE#@#  ', 'All data sets used are described in Supplementary Fig 2 and Supplementary Table 1 with full sample information in Supplementary Data 111.  #@NEW_LINE#@#  ', 'Phenotyping and sequencing of S. aureus data sets', 'Initial phenotyping of the training and validation sets was described in detail in Gordon et al.3 The training set was phenotyped using either the Vitek automated system (bioMerieux) or the Stokes method disc diffusion52, whereas all validation samples were phenotyped using two methods: a BSAC disc test15 and the Phoenix automated microbiology system (BD Biosciences).  #@NEW_LINE#@#  For trimethoprim only disc testing was performed.  #@NEW_LINE#@#  ', 'We removed 6 samples from the training data set and 20 samples from the validation set that were contaminated (see section Contamination in S. aureus genome sequence data below for details).  #@NEW_LINE#@#  All samples where there was discordance between Phoenix and disc for any drug in Gordon et al.3 were rerun on Phoenix (for all drugs) and previous results from Gordon et al.3 were discarded.  #@NEW_LINE#@#  ', 'Samples were sequenced on Illumina HiSeq 2000 platform, with mean read length (after cutting reads at bases with quality score below 10) of 87 bp and mean depth of 87, as described in ref.  #@NEW_LINE#@#  3.  #@NEW_LINE#@#  ', 'Species identification in general', 'To ensure sensitivity to low-frequency contaminating species, we wanted to use more than one probe (as opposed to common methods based on single genes, for example, rpoB, gyrA and so on.  #@NEW_LINE#@#  ), which contained more sequence than a single gene.  #@NEW_LINE#@#  We developed a system for designing a hierarchy of markers (contigs) that first separated two phylogroups (S. aureus from CoNS, or MTBC from NTM), and then identified species present within a phylo group.  #@NEW_LINE#@#  We first built a Bruijn graph by pooling several hundred samples from both phylogroups, and pulled out all unique and unambiguous contigs (unitigs) and calculated the frequency of each contig in each phylo group.  #@NEW_LINE#@#  We chose the most highly differentiated contigs to form marker panels to distinguish the groups.  #@NEW_LINE#@#  This process was then run again to find contigs informative at the species level.  #@NEW_LINE#@#  ', 'Identification of staphylococcal species', 'The above process was applied to 731 staphylococcal isolates in training set St_A, which combines data sets St_A1 (532 clinical S. aureus isolates, Supplementary Data 1) and St_A2 (199 CoNS isolates, Supplementary Data 2) , using Cortex13 with kmer size 15, to produce probes (contigs) for phylogroups (S. aureus versus coagulase-negative staphylococci) and species (S. aureus, S. epidermidis, S. haemolyticus, other coagulase-negative species).  #@NEW_LINE#@#  We assume a positive Gram stain has been obtained, and use 33 alleles of the catalase gene (Supplementary Table 11) to confirm presence of staphylococci.  #@NEW_LINE#@#  The percentage of sequence in the probe panel found in each training sample (recovery) was plotted, and extreme outliers were ignored as possible errors in the SRA metadata; detection thresholds were chosen based on recovery in the training set: 90% for S. aureus, 30% for S. epidermidis and S. haemolyticus, 10% for other staphylococci and 20% for the catalase gene.  #@NEW_LINE#@#  ', 'S.  #@NEW_LINE#@#  aureus resistance panel', 'Starting from the variant catalogue described by Gordon et al.3, we made the following alterations.  #@NEW_LINE#@#  B434N in fusA was changed to D434N.  #@NEW_LINE#@#  Q456K in rpoB was removed as Q was not the amino acid at position 456 of the referenced rpoB gene.  #@NEW_LINE#@#  We added rpoB N474K, described by Villar et al.53 We also considered the 10 novel mutations reported by Dordel et al.54 We found three of the mutations (PBP1 H499Y, PBP2 T31M and PBP2 D156Y) in our derivation set.  #@NEW_LINE#@#  These were found in samples phenotypically susceptible to methicillin, so none of the variants from that paper54 were included in the final catalogue.  #@NEW_LINE#@#  Variants that changed predicted MIC (Minimum Inhibitory concentration) but did not confer resistance on their own were not included.  #@NEW_LINE#@#  For resistance genes we took all versions/alleles of the gene from National Center for Biotechnology Information that were not explicitly annotated as existing in a susceptible strain, and did not have stop codons.  #@NEW_LINE#@#  The full list of chromosomal mutations, genes and accession codes can be found in Supplementary Tables 1214.  #@NEW_LINE#@#  ', 'Data structures for genotyping', 'We implemented two versions of Mykrobe predictor.  #@NEW_LINE#@#  The first builds a whole-genome de Bruijn graph of the sample, and then takes the intersection of this with the de Bruijn graph of all (alleles of) genes and mutations on different genetic backgrounds (the target graph).  #@NEW_LINE#@#  This requires 300 Mb of RAM for a typical Illumina data set, but could in principle grow for very large data sets.  #@NEW_LINE#@#  To control memory use, the second approach builds the target graph first, and then only loads sample data that intersects it, reducing RAM use to 100 Mb.  #@NEW_LINE#@#  Both methods give absolutely identical results, and we ran all analyses for this paper using the second approach.  #@NEW_LINE#@#  ', 'Genotyping at mutations', 'We use three competing models: pure susceptible, minor resistant (frequency=10%) and major resistant (we used frequency=75%, but we expect that values from 60100% would result in identical model choice).  #@NEW_LINE#@#  In this and subsequent sections, a subscript MAJ, MIN or S refers to the Major Resistant, Minor Resistant or Susceptible models.  #@NEW_LINE#@#  We use the following uninformative priors:', '', 'where perc(R) and perc(S) are, respectively, the percentage of the kmers in the resistant/susceptible alleles that are seen in the sample, and I is an indicator function.  #@NEW_LINE#@#  We use the following simple Poisson model for the likelihoods for all three models.  #@NEW_LINE#@#  ', 'Susceptible model: likelihood specified by Poisson coverage on S allele, plus errors driving both coverage loss on S allele and coverage on R allele.  #@NEW_LINE#@#  ', '', 'Major and minor resistant models: Poisson coverage on both alleles scaled by frequency:', '', 'where Cov() is a function returning median coverage on an allele, D is the depth of coverage,  is the per-base error rate,  is the kmer size, and the frequency f of the resistance allele is 0.1/0.75 for the minor/major resistant model.  #@NEW_LINE#@#  ', 'The vast majority of mutations in the panel result in amino acid changes, but some of the mutations occur within promoter regions.  #@NEW_LINE#@#  When we refer to genetic background, we simply mean mutations present in the population within one kmer length of the site of interest.  #@NEW_LINE#@#  For all mutations in the panel, we run through all genetic backgrounds, and if appropriate, all possible nucleotide changes that would generate the specified amino acid change, and find the highest coverage resistant allele and susceptible allele.  #@NEW_LINE#@#  These are then passed into the three models.  #@NEW_LINE#@#  The Maximum A Posteriori Model is chosen.  #@NEW_LINE#@#  ', 'Resistance calling at mutations', 'If the frequency of the genotyped variant is below a threshold (T, determined below) we report the mutation but predict a susceptible phenotype.  #@NEW_LINE#@#  Otherwise we predict a resistant phenotype, and mention whether we classified this as a minor or major population.  #@NEW_LINE#@#  ', 'For S. aureus, the protocol undergone by samples in the standard clinical workflow removed almost all mixture, and so there were almost no minor alleles to either train or validate onwe set an arbitrary threshold of 10%.  #@NEW_LINE#@#  For M. tuberculosis, we did not have enough data to estimate per-drug thresholds, and we knew that the phenotyping data was imperfect (for example embB mutations at amino acid 306 lead to ethambutol MICs that are very close to the critical concentration, leading to stochastic switching of test results).  #@NEW_LINE#@#  We examined the two frequency distributions of resistance alleles present in phenotypically resistant/susceptible samples in the training set (Supplementary Fig 11), and selected a single threshold of 10% for all drugs.  #@NEW_LINE#@#  The corresponding distributions for the validation set can be seen in Supplementary Fig 12.  #@NEW_LINE#@#  ', 'Genotyping at genes', 'The expected proportion of kmers in a gene that are observed is', '', 'We use the following priors', '', 'where each gene G has multiple exemplars Gi representing diversity of that gene, I is an indicator function, and perc() is a function returning the percentage of kmers present in the sample.  #@NEW_LINE#@#  K is the minimum percentage of kmers expected to be recovered for a gene, based on the empirical level of diversity observed in the training set.  #@NEW_LINE#@#  ', '', 'The likelihoods for major and minor models depends on the probability of having the observed median coverage across the gene.  #@NEW_LINE#@#  If dpois refers to the probability density of a Poisson distribution, and the observed median coverage across the gene is m, then the likelihood for the major and minor resistant models are given by', '', 'where D is the median depth of coverage on the species-specific probe panel defined above, k is kmer and R is read length.  #@NEW_LINE#@#  ', 'Resistance calling at genes', 'In the training set, a threshold frequency was chosen for each gene, such that above this frequency the sample was more likely to be resistant than sensitive.  #@NEW_LINE#@#  If the gene was genotyped as Minor Resistant but the genes estimated frequency (based on median coverage over overall depth of coverage) was below this threshold a susceptible phenotype was reported.  #@NEW_LINE#@#  Otherwise, a (major or minor) resistant phenotype was reported.  #@NEW_LINE#@#  ', 'The minimum frequency thresholds were: erythromycin: 0.19, fusidic acid: 0.03, gentamicin: 0.04, methicillin: 0.06, mupirocin: 0.21, penicillin: 0.04 , tetracycline: 0.13 and otherwise=0.03.  #@NEW_LINE#@#  ', 'Identification of mycobacterial species', 'We chose to identify 4 MTBC species (M. tuberculosis, M. africanum, M. bovis, M. caprae) and 40 NTM species (M. abscessus, M. africanum, M. aromaticivorans, M. avium, M. bovis, M. branderi, M. caprae, M. chelonae, M. chlorophenolicum, M. chubuense, M. colombiense, M. crocinum, M. flavescens, M. fluoranthenivorans, M. fortuitum, M. gilvum, M. gordonae, M. hodleri, M. interjectum, M. intracellulare, M. kansasii, M. lentiflavum, M. leprae, M. malmoense, M. marinum, M. mucogenicum, M. pallens, M. peregrinum, M. phage, M. pyrenivorans, M. rufum, M. rutilum, M. scrofulaceum, M. senegalense, M. smegmatis, M. sphagni, M. szulgai, M. triplex, M. tuberculosis, M. tusciae, M. ulcerans, M. vaccae, M.  #@NEW_LINE#@#  xenopi.).  #@NEW_LINE#@#  Marker panels were generated for MTBC and NTM (phylo groups) and for individual species within those groups, using the same method as for staphylococci based on training set consisting of data sets MTBC_A1 (338 MTBC clinical isolates, Supplementary Data 6) and Myco_SRA (380 Mycobacterial samples downloaded from the SRA, Supplementary Data 11) .  #@NEW_LINE#@#  The required percentage of probe sequence to be found in each of the phylo group panels was set as 70% for MTBC, 25% for the NTM panel, and 30% for all species panels.  #@NEW_LINE#@#  Above this threshold the phylo group or species was predicted to be present.  #@NEW_LINE#@#  ', 'We also used the lineage-informative SNPs defined by Stucki et al.24 to assign M. tuberculosis lineages: Beijing/East Asia, East Africa / Indian ocean, Delhi/Central Asia, European/American, West Africa 1 and 2 or Ethiopian.  #@NEW_LINE#@#  ', 'M.  #@NEW_LINE#@#  tuberculosis phylogeny', 'We used the underlying phylogeny of samples in sets MTBC_A and MTBC_B, which was constructed using RAxML (version 8.0.5) using a GTRCAT (General Time ReversibleCAT) model55.  #@NEW_LINE#@#  For this study, we combined this tree with data set membership and phenotypic resistance metadata using the analyses of Phylogenetics And Evolution Package55 to produce Fig 2b.  #@NEW_LINE#@#  ', 'M.  #@NEW_LINE#@#  tuberculosis resistance panel', 'We used a panel of MTBC resistance variants from the HAIN29, Cepheid56 and AID57 assays supplemented by others from the literature58,59,60 (Supplementary Table 15).  #@NEW_LINE#@#  All possible SNPs that would account for amino acid or DNA variants associated with resistance were introduced on multiple susceptible backgrounds.  #@NEW_LINE#@#  These backgrounds were selected as follows.  #@NEW_LINE#@#  Two samples were chosen from each of the six M. tuberculosis lineages.  #@NEW_LINE#@#  For those samples, paired-end reads were mapped by Stampy (version 1.0.17)61 to the H37Rv reference genome (GenBank accession code NC000962.2).  #@NEW_LINE#@#  SNP calls were made with SAMtools62 mpileup (version 0.1.18), requiring a minimum read depth of 5 and at least one read on each strand.  #@NEW_LINE#@#  We looked for variants in the 20 bases on either side of each resistance mutation in each of those 12 samplesthese, along with the reference, defined a set of genetic backgrounds.  #@NEW_LINE#@#  ', 'Since the underlying panel is almost identical, we expect Mykrobe predictor to perform equivalently to the HAIN test.  #@NEW_LINE#@#  Comparing on MTBC_A, Mykrobe predictor and HAIN have similar power to detect resistance (85.5%, 94.1%, 76.5% versus 85.5%, 93.5%, 76.5%) for first-line drugs rifampicin, isoniazid and ethambutol, respectivelysee Supplementary Figs 5 and 6.  #@NEW_LINE#@#  ', 'We chose an underlying frequency of 10% for the minor resistant model as this gave appropriately low false-positive rates when comparing with phenotypes in the training set (Supplementary Table 7).  #@NEW_LINE#@#  ', 'Software', 'The Mykrobe predictor software is freely available (opensource) at www.github.com/iqbal-lab/Mykrobe-predictor for non-commercial academic and research use only, under a licence from Isis Innovation, the technology transfer company of the University of Oxford.  #@NEW_LINE#@#  We provide a Linux command-line version and desktop drag-and-drop applications for 64-bit Windows and Mac OS X (Supplementary Software 14; see screenshots in Supplementary Figs 810 and screencasts in Supplementary Movies 1 and 2).  #@NEW_LINE#@#  ', 'Contamination in S. aureus genome sequence data', 'We removed six samples from the St_A1 and nine samples from St_B1, as BLAST of the assembly contigs confirmed presence of non-staphylococcal contamination.  #@NEW_LINE#@#  We also removed 11 samples from St_B1, which had  greater than 40 confident heterozygous SNPs as called by the Cortex variation assembler (independent workflow, k=31, ploidy=2, automatic error cleaning, using bubble caller calling algorithm).  #@NEW_LINE#@#  We used this threshold of 40 heterozygous sites to determine whether a sample was contaminated by an unrelated strainless than that we considered a conceivable level of in-host diversity.  #@NEW_LINE#@#  ', 'Phylogeny of S. aureus', 'A conservative set of SNPs was called for each sample in the training set (St_A1) and validation set (St_B1) by first mapping reads to the MRSA252 reference genome with Stampy61, and then calling variants with samtools62.  #@NEW_LINE#@#  SNPs with less than five reads support, or without at least one read on each strand, were filtered, as were multiallelic SNPs, SNPs with at least 5 reads on both alleles, and SNPs in repetitive regions.  #@NEW_LINE#@#  A phylogeny was then constructed using RAxML55 with the following command-line.  #@NEW_LINE#@#  ', 'RAxML-7.7.6/raxmlHPC-PTHREADS-SSE3 -s phylipFile -n outputPrefix -m GTRCAT -p 12345 -c 1 -T 2 -D ON -f c -F ON -V.', 'This tree was used to produce Fig 2b, to display the distribution of resistance training and validation samples across the phylogeny.  #@NEW_LINE#@#  ', 'Simulation 1: detecting staphylococcal contaminants', 'We took 18 CoNS samples from the St_B2 (Supplementary Data 4) data set (9 S. epidermidis and 9 S. haemolyticus), and 9 S. aureus samples from St_B1 (Supplementary Data 3), and associated random pairs of samples from these sets (always 1 S. aureus and 1 CoNS, mixture pairs below).  #@NEW_LINE#@#  We then made in silico mixtures of these pairs with the CoNS samples at 30 frequencies ranging from 0.5 to 20%.  #@NEW_LINE#@#  We ran Mykrobe predictor on all 540 mixtures to determine sensitivity to detect CoNS at each frequency.  #@NEW_LINE#@#  Accession identifiers of the pairs: (SRR1182410, ERR410084), (SRR1182413, ERR410093), (SRR1182415, ERR410136), (SRR1609104, ERS398139), (SRR221652, ERS398155), (SRR398319, ERS398179), (SRR496759, ERS398307), (SRR496761, ERS398353), (SRR496889, ERS398370), (ERR085178, ERR410084), (ERR085180, ERR410093), (ERR085182, ERR410136), (ERR085188, ERS398139), (ERR085190, ERS398155), (ERR085192, ERS398179), (ERR085258, ERS398307), (ERR085260, ERS398353) and (ERR085262, ERS398370).  #@NEW_LINE#@#  ', 'Simulation 2: detecting low-frequency alleles in S. aureus', 'We took 450 samples from the S. aureus data set St_B1 that all had at least 100 × mean sequencing depth of coverage across the genome, and subsampled them randomly to precisely 100 × .  #@NEW_LINE#@#  We then took 1,000 random pairs of samples from this set, and for each pair, combined subsets of their reads so as to create 27 different mixtures with ratios ranging from 1:99 to 99:1.  #@NEW_LINE#@#  ', 'We than ran Mykrobe predictor on these mixtures, to determine the frequency at which rare SNPs/genes were detected, and to confirm that this sensitivity did not cause false-positive predictions of phenotypic resistance.  #@NEW_LINE#@#  ', 'Analysing S. aureus samples with discrepant disc retests', 'Whole-genome variant calling was done with the Cortex variation assembler63 (version 1.0.5.21, independent workflow, k=31, ploidy=2, automatic error cleaning, using bubble caller calling algorithm) with the following command: perl  less_than cortex_dir greater than /scripts/calling/run_calls.pl --ref Absent --fastaq_index INDEX --first_kmer 31 --auto_cleaning yes --outdir OUTDIR --ploidy 2 --genome_size 2800000 --mem_height 20 --mem_width 100 --qthresh 10 --do_union no --logfile log.txt --workflow joint --vcftools_dir /path/to/vcftools_0.1.9/.  #@NEW_LINE#@#  ', 'The number of variants which were genotyped as heterozygous with genotype confidence  greater than 1 was counted for each of these samples.  #@NEW_LINE#@#  ', 'Running other software for comparison', 'The commercial software SeqSphere recently demonstrated resistance gene detection64.  #@NEW_LINE#@#  The template (the SeqSphere equivalent of a gene panel) used was not publicly released but the authors were kind enough to allow us to use it.  #@NEW_LINE#@#  We ran SeqSphere on the sequence data from the validation set St_B1 (471 S. aureus isolates), in pipeline mode.  #@NEW_LINE#@#  We followed the methods in the original paper64 with the exception that the Velvet assembly was run by SeqSphere with the default parameters.  #@NEW_LINE#@#  Although used in that paper, erythromycin and, therefore, clindamycin were excluded from the comparison since all samples were called as Resistant.  #@NEW_LINE#@#  ', 'KvarQ11 version 0.12.3a1 was run on the training and validation MTB fastq files using the provided MTBC testsuite.  #@NEW_LINE#@#  ', 'Heterozygosity in M. tuberculosis set MTBC_B', 'The standard independent workflow of Cortex was used, with the bubble caller algorithm, using the run_calls script which is part of Cortex.  #@NEW_LINE#@#  Parameter values: ploidy=2, do_union=yes, auto_clean=yes, kmer_size=31.  #@NEW_LINE#@#  Only sites with genotype confidence GT_CONF greater than 1 were considered.  #@NEW_LINE#@#  ', 'Nanopore sequencing', 'The DNA library was prepared using the Genomic DNA Sequencing Kit SQK-MAP005 according the manufacturers protocol (Version MN005_1115_revC_26Nov2014), with small modifications.  #@NEW_LINE#@#  ', 'Without undergoing any shearing process, 2 g of DNA were treated with PreCR Repair Mix (New England BioLabs, NEB) , to repair possible damage to the DNA that could interfere with the sequencing process.  #@NEW_LINE#@#  Following Oxford Nanopore recommendation for the optional PreCR treatment, each g of DNA was first diluted in nuclease-free water to a volume of 85 l to which 10 l ThermoPol Reaction Buffer, 1 l NAD+, 1 l 10 M dNTPs and 2 l PreCR Repair Mix were added, and the two reactions were incubated at 37 °C for 30 min.  #@NEW_LINE#@#  The repaired DNA was purified with 1 volume (100 l) Agencourt AMPure XP beads (Beckman Coulter, UK) according to manufacturers instructions.  #@NEW_LINE#@#  The purified DNA from each of the two reactions was eluted from the magnetic beads in 40 l EB buffer and pooled together.  #@NEW_LINE#@#  The 80 l of DNA were end repaired using the NEBNext End Repair (NEB) module from the NEBNext DNA Library Prep Master Mix Set (New England BioLabs, UK) for Illumina by adding 10 l buffer and 5 l of enzyme mix, and nuclease-free water to a final volume of 100 l, and incubating the reaction at 20 °C for 30 min.  #@NEW_LINE#@#  The end-repaired DNA was purified with 1 × volume (100 l) Agencourt AMPure XP beads and the purified product eluted in 25 l EB buffer.  #@NEW_LINE#@#  dA tailing on the purified DNA was performed in a final volume of 30 l using the dA-tailing module of the NEBNext DNA Library Prep Master Mix Set for Illumina: 3 l buffer and 2 l Klenow fragment (35 exo) were added and the reaction was incubated at 37 °C for 30 min.  #@NEW_LINE#@#  The dA-tailed DNA was then transferred to Eppendorf LoBind tubes.  #@NEW_LINE#@#  The ligation of the Oxford Nanopore adaptor was performed by adding 10 l adaptor mix, 2 l HP (hairpin adaptor), 50 l blunt/TA ligase master mix (NEB), and water to a final volume of 100 l, with a 10 min incubation at room temperature.  #@NEW_LINE#@#  Extra care was taken to mix reagents during the ligation and the following steps only through pipetting to avoid, as much as possible, unnecessary contact of the ligated and protein-bound DNA with the tube walls.  #@NEW_LINE#@#  ', 'The fragments with a hairpin ligated were selectively pulled down using Dynabeads His-Tag Isolation and Pulldown.  #@NEW_LINE#@#  A 10 l aliquot of beads was washed twice using 200 l of a 1:2 dilution of Oxford nanopore bead-binding buffer (BBB) and resuspended in 100 l undiluted BBB before adding to the sample.  #@NEW_LINE#@#  After a 5 min incubation at room temperature, the tube was placed on a magnetic rack and the supernatant removed.  #@NEW_LINE#@#  The beads were then washed twice with 200 l diluted BBB, and any excess of buffer was removed by aspiration with a pipette.  #@NEW_LINE#@#  The beads were resuspended in 25 l Oxford Nanopore Elution Buffer and left for 10 min at room temperature.  #@NEW_LINE#@#  The tube was placed on a magnetic rack and the library was transferred to a new tube.  #@NEW_LINE#@#  ', 'In parallel with the library preparation, the MinION was made ready for sequencing.  #@NEW_LINE#@#  A new flow cell (R7.3 chemistry) was loaded on the MinION and the Platform QC protocol in the MinKNOW software was run to assess the number of available pores for sequencing.  #@NEW_LINE#@#  At the end of the QC, the flow cell was primed by loading twice 150 l of a mix of 75 l Oxford nanopore-running buffer (2X), 72 l nuclease-free water, 3 l Fuel mix, and leaving at least a 10 min interval between subsequent loadings of buffer or library.  #@NEW_LINE#@#  Once the flow cell was ready, a mix of 6 l library, 3 l fuel mix, 75 l Oxford nanopore-running buffer (2X), nuclease-free water to a final volume of 150 l was loaded on the flow cell and the 48-h sequencing protocol was started.  #@NEW_LINE#@#  Additional aliquots of library were loaded after 4 and 24 h to increase yield.  #@NEW_LINE#@#  ', 'Once the sequencing run had begun, the Metrichor program ( https://metrichor.com) was started and the raw data were automatically uploaded for base calling (workflow 2D Basecalling rev 1.14).'  #@NEW_LINE#@#  


