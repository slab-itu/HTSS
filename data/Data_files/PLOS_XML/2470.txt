article id="http://dx.doi.org/10.1371/journal.pcbi.1006242"  #@NEW_LINE#@#  
title  #@NEW_LINE#@#  
Phylogeny-corrected identification of microbial gene families relevant to human gut colonization  #@NEW_LINE#@#  

Abstract  #@NEW_LINE#@#  
The mechanisms by which different microbes colonize the healthy human gut versus other body sites, the gut in disease states, or other environments remain largely unknown.  #@NEW_LINE#@#  Identifying microbial genes influencing fitness in the gut could lead to new ways to engineer probiotics or disrupt pathogenesis.  #@NEW_LINE#@#  We approach this problem by measuring the statistical association between a species having a gene and the probability that the species is present in the gut microbiome.  #@NEW_LINE#@#  The challenge is that closely related species tend to be jointly present or absent in the microbiome and also share many genes, only a subset of which are involved in gut adaptation.  #@NEW_LINE#@#  We show that this phylogenetic correlation indeed leads to many false discoveries and propose phylogenetic linear regression as a powerful solution.  #@NEW_LINE#@#  To apply this method across the bacterial tree of life, where most species have not been experimentally phenotyped, we use metagenomes from hundreds of people to quantify each species prevalence in and specificity for the gut microbiome.  #@NEW_LINE#@#  This analysis reveals thousands of genes potentially involved in adaptation to the gut across species, including many novel candidates as well as processes known to contribute to fitness of gut bacteria, such as acid tolerance in Bacteroidetes and sporulation in Firmicutes.  #@NEW_LINE#@#  We also find microbial genes associated with a preference for the gut over other body sites, which are significantly enriched for genes linked to fitness in an in vivo competition experiment.  #@NEW_LINE#@#  Finally, we identify gene families associated with higher prevalence in patients with Crohns disease, including Proteobacterial genes involved in conjugation and fimbria regulation, processes previously linked to inflammation.  #@NEW_LINE#@#  These gene targets may represent new avenues for modulating host colonization and disease.  #@NEW_LINE#@#  Our strategy of combining metagenomics with phylogenetic modeling is general and can be used to identify genes associated with adaptation to any environment.  #@NEW_LINE#@#  

Author_summary  #@NEW_LINE#@#  
Why do certain microbes and not others colonize our gut, and why do they differ between healthy and sick people?  #@NEW_LINE#@#  One explanation is the genes in their genomes.  #@NEW_LINE#@#  If we can find microbial genes involved in gut adaptation, we may be able to keep out pathogens and encourage the growth of beneficial microbes.  #@NEW_LINE#@#  One could look for genes that were present more often in prevalent microbes, and less often in rare ones.  #@NEW_LINE#@#  However, this ignores that related species are more likely to share an environment and also share many unrelated phenotypes simply because of common ancestry.  #@NEW_LINE#@#  To solve this problem, we used a method from ecology that accounts for phylogenetic relatedness.  #@NEW_LINE#@#  We first calculated gut prevalence for thousands of species using a compendium of shotgun sequencing data, then tested for genes associated with prevalence, adjusting for phylogenetic relationships.  #@NEW_LINE#@#  We found genes that are associated with overall gut prevalence, with a preference for the gut over other body sites, and with the gut in Crohns disease versus health.  #@NEW_LINE#@#  Many of these findings have biological plausibility based on existing literature.  #@NEW_LINE#@#  We also showed agreement with the results of a previously published high-throughput screen of bacterial gene knockouts in mice.  #@NEW_LINE#@#  These results, and this type of analysis, may eventually lead to new strategies for maintaining gut health.  #@NEW_LINE#@#  

Citation: Bradley PH, Nayfach S, Pollard KS (2018) Phylogeny-corrected identification of microbial gene families relevant to human gut colonization.  #@NEW_LINE#@#  PLoS Comput Biol 14(8):  #@NEW_LINE#@#  
           e1006242.  #@NEW_LINE#@#  

        https://doi.org/10.1371/journal.pcbi.1006242  #@NEW_LINE#@#  
Editor: Morgan Langille,  #@NEW_LINE#@#  
DAL, CANADA  #@NEW_LINE#@#  

Received: November 23, 2017; Accepted: May 29, 2018; Published:  August 9, 2018  #@NEW_LINE#@#  
Copyright:  Â© 2018 Bradley et al.  #@NEW_LINE#@#  This is an open access article distributed under the terms of the Creative Commons Attribution License, which permits unrestricted use, distribution, and reproduction in any medium, provided the original author and source are credited.  #@NEW_LINE#@#  
Data Availability: For this study, we used published data obtained from the NCBI SRA database; accession IDs are provided as S3 Table.  #@NEW_LINE#@#  We also used the MIDAS v1.0 database (http://lighthouse.ucsf.edu/MIDAS/midas_db_v1.0.tar.gz).  #@NEW_LINE#@#  
Funding: Funding for this research was provided by NSF grants DMS-1069303 and DMS-1563159 (www.nsf.gov), Gordon & Betty Moore Foundation grant #3300 (moore.org), and institutional funds from the Gladstone Institutes (gladstone.org).  #@NEW_LINE#@#  The funders had no role in study design, data collection and analysis, decision to publish, or preparation of the manuscript.  #@NEW_LINE#@#  
Competing interests:  The authors have declared that no competing interests exist.  #@NEW_LINE#@#  
Introduction  #@NEW_LINE#@#  
Microbes that colonize the human gastrointestinal (GI) tract have a wide variety of effects on their hosts, ranging from beneficial to harmful.  #@NEW_LINE#@#  Increasing evidence shows that commensal gut microbes are responsible for training and modulating the immune system [1, 2], protecting against inflammation [3] and pathogen invasion (reviewed in Sassone-Corsi and Raffatellu [4]), affecting GI motility [5], maintaining the intestinal barrier [6], and potentially even affecting mood [7].  #@NEW_LINE#@#  In contrast, pathogens (and conditionally-pathogenic microbes, or pathobionts) can induce and worsen inflammation [8, 9], increase the risk of cancer in mouse models [10], and cause potentially life-threatening infections [11].  #@NEW_LINE#@#  Additionally, the transplantation of microbes from a healthy host (fecal microbiota transplant, or FMT) is also a highly effective therapy for some gut infections [12], although it is still an active area of investigation why certain microbes from the donor persist long-term and others do not [13], and how pre-existing inflammatory disease affects FMT efficacy [14].  #@NEW_LINE#@#  Which microbes are able to persist in the GI tract, and why some persist instead of others, is therefore a question with consequences that directly impact human health.  #@NEW_LINE#@#  
Because of this, we are interested in the specific mechanisms by which microbes colonize the gut, avoiding other potential fates such as being killed in the harsh stomach environment, simply passing through the GI tract transiently, or being outcompeted by other gut microbes.  #@NEW_LINE#@#  Understanding these mechanisms could yield opportunities to design better probiotics and to prevent invasion of the gut community by pathogens.  #@NEW_LINE#@#  In particular, creating new therapies, whether those are drugs, engineered bacterial strains, or rationally designed communities, will likely require an understanding of gut colonization at the level of individual microbial genes.  #@NEW_LINE#@#  We also anticipate that these mechanisms may vary in health vs. disease, since, for example, different selective pressures are known to be present in inflamed versus healthy guts [15, 16].  #@NEW_LINE#@#  
One approach that has been used to link genetic features to a phenotype is to correlate the two using observational data.  #@NEW_LINE#@#  Most typically, this approach is applied in the form of genome-wide association mapping, in which phenotypes are correlated with genetic markers across individuals in a population.  #@NEW_LINE#@#  While we are interested in comparing phenotypes and genetic features across, rather than within species, the approach we take in this paper is conceptually similar.  #@NEW_LINE#@#  In order to perform association mapping, it is necessary to account for population structure, that is, dependencies resulting from common ancestry; otherwise, spurious discoveries can be made in genome-wide association studies [17].  #@NEW_LINE#@#  Analogously, we expected it to be important to choose a method that can account for the confounding effect of phylogeny when testing for associations across species.  #@NEW_LINE#@#  
There is increasing interest in using phylogenetic information to make better inferences about associations between microbes and quantities of interest.  #@NEW_LINE#@#  For example, co-conservation patterns of genes (correlogs) have been used to assign functions to microbial genes [18], and genome-wide association studies have been applied within a genus of soil bacteria [19] as well as across strains of Neisseria meningitidis [20].  #@NEW_LINE#@#  Recent publications have also described techniques that use information from the taxonomic tree to more accurately link clades in compositional taxonomic data to covariates [21, 22, 23].  #@NEW_LINE#@#  However, so far, only one study has attempted to associate genes with a preference for the gut [24].  #@NEW_LINE#@#  That study introduced a valuable method based on UniFrac and gene-count distances, which compares how well gut- vs. non-gut-associated microbes cluster on the species tree compared to a composite gene tree.  #@NEW_LINE#@#  This study also provides an important insight in the form of evidence of convergence of glycoside hydrolase and glycosyltransferase repertoires among gut bacteria, suggesting horizontal gene transfer within the gut community to deal with a common evolutionary pressure.  #@NEW_LINE#@#  The method described in that study, though, requires a binary phenotype of gut presence vs. absence.  #@NEW_LINE#@#  Deciding which microbes are gut vs. non-gut requires manual curation and can be somewhat subjective, as microbes have a continuous range of prevalences and can appear in multiple environments; this binarization could also potentially decrease power by excluding microbes with intermediate phenotypes.  #@NEW_LINE#@#  The method also requires multiple sequence alignments and trees to be built for every gene family under analysis, which are computationally intensive to generate over a large set of genomes.  #@NEW_LINE#@#  
We take a complementary approach and use a flexible technique, known as phylogenetic linear modeling, to detect associations between microbial genotype and phenotype while accounting for the fact that microbes are related to one another by vertical descent.  #@NEW_LINE#@#  Phylogenetic linear models have an extensive history in the ecology literature dating back to seminal works by Felsenstein [25] and Grafen [26].  #@NEW_LINE#@#  However, despite their power, genome-scale applications of these models are still few in number [27] and, with the exception of one recent study that applied phylogenetic linear modeling to newly-sequenced isolate genomes from plant-associated microbial communities [28], have typically been used to relate traits of macroorganisms (e.g., anole lizards [29]) to their genotypes.  #@NEW_LINE#@#  While there is a growing appreciation for the need to explicitly account for phylogeny in microbial community analyses [27, 30, 31], we believe ours is the first study to directly apply this class of methods to metagenomic data.  #@NEW_LINE#@#  
This approach to accounting for phylogenetic relationships is general and could be applied to measure association of any quantitative phenotype with genotypes or other binary or quantitative characteristics.  #@NEW_LINE#@#  In this study, we focus on phenotypes related to the ability of bacteria to colonize the human gut: 1. overall prevalence in the guts of hosts from a specific population (e.g., post-industrialized countries), which we expect to capture ease of transmission, how cosmopolitan microbes are, and how efficiently they colonize the gut; 2. a preference for the gut over other human body sites in the same hosts, which we expect to capture gut colonization more specifically; and 3. a preference for the gut in disease (e.g., Crohns disease) versus health.  #@NEW_LINE#@#  We present a novel analytic pipeline in which we estimate these quantitative phenotypes for thousands of bacterial species directly from existing shotgun metagenomics data, both obviating the need for us to draw a cutoff between gut and non-gut microbes, and also giving us the necessary power to detect associations (S2 Fig).  #@NEW_LINE#@#  Coupling these phenotype estimates with phylogenetic linear models, we generate a compendium of thousands of bacterial genes whose functions may be involved in colonizing the human gut.  #@NEW_LINE#@#  

Results  #@NEW_LINE#@#  
We present a phylogeny-aware method for modeling associations between the presence of specific genes in bacterial genomes and quantitative phenotypes that measure how common these species are in the human microbiome.  #@NEW_LINE#@#  To apply phylogenetic linear modeling to the microbiome, we needed to solve three problems.  #@NEW_LINE#@#  First, we had to show that these models controlled false positives and had reasonable power on large bacterial phylogenies.  #@NEW_LINE#@#  Second, we needed to develop estimators that captured meaningful phenotypes related to bacterial colonization of humans for thousands of diverse bacterial species, most of which have never been studied in isolation, much less experimentally assayed for their abilities to colonize a mammalian body site.  #@NEW_LINE#@#  The third problem was to estimate genotypes (e.g., gene presence-absence) for each species.  #@NEW_LINE#@#  The analysis framework we describe is quite general and could be easily extended to link other phenotypes to genotypes across the tree of life.  #@NEW_LINE#@#  
Phylogenetic_linear_models_solve_the_problem_of_high_false_positive_rates_when_testing_for_associations_on_bacterial_phylogenies  #@NEW_LINE#@#  
To test for associations between quantitative phenotypes and binary genotypes across species, we use models with the following form:  #@NEW_LINE#@#  
(1)  is a vector of quantitative phenotypes of interest, assessed in one environment ex out of a set of possible environments E, normalizing out a set of study effects D, estimated from the dataset A.  #@NEW_LINE#@#  The elements of the vector  are m,x,E,D(A), the phenotype value for microbe m. 0,g is a baseline phenotype value, 1,g is the effect of gene g on ,  is a vector whose elements Im,g are 0 if gene g is absent in species m and 1 if present, and  is the remaining unmodeled variation in .  #@NEW_LINE#@#  We fit one model per gene g. The distribution of the residuals  is the key difference between standard and phylogenetic linear models.  #@NEW_LINE#@#  In the standard model, the residuals are assumed to be independent and normally distributed.  #@NEW_LINE#@#  In the phylogenetic model, however, the residuals covary, with more closely-related species having greater covariance (see Methods, Modeling gene-phenotype associations and Fitting linear vs. phylogenetic models; for a glossary of notation, see S1 Appendix).  #@NEW_LINE#@#  
To explore the potential pitfalls of failing to correct for phylogenetic structure in cross-species association tests, we generated a species tree for thousands of bacteria with genome sequences (see Methods, Phylogenetic-tree-construction).  #@NEW_LINE#@#  In order to have a consistent operational definition of a microbial species, we used a set of previously defined bacterial taxonomic units with approximately 95% pairwise average nucleotide identity across the entire genome [32].  #@NEW_LINE#@#  The methods we describe can be applied to other taxonomic levels or with other species definitions.  #@NEW_LINE#@#  Using this species tree, we performed simulations (see Methods, Worked example.)  #@NEW_LINE#@#  for each of the four major bacterial phyla in the human gut (Bacteroidetes, Firmicutes, Proteobacteria, and Actinobacteria [33]).  #@NEW_LINE#@#  Specifically, we generated simulated phenotypes along the species tree, and then, for each phenotype, simulated a binary genotype for each species that covaried with the phenotype to varying degrees, including no association.  #@NEW_LINE#@#  We used levels of covariation spanning those we observed empirically between prevalence of species in gut metagenomes and presence-absence of genes (see below).  #@NEW_LINE#@#  (An effect size of 0.5 corresponds approximately to a 50% increase in prevalence, while an effect size of 1.0 corresponds approximately to a 72% increase in prevalence: see S8 Fig).  #@NEW_LINE#@#  These binary genotypes also had varying levels of overall phylogenetic signal (as measured using Ives-Garland  [34]).  #@NEW_LINE#@#  
We then fit phylogenetic and standard linear models to the simulated data and tested for a relationship between each binary genotype and its corresponding continuous phenotype.  #@NEW_LINE#@#  For both standard and phylogenetic linear models, separate models were fit for each of the four phyla.  #@NEW_LINE#@#  The results were used to estimate false positive rate (Type I error) and power (1Type II error) for the two methods across different effect sizes.  #@NEW_LINE#@#  
These analyses showed that standard linear models result in many false positive associations.  #@NEW_LINE#@#  When the binary genotype was specified to be wholly uncorrelated (i.e., under the null), p-values from the linear model showed a strong anticonservative bias (Fig 1B and 1D) with many more significant p-values than expected under no correlation.  #@NEW_LINE#@#  While lower levels of phylogenetic signal (larger Ives-Garland ) did result in less bias in the standard linear model, the average false positive rate ranged between 20% and 68% at p = 0.05.  #@NEW_LINE#@#  In contrast, the phylogenetic linear model p-value distribution was flat and Type I error was controlled appropriately (Fig 1A and 1C).  #@NEW_LINE#@#  This means that at the same p-value threshold, linear models will identify many spurious relationships compared to phylogenetic linear models.  #@NEW_LINE#@#  Further, our simulations with non-zero associations showed that the phylogenetic model has high power when applied to gut bacterial phyla, even for small effect sizes (Fig 1E; see Methods, Power-analysis).  #@NEW_LINE#@#  These results emphasize the importance of using models that account for phylogenetic relationships in cross-species association testing and demonstrate the feasibility of applying phylogenetic linear models to the human microbiome.  #@NEW_LINE#@#  

Estimating_quantitative_phenotypes_from_shotgun_data  #@NEW_LINE#@#  
To apply phylogenetic linear modeling to the microbiome we sought to define meaningful phenotypes for thousands of bacterial species, all of which have genome sequences but most of which have never been experimentally tested for, e.g., their abilities to grow on particular substrates or to colonize a model mammalian gut.  #@NEW_LINE#@#  We hypothesized that the prevalence and specificity of bacterial species in an environment, such as the human gut, should relate to their ability to colonize that environment and to how well adapted they are to persist there.  #@NEW_LINE#@#  These quantities can be thought of as phenotypes that can be estimated directly from shotgun metagenomics data.  #@NEW_LINE#@#  The precise taxonomic composition of a healthy gut microbiome can vary significantly from person to person [35], indicating that the ability of a microbe to colonize the gut is quantitative (and likely context-dependent, and stochastic).  #@NEW_LINE#@#  This phentoype can be conceptualized differently depending on which aspects of colonization one wishes to capture.  #@NEW_LINE#@#  We present metagenome-based estimators for two different types of colonization phenotpyes.  #@NEW_LINE#@#  These are described in the context of our goal of studying the gut microbiome, but the approach is general and could be used to quantify how well a given genotype discriminates species found in or specific to any environment.  #@NEW_LINE#@#  
The first phenotype is the probability of observing a microbial species m in an environment ex, that is, its overall prevalence P(m|ex).  #@NEW_LINE#@#  Both genes relating to survival in the GI tract and genes relating to survival, persistence, and dispersal in the outside environment are expected to correlate with overall prevalence.  #@NEW_LINE#@#  Prevalence can be estimated by the frequency with which the species is observed in a sample from the environment, for example, using a logit transform to enable linear modeling and pseudocounts to avoid estimates of 0 or 1 (see Methods, Estimating the prevalence phenotype).  #@NEW_LINE#@#  
The second type of quantitative phenotype is the environmental specificity of a microbial species, which we define as the conditional probability that a sample is derived from one environment in a set of environments, given that the species is present in the sample.  #@NEW_LINE#@#  This parameter captures the power of a given microbe as a marker to discriminate between two or more different environments, such as different body sites or types of hosts (see Methods, Estimating environmental specificity scores).  #@NEW_LINE#@#  This is distinct from its overall prevalence in the environment.  #@NEW_LINE#@#  
We developed an estimator for environmental specificity and applied it to two separate gut microbial phenotypes.  #@NEW_LINE#@#  First, we considered a phenotype defined as the conditional probability that a given body site is the gut and not another body site, given that a particular species is present.  #@NEW_LINE#@#  The physical distance between body sites is much smaller than the distance between hosts, and microbes from one body site are likely to be transiently introduced to others.  #@NEW_LINE#@#  Hence, enrichment of a species in one body site over others is stronger evidence for selection (versus dispersal) than is overall prevalence in that body site alone.  #@NEW_LINE#@#  We estimate this parameter with a body-site specificity score that uses metagenomics data to measure how predictive a particular microbe is for the gut versus other body sites (e.g., skin, urogenital tract, oropharynx, or lung).  #@NEW_LINE#@#  
The second type of environmental specificity we considered is the conditional probability that a host has a disease given that a particular species is present.  #@NEW_LINE#@#  This disease-specific specificity score is estimated in a similar way to the body-site specificity score (see Methods, Estimating environmental specificity scores).  #@NEW_LINE#@#  We focus on Crohns disease, a type of inflammatory bowel disease known to be associated with dramatic shifts in the gut microbiota and in gut-immune interactions [36].  #@NEW_LINE#@#  Genes associated with this disease-specific prevalence could illuminate differences in selective pressures between healthy vs. diseased gut environments.  #@NEW_LINE#@#  Both scores are based on maximum a posteriori (MAP) estimates of the conditional probability of a sample being from the gut given that a microbe is observed in the sample.  #@NEW_LINE#@#  To account for sampling noise, we use a shrunken estimate with a Laplace prior (see Methods, Estimating environmental specificity scores).  #@NEW_LINE#@#  

Genes_associated_with_species_prevalence_in_healthy_human_gut_metagenomes  #@NEW_LINE#@#  
We assembled a compendium of published DNA sequencing data from healthy human stool microbiomes across five studies in North America, Europe, and China (426 subjects total).  #@NEW_LINE#@#  Using the MIDAS database and pipeline [32], we mapped metagenomic sequencing reads from each run to a panel of phylogenetic marker genes, and from these, estimated the relative abundances of species.  #@NEW_LINE#@#  Multiple runs corresponding to the same individual were averaged.  #@NEW_LINE#@#  We then estimated the prevalence (probability of non-zero abundance) of each species across these subjects, weighting each study equally and adding pseudocounts to avoid probabilities of exactly 0 or 1 (see Methods, Estimating the prevalence phenotype).  #@NEW_LINE#@#  Finally, we determined whether genes (here, we take genes to mean members of a FIGfam protein family, which are designed to approximate isofunctional homologs [37]) were present or absent in the pangenomes of each species, based on sequenced genomes included in the MIDAS database, such that any FIGfam annotated in at least one sequenced isolate was considered to be present in the pangenome.  #@NEW_LINE#@#  This approach to genotyping could be extended to additionally include single-amplified genomes and metagenome-assembled genomes (see Discussion).  #@NEW_LINE#@#  Our analysis framework can also be applied to genotypes other than gene presence-absence (e.g., nucleotide or amino acid changes).  #@NEW_LINE#@#  We note that while the FIGfam database does include many hypothetical protein families of unknown function, many bacterial genes lack even this level of annotation, so a more comprehensive grouping of genes into orthologous or functionally homologous groups could reveal yet more novel associations.  #@NEW_LINE#@#  
As expected, the most prevalent species overall included Bacteroides vulgatus, Bacteroides ovatus, and Faecalibacterium prausnitzii, while the least prevalent included halophiles and thermophiles (S1 Table).  #@NEW_LINE#@#  Gut prevalence had a strong phylogenetic signal (Pagels  = 0.97, likelihood-ratio p less_than 1022), meaning that it was strongly correlated with the evolutionary relatedness of species.  #@NEW_LINE#@#  This emphasizes the need for phylogeny-aware modeling so that signal linking genes to prevalence will not be drowned out by shared variation in gene content between closely-related species.  #@NEW_LINE#@#  
To demonstrate the effect of phylogenetic correlation empirically, we fit both a standard linear model and a phylogenetic linear model for each of the four common gut phyla and all genes present in that phylum.  #@NEW_LINE#@#  These models relate logit-transformed estimates of the prevalence of different species in a phylum to a genes presence-absence in those species pangenomes.  #@NEW_LINE#@#  Recall that the residual variation in logit-prevalence is independent and normally distributed in the standard linear model, but has a distribution encoding correlations proportional to species relatedness in the phylogenetic linear model (see Methods, Fitting linear vs. phylogenetic models).  #@NEW_LINE#@#  For both standard and phylogenetic linear models, separate models were fit for each phylum.  #@NEW_LINE#@#  While this means that genes weakly-associated across the entire tree of life may have been missed by this approach, it has the advantage of both reducing the memory needed to store the gene presence-absence matrix and allowing for phylum-specific rates of evolution for our phenotype of interest.  #@NEW_LINE#@#  We modeled associations for 144,651 genes total across the four phyla, fitting 190,923 models total (since some genes are present in multiple phyla).  #@NEW_LINE#@#  
We used the parameter estimates and their standard errors from fitted models to test null hypotheses of the form H0: 1,g = 0, meaning gene g is not associated with gut prevalence of species in a particular phylum.  #@NEW_LINE#@#  The p-values were adjusted for multiple testing using the false discovery rate (FDR) (see Methods, Fitting linear vs. phylogenetic models).  #@NEW_LINE#@#  We found 9,455 FIGfam gene families positively associated with logit-prevalence within at least one phylum (FDR q  0.05) using phylogenetic linear models, 47% of which had no annotated function.  #@NEW_LINE#@#  We observed that 75% of the significant genes from these tests had effect sizes larger than (Bacteroidetes) 0.95, (Firmicutes) 1.09, (Proteobacteria) 0.35, and (Actinobacteria) 2.08, which are within the range of effect sizes for which phylogenetic linear models showed good performance in simulations (see above).  #@NEW_LINE#@#  
With standard linear models our tests identified 25,226 genes positively associated with gut prevalence, substantially more than with phylogenetic linear models (17.4% versus 6.5% of total).  #@NEW_LINE#@#  Based on our simulations, these likely included many false positives.  #@NEW_LINE#@#  The top results of phylogenetic versus standard linear models (Fig 2) illustrate the pitfalls of not correcting for phylogenetic correlation.  #@NEW_LINE#@#  Using the standard model, we recover associations such as those seen in Fig 2A and 2B: a subunit of dihydroorotate dehydrogenase in Bacteroidetes (Fig 2B) and in Firmicutes, a particular type of glutamine synthetase (Fig 2A).  #@NEW_LINE#@#  While these associations might look reasonable at a first glance, on closer inspection, they depend on the fact that these genes are near-uniformly present in entire clades of bacteria.  #@NEW_LINE#@#  These clades are, in general, more prevalent in the gut compared to the rest of the species in the tree.  #@NEW_LINE#@#  However, any finer structure relating to differences between close neighbors is lost.  #@NEW_LINE#@#  For example, dihydroorotate dehydrogenase (Fig 2B) is found not only in the human gut commensal Bacteroides caccae, but also in its relative Bacteroides reticulotermitis, which was not only low-prevalence in our samples but was indeed isolated from the gut of a subterranean termite [38].  #@NEW_LINE#@#  
While this alone does not necessarily constitute evidence against these genes having adaptive functions in the human gut, we do expect that matched pheno- and genotypic differences between close phylogenetic neighbors offer stronger evidence for an association.  #@NEW_LINE#@#  An analogy can be drawn with genome-wide association mapping in humans: models that do not account for correlations between sites caused by population structure, as opposed to selective pressure, will tend to identify more spurious associations.  #@NEW_LINE#@#  In contrast, because the phylogenetic null model expects phenotypic correlations to scale with the evolutionary distance between species, this approach will tend to upweight cases where phylogenetically close relatives have different phenotypes and where distant relatives have similar phenotypes.  #@NEW_LINE#@#  This leads to the identification of candidate genes that capture more variation between close neighbors (Fig 2C and 2D).  #@NEW_LINE#@#  Thus, phylogenetic linear models will identify genes whose presence in genomes is more frequently changing between sister taxa in association with a phenotype.  #@NEW_LINE#@#  
We provided further evidence that this trend is true in general by calculating the phylogenetic signal of the top hits from each model using Ives and Garlands  [34].  #@NEW_LINE#@#  This statistic captures the rate of transitions between having and not having a binary trait (here, a gene) across a tree; higher values therefore correspond to more disagreement between closely related species and lower values correspond to more agreement.  #@NEW_LINE#@#  Indeed, across all four phyla, the linear model identified gene families with significantly lower Ives-Garland  than the phylogenetic model (Fig 2E, linear model p less_than 1016), indicating that these genes presence versus absence tended to be driven more by clade-to-clade differences (i.e., shared evolution).  #@NEW_LINE#@#  
These results suggest that standard linear models can identify genes that are truly important for colonizing an environment, such as the healthy human gut, but in addition will identify other genes that may simply be common in clades associated with that environment.  #@NEW_LINE#@#  The latter set will likely include many false positive associations from the perspective of understanding functions necessary for living in the environment.  #@NEW_LINE#@#  Phylogenetic linear models overcome this problem by adding the expectation that closely-related species will have similar phenotypes and distantly-related species will have less similar phenotypes, effectively upweighting instances where this is not the case.  #@NEW_LINE#@#  These conclusions are supported by our simulations and by an in vivo functional screen (see Results, Deletion of gut-specific genes lowers fitness in the mouse microbiome).  #@NEW_LINE#@#  

Gene_families_associated_with_gut_prevalence_provide_insight_into_colonization_biology  #@NEW_LINE#@#  
Several of the gene families that we observed to be associated with gut prevalence have previously been linked to gut colonization efficiency.  #@NEW_LINE#@#  For example, in Firmicutes, we noticed that several top hits were annotated as sporulation proteins (e.g., Stage 0 sporulation two-component response regulator, Fig 2C).  #@NEW_LINE#@#  Sporulation is known to be a strategy for surviving harsh environments (such as acid, alcohol, and oxygen exposure) that is used by many, but not all, members of Firmicutes.  #@NEW_LINE#@#  Resistance to oxygen (aerotolerance) is particularly important because many gut Firmicutes are strict anaerobes [39], sporulation is known to be an important mechanism of transmission and survival in the environment (reviewed in Swick et al.  #@NEW_LINE#@#  [40]), and sporulation ability has been linked to transmission patterns of gut microbes [32].  #@NEW_LINE#@#  Our result associating sporulation proteins to gut prevalence provides further evidence for sporulation as a strategy that is generally important for the propagation and fitness of gut microbes.  #@NEW_LINE#@#  
In Bacteroidetes, we observed an association between gut prevalence and the presence of a pair of gene families putatively assigned to the GAD operon, namely, the glutamate decarboxylase gadB and the glutamate/gamma-aminobutyric acid (GABA) antiporter gadC.  #@NEW_LINE#@#  These genes show a complex pattern of presence that is strongly correlated with gut prevalence (Fig 2D, S5 Fig).  #@NEW_LINE#@#  Results from research in Proteobacteria, where these genes were first described, shows that their products participate in acid tolerance.  #@NEW_LINE#@#  L-glutamate must be protonated in order to be decarboxylated to GABA; export of GABA coupled to import of fresh L-glutamate therefore allows the net export of protons, raising intracellular pH [41].  #@NEW_LINE#@#  It was previously hypothesized that this acid tolerance mechanism allowed bacteria to survive the harshly acidic conditions in the stomach: indeed, if disrupted in the pathogen Edwardsiella tarda, gut colonization in a fish model is impaired [42].  #@NEW_LINE#@#  Listeria monocytogenes with disrupted GAD systems also become sensitive to porcine gastric fluid [43].  #@NEW_LINE#@#  However, while it has previously been shown that gut Bacteroides do contain homologs for at least one of these genes [41], their functional importance has not yet been demonstrated in this phylum.  #@NEW_LINE#@#  Our results provide preliminary evidence that this system may be important in Bacteroidetes as well as in Proteobacteria.  #@NEW_LINE#@#  

Using_body_sites_as_a_control_allows_us_to_differentiate_general_dispersal_from_a_specific_gut_advantage  #@NEW_LINE#@#  
The previous analyses have focused on modeling the phenotype of overall prevalence in the human gut.  #@NEW_LINE#@#  However, microbes could be prevalent in the gut for at least two main reasons.  #@NEW_LINE#@#  First, they could be specifically well-adapted to the human gut; second, they could simply be very common in the environment (i.e., highly dispersed).  #@NEW_LINE#@#  The presence or absence of a gene family could enhance either of these properties.  #@NEW_LINE#@#  Some genes might, for example, confer improved stress tolerance that was adaptive across a range of harsh conditions, while others might allow, for example, uptake and catabolism of metabolic substrates that were more common in the human gut than in other environments.  #@NEW_LINE#@#  
With this in mind, we analyzed the relative enrichment of microbes in the gut over other human body sites in 127 individuals from the Human Microbiome Project (HMP) study [35].  #@NEW_LINE#@#  We chose other body sites as a control because the physical distance between sites within a host is much smaller than the distance between people, and microbes from one body site are likely to be commonly, if transiently, introduced to other body sites (e.g., skin to oral cavity).  #@NEW_LINE#@#  To find specifically gut-associated genes, we used the phylogenetic linear model to regress gene presence-absence on the logit-transformed conditional probability P(eGut|m), i.e., the probability that a body site was the human gut given that a particular species m was observed, which we estimated using Laplace regularization (see Methods, Estimating-environmental-specificity).  #@NEW_LINE#@#  We identified 4,274 genes whose presence in bacterial genomes was positively associated with those species being present in the gut versus other body sites in at least one phylum (374 in Bacteroidetes, 1,515 in Firmicutes, 1,194 in Proteobacteria, and 1,255 in Actinobacteria).  #@NEW_LINE#@#  
Overall, the effect sizes for genes learned from this body site-specific model correlated only moderately with those learned from the gut prevalence models (median r = 0.26, range 0.140.35), indicating that these two quantitative phenotypes describe distinct phenomena.  #@NEW_LINE#@#  Additionally, the overlap between significant (q  0.05) hits for both models was usually small (median Jaccard index 0.056, range 0.0350.343).  #@NEW_LINE#@#  These results are not surprising given that our regularized estimates of gut specificity were only moderately correlated with overall gut prevalence (Spearmans  = 0.06, Pearsons r = 0.31, S1 Fig), even when prevalence was calculated only from HMP gut samples (Spearmans  = 0.05, Pearsons r = 0.40).  #@NEW_LINE#@#  This may arise from different genes being involved in dispersal or adaptation to many different environments versus those involved in adaptation specifically to the gut.  #@NEW_LINE#@#  
Indeed, when we compare the enrichments for genes significant in either the body site or overall prevalence models, we observe large functional shifts (Fig 3).  #@NEW_LINE#@#  For example, in the gut prevalence model, but not the body site-specific model, Firmicutes were strongly enriched for dormancy and sporulation (q = 4.4 Ã 105).  #@NEW_LINE#@#  Because sporulation is likely useful in a wide range of environments beyond the gut, this result seems intuitive.  #@NEW_LINE#@#  Body site-specific results for Firmicutes were instead enriched for genes involved in phosphorus metabolism (q = 0.14) and in particular the term high affinity phosphate transporter and control of PHO regulon (q = 0.058).  #@NEW_LINE#@#  
We also observed biologically-justified individual gene families that were significant in the body site-specific model (q  0.05) but not the overall gut prevalence model (q  greater than  0.5 and/or wrong sign of effect size).  #@NEW_LINE#@#  In Firmicutes, for example, carnitine dehydratase and bile acid 7-alpha dehydratase were both significant only in the body site-specific model, suggesting a specific role for these genes within the gut environment.  #@NEW_LINE#@#  Indeed, bile acids are metabolites of cholesterol that are produced by vertebrates and thus unlikely to be encountered outside of the host.  #@NEW_LINE#@#  While the metabolite L-carnitine is made and used in organisms spanning the tree of life, it is particularly concentrated in animal tissue and especially red meat, and cannot be further catabolized by humans [44], making it available to intestinal microbes.  #@NEW_LINE#@#  Bile acid transformation by gut commensals is a well-established function of the gut microbiome, with complex influences on health (reviewed in Staley et al.  #@NEW_LINE#@#  [45]).  #@NEW_LINE#@#  
In Bacteroidetes, we found that a homolog of the autoinducer 2 aldolase lsrF was significant only in the body site-specific model.  #@NEW_LINE#@#  Autoinducer 2 is a small signaling molecule produced by a wide range of bacteria that is involved in interspecies quorum sensing.  #@NEW_LINE#@#  The protein lsrF, specifically, is part of an operon whose function in Escherichia coli is to quench or destroy the AI-2 signal [46].  #@NEW_LINE#@#  Further, an increase of the AI-2 signal has been shown to decrease the Bacteroidetes/Firmicutes ratio in vivo in the intestines of streptomycin-treated mice [47].  #@NEW_LINE#@#  Degrading this molecule is therefore a plausible gut-specific colonization strategy for gut Bacteroidetes.  #@NEW_LINE#@#  These discovered associations make the genes involved, including many genes without known functions or roles in gut biology, excellent candidates for understanding how bacteria adapt to the gut environment.  #@NEW_LINE#@#  

Deletion_of_gut-specific_genes_lowers_fitness_in_the_mouse_microbiome  #@NEW_LINE#@#  
Beyond finding evidence for the plausibility of individual genes based on the literature, we were interested in whether more high-throughput experimental evidence supported the associations we found between gut colonization and gene presence.  #@NEW_LINE#@#  To interrogate this, we used results from an in vivo transposon-insertion screen of four strains of Bacteroides.  #@NEW_LINE#@#  This screen identified many genes whose disruption caused a competitive disadvantage in gnotobiotic mice, as revealed by time-course high-throughput sequencing; 79 gene families significantly affected microbial fitness across all four strains tested [48].  #@NEW_LINE#@#  Determining agreement with this screen is somewhat complicated by the fact that we associated gene presence to gut specificity across all members of the phylum Bacteroidetes, and not only within the Bacteroides genus.  #@NEW_LINE#@#  Significance of overlap therefore depends on what we take as the null background set, the cutoff used for significance, and the set of results from the screen we choose as true positives (S3 Table).  #@NEW_LINE#@#  
Despite these complications, this analysis clearly showed that the 79 genes whose disruption led to lower fitness in the murine gut across all four Bacteroides species were over-represented among our predictions for gut-specific genes (odds ratio = 4.67, q = 6.7 Ã 103), and remained so if we only considered the gene families that were present in all Bacteroides species (odds ratio = 7.02, q = 3.4 Ã 103) (Table 1).  #@NEW_LINE#@#  Interestingly, we observed the opposite pattern for the overall prevalence model: the prevalence-associated genes we identified were actually depleted for genes found to be important in vivo (odds ratio = 0.18, q = 1.1 Ã 102).  #@NEW_LINE#@#  We believe that this is because the body-site-specific model, like the experiment, focused specifically on colonization efficiency, while the overall gut prevalence model would have included genes involved in persistence and dispersal in the environment and transfer between hosts.  #@NEW_LINE#@#  This experimental evidence supports the idea that environment-specific phylogenetic linear models truly identify genes that are important for bacteria to colonize an environment.  #@NEW_LINE#@#  

We_identify_Proteobacterial_gene_families_associated_with_microbes_that_are_more_prevalent_in_Crohn_s_disease  #@NEW_LINE#@#  
The above analyses were performed with respect to the gut of healthy individuals from the mainly post-industrial populations of North America, Europe and China.  #@NEW_LINE#@#  However, we also know that taxonomic shifts are common between healthy guts versus the guts of individuals from the same population with diseases such as type 2 diabetes, colorectal cancer, rheumatoid arthritis, and inflammatory bowel disease (reviewed in Wang et al.  #@NEW_LINE#@#  [49]).  #@NEW_LINE#@#  One explanation for these results is that sick hosts select for specific microbial taxa, as with the links previously observed between Proteobacteria and the inflammation that accompanies many disease states [50].  #@NEW_LINE#@#  Since gut microbes have also been implicated in altering disease progression (reviewed in Lynch and Pedersen [51]), identifying genes associated with colonizing diseased individuals may afford us new opportunities for intervention.  #@NEW_LINE#@#  
To identify microbiome functions that could be involved in disease-specific adaptation to the gut, we looked for genes that were present more often in microbes that discriminated case from control subjects.  #@NEW_LINE#@#  Specifically, we compared n = 38 healthy controls from the MetaHIT consortium to n = 13 individuals with Crohns disease [52, 53].  #@NEW_LINE#@#  Similar to our analysis of gut versus other body sites, we used the conditional probability that a subject had Crohns disease given that we observed a particular microbe in their gut microbiome P(eCD|M) (see Methods).  #@NEW_LINE#@#  We identified 1,841 genes whose presence in bacterial genomes was associated with Crohns after correcting for phylogenetic relationships in at least one phylum (796 in Bacteroidetes, 278 in Firmicutes, 467 in Proteobacteria, and 340 in Actinobacteria).  #@NEW_LINE#@#  
Eleven of our top Proteobacterial associations were annotated as fimbrial proteins, including one predicted to be involved specifically in the biosynthesis of type 1 fimbriae, or pili (FimI, association q = 2.8 Ã 103), cell surface structures involved in attachment and invasion.  #@NEW_LINE#@#  Crohns pathology has been linked to an immune response to invasive bacteria, and adherent-invasive E. coli (AIEC) appear to be overrepresented in ileal Crohns [54].  #@NEW_LINE#@#  In an AIEC E. coli strain isolated from the ileum of a Crohns patient, type 1 pili were required for this adherent-invasive phenotype [55].  #@NEW_LINE#@#  Chronic infection by AIEC strains was also observed to lead to chronic inflammation, and to an increase in Th17 cells and a decrease in CD8+ T cells similar to that observed in Crohns patients [56].  #@NEW_LINE#@#  
An additional striking feature of the results was the number of Proteobacterial proteins associated with greater risk of Crohns that were annotated as being involved in type IV secretion and conjugative transfer systems (Fishers test q = 4.9 Ã 104).  #@NEW_LINE#@#  Conjugative transfer is a process by which gram-negative bacteria in direct physical contact share genetic material.  #@NEW_LINE#@#  More specifically, many of these genes, including one annotated as TraR (Fig 4), were homologs of those involved in an F-type conjugal system for transferring IncF plasmids, which can be classified as a variety of type IV secretion system [57].  #@NEW_LINE#@#  Previously, in a mouse model, gut inflammation was shown to stimulate efficient horizontal gene transfer in Proteobacteria by promoting blooms of Enterobacteriaceae and thus facilitating cell-to-cell contact [58].  #@NEW_LINE#@#  Future work will be required to determine whether this increased conjugation is a neutral consequence of inflammation, a causative factor, or provides a selective advantage in the inflamed gut.  #@NEW_LINE#@#  


Discussion  #@NEW_LINE#@#  
The present analyses represent a first look into what can be learned by combining shotgun metagenomics with phylogenetically-aware models.  #@NEW_LINE#@#  Several extensions to our work could be made in the future.  #@NEW_LINE#@#  First, in addition to modeling prevalence, for instance, we could model abundance using a phylogenetic linear model with random effects [59], potentially allowing us to learn what controls the steady-state abundance of species in the gut.  #@NEW_LINE#@#  Additionally, we could also use these models to screen for epistatic interactions, which would be near-intractable even in systems with well-characterized genetic tools, but for which a subset of hypotheses could be validated by, e.g., comparing the fitness of wild-type microbes with double knockouts.  #@NEW_LINE#@#  While controlling the total number of tests would still be important to preserve power, an automated, computational approach to detecting gene interactions would still offer important savings in time and expense over developing a genome-wide experimental library of multiple knockouts per organism under investigation.  #@NEW_LINE#@#  
Currently, these analyses estimate species abundance and gene presence-absence from available sequenced isolate genomes.  #@NEW_LINE#@#  However, it has been estimated that on average 51% of genomes in the gut are from novel species [32].  #@NEW_LINE#@#  Especially for case/control comparisons, using information from metagenomic assemblies could enable quantification of species with no sequenced representatives, and would yield a more accurate estimate of the complement of genes in the pangenome for species that do have sequenced representatives.  #@NEW_LINE#@#  This would be particularly helpful in gut communities from individuals in non-industrialized societies that are enriched for novel microbial species [32].  #@NEW_LINE#@#  In fact, genes then could be treated as quantitative variables (e.g., coverage or prevalence) rather than binary, which is possible for covariates in phylogenetic linear models and simply changes the interpretation of the association coefficient 1,g.  #@NEW_LINE#@#  
Another potential extension would be to model prevalence and environment-specific prevalence for taxa other than the species clusters analyzed in this study.  #@NEW_LINE#@#  We focused on four prevalent and abundant phyla of bacteria, but our methods could be applied more broadly as long as quantitative phenotypes and genotypes could be accurately estimated.  #@NEW_LINE#@#  Phylogenetic linear modeling could also be applied directly to genera or higher taxonomic groups, although both phenotypes and genotypes would be averaged over more diverse sets of genomes, which could result in associations with different signs canceling out.  #@NEW_LINE#@#  As more genome and metagenome data is generated for microbial populations over time, extensions of phylogenetic linear modeling (e.g., with random effects [59]) may also be useful for studying associations between phenotypes and evolving gene copy number and single nucleotide variants at the strain level.  #@NEW_LINE#@#  This application would require accurate trees with strains as leaves, each with estimates of a phenotype and genotype.  #@NEW_LINE#@#  Additionally, our current definition of species approximates a 95% average nucleotide identity (ANI) cutoff; while this approach is a standard bioinformatic approach [60], and appears to be a natural boundary in analyses of genome compendia [61], the precise definition of a bacterial species remains a matter of active debate, and in the future may include phenotypic information [62] or information about gene flow [63].  #@NEW_LINE#@#  Beyond prevalence, other phenotypes will also be interesting to investigate, especially experimentally measured phenotypes from high throughput screens and other techniques that complement genomics.  #@NEW_LINE#@#  
In summary, using phylogenetic linear models, we were able to discover thousands of specific gene families associated with quantitative phenotypes calculated directly from data: overall gut prevalence, a specificity score for the gut over other body sites, and a specificity score for the gut in Crohns disease versus health.  #@NEW_LINE#@#  Importantly, we have shown through simulation and real examples that standard linear models are inadequate for this task because of an unacceptably high false-positive rate under realistic conditions.  #@NEW_LINE#@#  Furthermore, many of the results we found also have biological plausibility, both from the literature on specific microbial pathways and from a high-throughput in vivo screen directly measuring colonization efficiency.  #@NEW_LINE#@#  In addition to these expected discoveries, we also found thousands of novel candidates for understanding and potentially manipulating gut colonization.  #@NEW_LINE#@#  These results illustrate the potential of integrating phylogeny with shotgun metagenomic data to deepen our understanding of the factors determining which microbes come to constitute our gut microbiota in health and disease.  #@NEW_LINE#@#  

Methods  #@NEW_LINE#@#  
A graphical overview of our statistical methods can be found in S2 Fig Additionally, we provide a glossary of mathematical notation used in this section in S1 Appendix.  #@NEW_LINE#@#  
Species_definition  #@NEW_LINE#@#  
We utilized the previously published clustering of 31,007 high-quality bacterial genomes into 5,952 species from the MIDAS 1.0 database [32] (http://lighthouse.ucsf.edu/MIDAS/midas_db_v1.0.tar.gz).  #@NEW_LINE#@#  These species clusters are sets of genomes with high pairwise sequence similarity across a panel of 30 universal, single-copy genes.  #@NEW_LINE#@#  The genomes in each species clustering have approximately 95% average genome-wide nucleotide identity, a common gold-standard definition of bacterial and archaeal species [64].  #@NEW_LINE#@#  These species-level taxonomic units are similar to, but can differ from, operational taxonomic units (OTUs) defined solely on the basis of the 16S rRNA gene.  #@NEW_LINE#@#  
Taxonomic annotations for each species were drawn from the MIDAS 1.0 database.  #@NEW_LINE#@#  Some taxonomic annotations of species in the MIDAS database were incomplete; these were fixed by searching the NCBI Taxonomy database using their web API via the rentrez package [65] and retrieving the full set of taxonomic annotations.  #@NEW_LINE#@#  

Pangenomes  #@NEW_LINE#@#  
Pangenomes for all species used in this study were downloaded from the MIDAS 1.0 database.  #@NEW_LINE#@#  As previously described [32], pangenomes were constructed by clustering the DNA sequences of the genes found across all strains of each species at 95% sequence identity using UCLUST [66].  #@NEW_LINE#@#  Pangenomes were functionally annotated based on the FIGfams [37] which were included in the MIDAS databases and originally obtained from the PATRIC [67] database.  #@NEW_LINE#@#  Thus, each pangenome represents the set of known, non-redundant genes from each bacterial species with at least one sequenced isolate.  #@NEW_LINE#@#  

Phylogenetic_tree_construction  #@NEW_LINE#@#  
The tree used for phylogenetic analyses was based on the tree from Nayfach et al.  #@NEW_LINE#@#  [32] based on an approximate maximum likelihood using FastTree 2 [68] on a concatenated alignment (using MUSCLE [69]) of thirty universal genes.  #@NEW_LINE#@#  Thus, each tip in the tree represents the phylogenetic placement for one bacterial species.  #@NEW_LINE#@#  For the current analyses, the tree was rooted using the cyanobacterium Prochlorococcus marinus as an outgroup, and the tree was then divided by phylum, retaining the four most prevalent phyla in the human gut (Bacteroidetes, Firmicutes, Actinobacteria, and Proteobacteria).  #@NEW_LINE#@#  One Actinobacterial species cluster, the radiation-resistant bacterium Kineococcus radiotolerans, was dropped from the tree because it had an extremely long branch length, indicating an unusual degree of divergence.  #@NEW_LINE#@#  Finally, phylum-specific trees were made ultrametric using the chronos function in the R package ape [70], assuming the default correlated rates model of substitution rate variation.  #@NEW_LINE#@#  We performed this step because first, our taxa were contemporaneously sampled, and second, we assumed that our phenotypes of interest varied with divergence time, as opposed to the number of substitutions per site separating marker gene sequences [71].  #@NEW_LINE#@#  

Estimating_species_abundance_across_human_associated_metagenomes  #@NEW_LINE#@#  
Metagenome samples were drawn from subjects in the Human Microbiome Project (HMP) [35], the MetaHIT consortium [52, 53], a study of glucose control [72], and a study of type 2 diabetes [73].  #@NEW_LINE#@#  Accession numbers were identified using the aid of SRAdb [74] and downloaded from the Sequence Read Archive (SRA) [75].  #@NEW_LINE#@#  The relative abundance of bacterial species in the metagenomes was estimated using MIDAS v1.0 [32], which maps reads to a panel of 15 phylogenetic marker genes.  #@NEW_LINE#@#  Species relative abundances are computed as previously described [32] (Species abundance estimation): essentially, they are normalized counts of reads mapping to bacterial species, with non-uniquely mapped reads assigned probabilistically.  #@NEW_LINE#@#  
Accession IDs used can be found in S4 Table.  #@NEW_LINE#@#  For prevalence estimates, we used healthy subjects from all four cohorts; for body site comparisons, we used only healthy subjects from HMP [35], and for the Crohns case-control comparison, we used only subjects from the MetaHIT consortium [52, 53].  #@NEW_LINE#@#  

Modeling_gene-phenotype_associations  #@NEW_LINE#@#  
The basic design is the same for all models that we fit: we model the effect of a categorical variable, gene (specifically, FIGfam family) presence vs. absence, on a particular phenotype estimated for many microbes from data.  #@NEW_LINE#@#  
Here, let  refer to a vector whose elements m,x,E[,D](A) refer to an estimate of the phenotype  for a microbe m, in an environment ex from a set of k environments E = {e1, ek}, optionally also adjusting for potential dataset effects D, based on a matrix of microbial presence-absence data A.  #@NEW_LINE#@#  We then model the effect on this phenotype of having vs. lacking each particular gene g, fitting one model per gene:  #@NEW_LINE#@#  

where 0 is a baseline intercept value, 1,g is the effect size of gene g,  is a binary vector whose elements Ig,m are 1 when microbe ms pangenome contains the gene g and 0 otherwise, and  are the residuals.  #@NEW_LINE#@#  We then test the null hypothesis H0: 1,g = 0, yielding one p-value per gene; the resulting genewise p-values are finally corrected for multiple testing using an adaptive false discovery rate approach (q-value estimation).  #@NEW_LINE#@#  
The differences in the models we fit concern only how we obtain phenotype estimates , and our assumptions about how the residuals  are distributed.  #@NEW_LINE#@#  

Fitting_linear_vs_phylogenetic_models  #@NEW_LINE#@#  
The phylogenetic and standard linear models are very similar, except for the assumptions about the distribution of the residuals.  #@NEW_LINE#@#  In the standard linear model, the residuals are assumed to be independently and identically distributed as a normal distribution, i.e.,  or using multivariate notation .  #@NEW_LINE#@#  In the phylogenetic model, in contrast, the residuals are not independent: rather, they are correlated based on the phylogenetic relatedness of the species.  #@NEW_LINE#@#  They are therefore distributed , with the following covariance matrix:  #@NEW_LINE#@#  

where i is the number of species, 2 is the overall variance, and 1,2 is the covariance between species 1 and species 2.  #@NEW_LINE#@#  Under the assumption of the phylogenetic model (evolution of a continuous phenotype according to Brownian motion), this covariance is proportional to the distance between the last common ancestor of species 1 and 2 and the root of the tree.  #@NEW_LINE#@#  Thus, very closely-related species have a common ancestor that is far from the root, while the last common ancestor of two unrelated species is the root node itself.  #@NEW_LINE#@#  This method was first described in Grafen [26]; for this study, we use the implementation in the phylolm R package [76].  #@NEW_LINE#@#  
1 parameters were tested for a significant difference from 0 and the resulting p-values were converted to q-values using Storey and Tibshiranis FDR correction procedure [77, 78].  #@NEW_LINE#@#  

Metagenomic_presence-absence_data  #@NEW_LINE#@#  
We use binary presence-absence data to calculate the phenotypes of interest.  #@NEW_LINE#@#  More formally, we conceptualize the metagenomic data as a matrix A of microbial presence-absence with dimensions i Ã j, where i is the number of microbes and j is the number of samples, and am,n is 1 if the relative abundance of microbe m (calculated using MIDASs taxonomic profiling [32]) is greater than 0, and 0 otherwise:  #@NEW_LINE#@#  

We conceptualize each e1, e2, , ek  E as a set of indices, referring to samples collected from that environment, e.g., the oropharynx in healthy subjects, or the gut in subjects with Crohns disease, such that for all ex  E, ex  {1, 2, , j}.  #@NEW_LINE#@#  Because one environment may be tested in multiple studies, for our prevalence estimates, we also define a similar mapping of samples to datasets d1, d2, , dl  D such that for all dy  D, dy  {1, 2, , j}.  #@NEW_LINE#@#  (For calculating environmental specificity scores, to avoid having to correct for unbalanced designs, we only use single datasets that measured all environments to be compared.)  #@NEW_LINE#@#  We also assume that E and D are partitions of {1, 2, , j}, such that every sample is covered and no sample belongs to multiple ex or dy.  #@NEW_LINE#@#  

Estimating_the_prevalence_phenotype  #@NEW_LINE#@#  
The first phenotype we consider is prevalence, p. Prevalence is usually defined as the fraction of samples in which a particular taxon is observed.  #@NEW_LINE#@#  Using the formulation above, the prevalence of microbe m in environment ex and study dy would be equal to:  #@NEW_LINE#@#  

where we denote the quantity (1), yielding the number of samples in the intersection of environment ex and study dy, as ||ex  dy||.  #@NEW_LINE#@#  
We now take a slightly more general definition, such that a particular taxons true prevalence pm,(ex  dy) is the probability of observing a particular microbe m in a set of samples (ex  dy), P(m|(ex  dy)).  #@NEW_LINE#@#  More specifically, we can say that  is the probability parameter of the Bernoulli random variable am,n, n  (ex  dy), which generates the values in our data matrix A:  #@NEW_LINE#@#  

The maximum likelihood estimator of  given the data matrix A is then, as above, the fraction of subjects in F in which microbe m was observed:  #@NEW_LINE#@#  

Because p is a proportion or probability, it is bounded between 0 and 1.  #@NEW_LINE#@#  The distribution of p is therefore highly non-normal, potentially violating assumptions of our regression model.  #@NEW_LINE#@#  We will therefore use logit(p) as our phenotype.  #@NEW_LINE#@#  However, this now introduces a problem because  can take the values 0 and 1, leading to infinite estimates of .  #@NEW_LINE#@#  We therefore instead use a shrunken estimate of .  #@NEW_LINE#@#  
Shrinkage estimators reduce the variance in the estimate of a parameter by combining it with prior information.  #@NEW_LINE#@#  These priors can be estimated from data (as in empirical Bayes approaches), estimated from independent information about the distribution of the parameter, or selected to be uninformative.  #@NEW_LINE#@#  Here, we use an uninformative prior, in this case a uniform distribution:  #@NEW_LINE#@#  

Mechanistically, this is equivalent to performing additive smoothing, which effectively adds one pseudocount to the numbers of absences and presences:  #@NEW_LINE#@#  

Finally, we note that this estimate of prevalence is only valid within a single study dy.  #@NEW_LINE#@#  However, what we really want is an estimator of prevalence that depends only on the environment ex.  #@NEW_LINE#@#  We therefore marginalize out the effect of dy:  #@NEW_LINE#@#  

where we let the prior probability P(dy) simply be the inverse of the number of datasets present:  #@NEW_LINE#@#  

Effectively, this weights each dataset inverse-proportionally to the number of samples, so that the study with the largest number of samples does not dominate our estimates of prevalence.  #@NEW_LINE#@#  (An alternative weighting could use, for example, the square root of the sample size, as is sometimes performed in fixed-effect meta-analyses.)  #@NEW_LINE#@#  
To avoid effects from additive smoothing dominating our estimates (as might happen if the same smoothing were applied to samples with different numbers of samples), we first obtain a marginalized version of the maximum-likelihood estimator, then perform additive smoothing on these marginalized estimates:  #@NEW_LINE#@#  

Finally, we use the logit of this estimate, i.e., , as the elements  of our first phenotype :  #@NEW_LINE#@#  

To recapitulate, we use a logit-transformed, shrunken estimate of prevalence in a given environment, weighted so that each study contributes equally.  #@NEW_LINE#@#  

Estimating_environmental_specificity_scores  #@NEW_LINE#@#  

Alternatives_to_shrinkage_estimation_of_environmental_specificity_scores  #@NEW_LINE#@#  
An alternative to using the Laplace shrinkage estimator would be to allow all taxa to contribute to the regression, but to downweight taxa with less-confidently measured phenotypes.  #@NEW_LINE#@#  In generalized least squares (GLS), this is typically accomplished by scaling the variance-covariance matrix of the residuals by the variances of the estimators.  #@NEW_LINE#@#  This in effect says that the residuals are expected to be more dispersed around the regression line when the variance of the estimator is high: equivalently, this procedure weights each point in least-squares by the inverse of the estimators variance.  #@NEW_LINE#@#  We represent these variances as .  #@NEW_LINE#@#  The covariance matrix is then:  #@NEW_LINE#@#  

where  values are as above.  #@NEW_LINE#@#  (Off-diagonal elements are weighted by the geometric mean of the variances, thus giving the same correlation structure as before.)  #@NEW_LINE#@#  
Because we have the data matrix A from which  was estimated, we can estimate the variances of these estimates by bootstrapping.  #@NEW_LINE#@#  Denoting the  estimates derived from bootstrap sample c as , where c  {1, C} and C is the number of bootstraps, and letting the mean across bootstrap samples be , then .  #@NEW_LINE#@#  
Both approaches (Laplace shrinkage estimation and WLS) account for variability in the accuracy of estimating sm,x,E, but in different ways.  #@NEW_LINE#@#  We would expect them to agree more when sm,x,E values were more confidently estimated (meaning the evidence for difference from the prior would be stronger and the extent of downweighting would be lower), and when more of the sm,x,E values diverged substantially from the prior (leading to less sparsity in ).  #@NEW_LINE#@#  Indeed, when comparing body site specificities, which are based on higher numbers of samples and involve comparisons across highly divergent environments, both approaches yield more similar estimates, and become more concordant when the effect sizes are calculated only over significantly-different gene families.  #@NEW_LINE#@#  In contrast, for the Crohns disease comparison, in which the environments (healthy vs. diseased gut) are more closely related and the number of samples is smaller, the two methods tend to disagree more, especially in phyla where most taxa are shrunk back to the prior (S2 Table).  #@NEW_LINE#@#  (We implemented WLS using the gls function provided by the nlme R package [80].)  #@NEW_LINE#@#  
These results reflect the different underlying assumptions of each estimator: Laplace shrinkage assumes that taxa are not truly varying across environments without strong evidence, while WLS uses information from all taxa but downweights less-confidently-observed species.  #@NEW_LINE#@#  For the purposes of this manuscript, we focused on the results based on Laplace shrinkage estimation, since we believe the assumption that most taxa do not change is appropriate when comparing the same body site in health and disease.  #@NEW_LINE#@#  However, either approach may be preferable depending on the precise scenario being studied.  #@NEW_LINE#@#  It could also be possible to combine the two approaches by, for example, using the full posterior distribution of  to derive weights.  #@NEW_LINE#@#  

Power_analysis  #@NEW_LINE#@#  
To test the power and false positive rate of our method, we used parametric simulations, either under the null hypothesis in which a gene had no effect on the phenotype, or under the alternative hypothesis in which it had a defined effect.  #@NEW_LINE#@#  These involved generating one binary genotype and one continuous phenotype per simulation.  #@NEW_LINE#@#  These were parameterized as follows:  #@NEW_LINE#@#  
We perform the following process, given a choice of  and 1, for each phylum h:  #@NEW_LINE#@#  
The binary genotype effect size 1 is not a linear function of the effect of the gene on prevalence.  #@NEW_LINE#@#  A more intuitive description of the effect size might be the (average) fold-change in prevalence associated with a genes presence.  #@NEW_LINE#@#  Because the parameters Test are on a logit scale, this quantity would be equal to:  #@NEW_LINE#@#  

This quantity will depend on the amount of phylogenetic signal in the binary genotype , the tree along which genotypes and phenotypes are simulated, and the input effect size 1.  #@NEW_LINE#@#  Accordingly, we simulated sets of 50 binary genotypes with given effect sizes 1  {0, 0.5, 0.75, 1.0, 1.25} and values of   {0, 25, 50}.  #@NEW_LINE#@#  While there is substantial variation, in general an input effect size (i.e., 1) of 1.0 approximately corresponds to F  1.72, a 72% increase in prevalence, and an input effect size of 0.5 corresponds to F  1.5, a 50% increase (S8 Fig).  #@NEW_LINE#@#  

Assessing_the_potential_impact_of_sampling_with_left-censoring  #@NEW_LINE#@#  
One potential pitfall with applying linear methods occurs when the distribution of the response variable (here, our phenotype) has a minimum value.  #@NEW_LINE#@#  This arises because, within a particular dataset, the lowest possible value of  is equal to (||ex|| + 2)1, where ||ex|| is the number of samples in environment ex.  #@NEW_LINE#@#  This phenomenon is referred to as left-censoring.  #@NEW_LINE#@#  (Some may have encountered the term left-censoring in the context of participants who join a study having already experienced an event of interest.  #@NEW_LINE#@#  The time they experienced this event is therefore lower by an unknown amount than the lowest-possible measured value.  #@NEW_LINE#@#  While the domain and application are different, the statistical phenomenon is the same.)  #@NEW_LINE#@#  Left-censoring can result in inaccurate p-values because the variance is mis-estimated for the data points below the limit of detection.  #@NEW_LINE#@#  We therefore empirically assessed the impact of left-censoring in simulation, and also created extensions of the method to be used when its impact is noticeable.  #@NEW_LINE#@#  
Empirically, our prevalence phenotype  displays substantial left-censoring (S6A Fig).  #@NEW_LINE#@#  The distribution of this phenotype fits well to a normal with left-censoring at the limit of detection, in this case approximately 0.50 standard deviations below the mean (AIC using truncated normal and censoring: 20844.82; AIC using standard normal: 21833.38).  #@NEW_LINE#@#  
We therefore repeated the simulation process above, but after using our continuous phenotype to generate the binary genotype in step 2.b, we truncated the continuous phenotype  artificially at a specified number of standard deviations K below the mean, yielding .  #@NEW_LINE#@#  We then replaced  with  in the regression in step 2.c.  #@NEW_LINE#@#  
Using this simulation framework, we benchmarked three different ways to test the significance of  in the phylogenetic model.  #@NEW_LINE#@#  We computed p-values in one of the following three ways:  #@NEW_LINE#@#  
Intuitively, the second method generates a null distribution via simulation, while the third method additionally reduces the impact of data points at the limit of detection, by randomly imputing them from the best-fit normal distribution.  #@NEW_LINE#@#  We then calculated power and FPR for each of these three methods, varying the amount of censoring K and the effect size 1 (see S7 Fig).  #@NEW_LINE#@#  Interestingly, for the level of censoring in our data (K = 0.50), the false-positive rate in all three methods remained well-controlled, although power dropped.  #@NEW_LINE#@#  The mock-uncensored bootstrap had lower power overall and became more conservative, especially in the case where the phylogenetic signal was highest ( = 0) and where the level of censorship K was highest.  #@NEW_LINE#@#  
Another common approach to this problem is the tobit model: the true value of the response variable is treated as a hidden variable, and expectation-maximization is used to fit the regression parameters based on the observed censored values.  #@NEW_LINE#@#  Given that the degree of censoring we observed did not appear to inflate the false positive rate in any of the methods we tested, we opted not to construct a phylogenetic tobit model; however, this could be an interesting area of future research.  #@NEW_LINE#@#  

Assessing_the_impact_of_compositionality  #@NEW_LINE#@#  
Because relative abundances are compositional (i.e., sum to 1), changes in highly abundant taxa combined with read sampling can lead to skewed estimates of relative abundance.  #@NEW_LINE#@#  For example, if a very abundant microbe exhibits large changes in relative abundance across samples, other microbes will appear to become less abundant simply because they make up a smaller proportion of the total reads, regardless of whether their level has actually changed [82].  #@NEW_LINE#@#  This necessitates the use of compositional data analysis methods such as fitting intrinsically compositional distributions to the data (e.g., multinomial [83]) or transforming them such that they no longer lie on a simplex (e.g., the clr-transform [84]).  #@NEW_LINE#@#  However, the impact of compositionality on prevalence was a priori less clear, because while prevalences are based on presence versus absence, which could be affected by sampling, prevalences themselves do not have to sum to any particular value.  #@NEW_LINE#@#  Nonetheless, since we compute prevalence from relative abundance, we undertook a simulation based investigation of prevalence estimation accuracy as a function of various study design and biological parameters.  #@NEW_LINE#@#  
To directly compare the degree to which spurious correlation in prevalence and relative abundance could be induced by compositionality, we simulated correlated absolute abundances of microbes with no true correlations between them, then converted these uncorrelated absolute abundances to relative abundances.  #@NEW_LINE#@#  To look for spurious correlation, we plotted the distribution of pairwise microbial correlations in absolute and relative abundances.  #@NEW_LINE#@#  We next used relative abundance to compute prevalence.  #@NEW_LINE#@#  Since there is only one prevalence measurement per microbe per data matrix, we repeated the simulation multiple times with the same parameters, then assessed microbial correlations across simulation runs, again starting from both absolute and relative abundances.  #@NEW_LINE#@#  

Enrichment_analysis  #@NEW_LINE#@#  
Enrichment analysis was performed using SEED subsystem annotations for FIGfams [88, 37].  #@NEW_LINE#@#  Each subsystem was tested for a significant overlap with significant hits from the linear models (q  0.05), given the set of FIGfams tested, by Fishers exact test.  #@NEW_LINE#@#  For each gene set, a 2 Ã 2 contingency table was constructed with the following form:  #@NEW_LINE#@#  

where subsys is the set of FIGfams in a given SEED subsystem, signif is the set of FIGfams in a particular phylum that were significant hits, and BG is the set of all FIGfams tested in that phylum.  #@NEW_LINE#@#  Two-tailed p-values were corrected using the Benjamini-Hochberg procedure [89] and an FDR of 25% was set for detecting significant enrichment and depletion (only enrichment is reported).  #@NEW_LINE#@#  We used this significance threshold in accordance with accepted practice for gene set enrichment analysis [90].  #@NEW_LINE#@#  We used the Benjamini-Hochberg procedure since unlike the q-value method it does not require the estimation of the proportion of true nulls, which is more difficult with small numbers of tests.  #@NEW_LINE#@#  

Overlap_with_in_vivo_results  #@NEW_LINE#@#  
Results of the screen were obtained from the Supplemental Material of Wu et al.  #@NEW_LINE#@#  (downloaded on 2017 May 3) [48].  #@NEW_LINE#@#  Genes were mapped to FIGfams by matching identifiers in the Supplemental Material to genome annotations from PATRIC [67].  #@NEW_LINE#@#  Significance of overlap between these genes and the results for the Bacteroidetes phylum from the body-site-specific or overall models was determined by Fishers exact test.  #@NEW_LINE#@#  
This test depends both on how we determine which genes from the in vivo screen count as true positives, and on the choice of the background set, i.e., which genes would be possible to find in the in vivo study.  #@NEW_LINE#@#  Rather than committing to one method of picking the true positive and background sets, we instead enumerated several possibilities, performed all possible combinations (S3 Table), and corrected for multiple comparisons.  #@NEW_LINE#@#  The options we tested for true positive sets were 1. genes in the screen that were significantly associated with fitness in all four Bacteroides strains tested, 2.  #@NEW_LINE#@#  Bacteroides thetaiotaomicron genes significantly associated with diet-independent fitness effects, and 3.  #@NEW_LINE#@#  B. thetaiotaomicron genes associated with either diet-dependent or -independent effects.  #@NEW_LINE#@#  The background sets we tested were 1. all gene families for which a phylogenetic model was fit, 2. all gene families appearing at least once in a Bacteroides genome cluster pangenome, 3. all gene families present in all Bacteroides pangenomes, 4. gene families present in some but not all Bacteroides pangenomes, and 5. gene families present in Bacteroides thetaiotaomicron.  #@NEW_LINE#@#  Similarly to our approach to gene set enrichment analysis, for each test we assembled a 2x2 contingency table as follows:  #@NEW_LINE#@#  

where pos refers to the true positive FIGfam set, signif refers to the set of significant FIGfam hits from the phylogenetic model, and BG refers to the background FIGfam set.  #@NEW_LINE#@#  The full results are depicted in S3 Table, with the results for true positive set #1 excerpted from this full comparison in Table 1.  #@NEW_LINE#@#  

Codebase  #@NEW_LINE#@#  
The analyses were carried out using R [91].  #@NEW_LINE#@#  The code used to perform these analyses is available at http://www.bitbucket.com/pbradz/plr in the form of an Rmarkdown notebook [92].  #@NEW_LINE#@#  
Other R packages used include phylolm [76], phyloseq [93], rentrez [65], pbapply [94], XML [95], qvalue [77], magrittr [96], compiler [91], phytools [97], ggtree [98], gridExtra [99], MASS [100], nlme [80], fitdistrplus [81], truncnorm [101], ape [102], geiger [103], MCMCpack [104], knitr [105], data.table [106], parallel [91], and dplyr [107].  #@NEW_LINE#@#  


Supporting_information  #@NEW_LINE#@#  
S1_Appendix_Glossary_of_terms  #@NEW_LINE#@#  
Reference material giving definitions of mathematical symbols used in the Methods.  #@NEW_LINE#@#  
https://doi.org/10.1371/journal.pcbi.1006242.s001  #@NEW_LINE#@#  
(PDF)  #@NEW_LINE#@#  

S1_Table_Species_prevalences__gut_specificities__and_Crohn_s_disease_specificities_for_all_genome_clusters_(species)_tested  #@NEW_LINE#@#  
logit.Prevalence, logit.BodySite, and logit.Crohns column titles refer to our estimates of , , and , respectively.  #@NEW_LINE#@#  Row labels (5-digit numbers) correspond to MIDAS taxon IDs.  #@NEW_LINE#@#  
https://doi.org/10.1371/journal.pcbi.1006242.s002  #@NEW_LINE#@#  
(CSV)  #@NEW_LINE#@#  

S2_Table_Concordance_of_1_g_estimates_for_weighted_least_squares_vs_Laplace_shrinkage_procedures  #@NEW_LINE#@#  
Pearsons correlation coefficient r comparing estimates of 1,g for the weighted phylogenetic least squares procedure with the unweighted phylogenetic least squares using Laplace-shrunken estimates of specificity scores were computed across: all tested genes (all), all genes significant in either the weighted or shrunken phylogenetic model (one significant), or all genes significant in both models (both significant).  #@NEW_LINE#@#  Comparisons were performed for both body site environmental specificity scores (bodysite) and Crohns disease (Crohns).  #@NEW_LINE#@#  Additionally, the number of taxa not shrunk back to the prior by Laplace shrinkage for each environmental specificity score are given (non-shrunk).  #@NEW_LINE#@#  
https://doi.org/10.1371/journal.pcbi.1006242.s003  #@NEW_LINE#@#  
(XLSX)  #@NEW_LINE#@#  

S3_Table_Full_assessment_of_whether_genes_linked_to_microbial_fitness_in_an_in_vivo_experiment_[48]_were_enriched_for_significant_hits_of_the_body_site-specific_and_overall_gut_prevalence_models  #@NEW_LINE#@#  
The different sets of true positives were defined as: Bacteroides (genes in the screen significantly associated with fitness in all four strains), BthetaDietIndep (genes present in Bacteroides thetaiotaomicron that had diet-independent fitness effects in the screen), and BthetaAny (same, but for diet-dependent as well as -independent effects).  #@NEW_LINE#@#  The background sets were defined as follows: all tested (all gene families for which a phylogenetic model was fit), Bacteroides (core or variable) (all gene families with at least one representative in Bacteroides genome cluster pangenomes), Bacteroides (core only) (gene families that were present in all Bacteroides genome cluster pangenomes), Bacteroides (variable only) (gene families present in some but not all Bacteroides genomes clusters), and Bacteroides thetaiotaomicron only (only gene families present in Bacteroides thetaiotaomicron).  #@NEW_LINE#@#  Two false discovery rates for each model were tested (5% and 25%).  #@NEW_LINE#@#  Fisher tests yielded p-values that were then converted to q-values using the Benjamini-Hochberg approach [89].  #@NEW_LINE#@#  
https://doi.org/10.1371/journal.pcbi.1006242.s004  #@NEW_LINE#@#  
(XLSX)  #@NEW_LINE#@#  

S4_Table_SRA_accession_IDs_used_to_estimate_prevalence_and_environmental_specificity_scores  #@NEW_LINE#@#  
https://doi.org/10.1371/journal.pcbi.1006242.s005  #@NEW_LINE#@#  
(CSV)  #@NEW_LINE#@#  

S1_Fig_Estimates_of_logit-gut_prevalence_(x-axis)_vs_logit-gut_environmental_specificity_score_(y-axis)__showing_only_modest_correlation  #@NEW_LINE#@#  
https://doi.org/10.1371/journal.pcbi.1006242.s006  #@NEW_LINE#@#  
(PDF)  #@NEW_LINE#@#  

S2_Fig_Method_overview  #@NEW_LINE#@#  
Using MIDAS, we calculate species relative abundances from shotgun sequencing data.  #@NEW_LINE#@#  These are binarized to yield a matrix of microbial presence/absence, with rows corresponding to microbes and columns corresponding to samples.  #@NEW_LINE#@#  Samples are organized into environments (i.e., the environments from which the sample was collected) and into datasets (corresponding to samples collected as part of the same project).  #@NEW_LINE#@#  Using the presence/absence matrix together with these metadata, we estimate phenotype vectors , whose elements are estimates of microbial phenotypes.  #@NEW_LINE#@#  These phenotypes fall into two groups: prevalence () and environmental specificity scores ().  #@NEW_LINE#@#  Separately, we use the whole genomes incorporated into the MIDAS database to assemble a matrix of gene presence/absence in the pangenome of microbes, and to construct a phylogenetic species tree based on previously-validated single-copy marker genes.  #@NEW_LINE#@#  We subset this tree to yield four phylum-specific trees.  #@NEW_LINE#@#  The inputs to our phylogenetic models are a phenotype vector, a gene presence-absence vector, and a phylogenetic tree.  #@NEW_LINE#@#  Based on these models, we estimate p-values for a non-zero effect of the gene on the phenotype, then convert these p-values into q-values to obtain predicted gene-phenotype interactions at a given false discovery rate (here, 5%).  #@NEW_LINE#@#  
https://doi.org/10.1371/journal.pcbi.1006242.s007  #@NEW_LINE#@#  
(PDF)  #@NEW_LINE#@#  

S3_Fig_Laplacian_regularization_reduces_noise_in_estimating_  #@NEW_LINE#@#  
Two species are compared, one that was infrequently observed in both Crohns disease cases and controls (Bacillus subtilis, left) and one with a significant bias for Crohns disease cases (Bacteroides fragilis, right).  #@NEW_LINE#@#  A) Total counts across subjects for Bacillus subtilis and Bacteroides fragilis.  #@NEW_LINE#@#  B) Likelihood function for , or prevalence in Crohns disease.  #@NEW_LINE#@#  The maximum-likelihood value is given in the inset.  #@NEW_LINE#@#  C) Unregularized likelihood for , or the environmental specificity of the microbe.  #@NEW_LINE#@#  Note that the maximum-likelihood value (inset) was actually almost twice as large for Bacillus subtilis as for Bacteroides fragilis despite the relative paucity of data for B. subtilis (compare Y-axes, which show that the distribution for B. subtilis is flatter).  #@NEW_LINE#@#  D) Laplace prior around P(eCD) = 0.002 with width parameter b = 0.16 (optimized using simulation).  #@NEW_LINE#@#  E) Log-likelihood plot for the posterior , obtained by taking the product of the prior distribution and the unregularized distribution.  #@NEW_LINE#@#  The maximum a posteriori (MAP) estimates are the modes of these distributions (inset).  #@NEW_LINE#@#  
https://doi.org/10.1371/journal.pcbi.1006242.s008  #@NEW_LINE#@#  
(PDF)  #@NEW_LINE#@#  

S4_Fig_Sensitivity_plot_for__tolerance_parameter_in_Laplace_shrinkage  #@NEW_LINE#@#  
Y-axis gives the best boptim value obtained given a particular log10() selected when performing Laplace shrinkage of  estimates.  #@NEW_LINE#@#  The value of  used in the manuscript (0.005) is highlighted with a vertical dashed line.  #@NEW_LINE#@#  
https://doi.org/10.1371/journal.pcbi.1006242.s009  #@NEW_LINE#@#  
(PDF)  #@NEW_LINE#@#  

S5_Fig_Illustration_showing_logit-prevalence_vs_the_pattern_of_glutamate-GABA_decarboxylase_(gadC)_inheritance_in_Bacteroidetes  #@NEW_LINE#@#  
As in Fig 2, the tree on the left is colored by species prevalence (black to orange), while the tree on the right is colored by gene presence-absence (blue to black), with selected species called out in the middle, and lines linking species labels to leaves that match leaf color.  #@NEW_LINE#@#  
https://doi.org/10.1371/journal.pcbi.1006242.s010  #@NEW_LINE#@#  
(PDF)  #@NEW_LINE#@#  

S6_Fig_Distribution_of_estimated_logit-prevalence___showing_impact_of_censoring  #@NEW_LINE#@#  
A) Density of estimated logit-prevalence distribution, , showing pile-up of values at the limit of detection K. B) Density of a normal distribution with mean and standard deviation obtained from best-fit of truncated normal to .  #@NEW_LINE#@#  C) Uncensored version of .  #@NEW_LINE#@#  Data points at or below K have been replaced by random sampling from a truncated normal, with mean and standard deviation as in B and with K as upper truncation point.  #@NEW_LINE#@#  
https://doi.org/10.1371/journal.pcbi.1006242.s011  #@NEW_LINE#@#  
(PDF)  #@NEW_LINE#@#  

S7_Fig_Impact_of_left-censoring_on_the_false_positive_rate_and_power_of_phylogenetic_tests  #@NEW_LINE#@#  
Bars give replicate measurements of false positive rate (left, effect size of 0) and power (right, effect size of 0.75) across the different phyla (colors), based on simulating binary genotypes and continuous phenotypes as in Methods, Power analysis, with varying levels of left-censoring (censoring point), and obtaining p-values with the three methods described in Methods, Assessing the potential impact of sampling with left-censoring.  #@NEW_LINE#@#  Horizontal dashed lines give a rate of 0.05.  #@NEW_LINE#@#  Binary genotypes had varying levels of Ives-Garland  (0, 25, 50), representing high to low phylogenetic signal.  #@NEW_LINE#@#  
https://doi.org/10.1371/journal.pcbi.1006242.s012  #@NEW_LINE#@#  
(PDF)  #@NEW_LINE#@#  

S8_Fig_Simulations_showing_the_prevalence_ratios_F_corresponding_to_various_effect_sizes  #@NEW_LINE#@#  
To give a more intuitive sense of scale for simulated effect sizes, simulations were performed as in Methods, Power analysis, with effect sizes 1 ranging from 0 to 1.25.  #@NEW_LINE#@#  After fitting phylogenetic models to the simulated phenotypes and genotypes, the average prevalences with the simulated gene, logistic(1,g + 0,g), and without, logistic(0,g), were computed, and their ratio F was taken.  #@NEW_LINE#@#  log2(F) is plotted here, such that a value of 1 means the gene conferred (on average) a 2-fold change in prevalence.  #@NEW_LINE#@#  Violin plots were made of 50 simulations.  #@NEW_LINE#@#  
https://doi.org/10.1371/journal.pcbi.1006242.s013  #@NEW_LINE#@#  
(PDF)  #@NEW_LINE#@#  

S9_Fig_Results_of_simulations_illustrating_compositionality_artifacts_in_relative_abundances__but_not_prevalence_estimates  #@NEW_LINE#@#  
Lines are density plots of all pairwise correlations (either over all samples or over only non-zero values) for (A), the relative abundance of microbes within a simulation, and (B), the prevalence of simulated microbes across simulations with the same m (mean) and zm (zero-inflation) values.  #@NEW_LINE#@#  A) Pairwise correlations for absolute abundances  (black), column-normalized relative abundances  (blue), and relative abundances obtained through Dirichlet-Multinomial sampling  are shown, along with pairwise correlations over non-zero elements of relative abundances obtained through Dirichlet-Multinomial sampling .  #@NEW_LINE#@#  B) Pairwise correlations for true prevalences , for true prevalences above a sampling floor , and for prevalences calculated from relative abundances obtained through Dirichlet-Multinomial sampling  are compared.  #@NEW_LINE#@#  
https://doi.org/10.1371/journal.pcbi.1006242.s014  #@NEW_LINE#@#  
(PDF)  #@NEW_LINE#@#  

S10_Fig_Reliability_of_prevalence_estimates__assuming_that_most_microbes_are_low-prevalence_in_the_given_environment  #@NEW_LINE#@#  
We simulated microbiome data using Dirichlet-Multinomial sampling combined with zero inflation.  #@NEW_LINE#@#  Here, we assumed that true prevalences were distributed .  #@NEW_LINE#@#  We then plotted (blue contours) the true logit-prevalence zm (x-axis) versus the calculated logit-prevalence from the simulation , for varying geometric-mean read depths rn (columns) and sample sizes ||N|| (rows).  #@NEW_LINE#@#  The values given for each sample size and read depth are the Pearson correlation r, the Pearson correlation over non-censored microbes only runc, and the percent of microbes with censored prevalences (cens).  #@NEW_LINE#@#  
https://doi.org/10.1371/journal.pcbi.1006242.s015  #@NEW_LINE#@#  
(PDF)  #@NEW_LINE#@#  

S11_Fig_Reliability_of_prevalence_estimates__assuming_that_microbial_prevalence_is_centered_on_50%_in_the_given_environment  #@NEW_LINE#@#  
As in S10 Fig, but with .  #@NEW_LINE#@#  
https://doi.org/10.1371/journal.pcbi.1006242.s016  #@NEW_LINE#@#  
(PDF)  #@NEW_LINE#@#  


Acknowledgments  #@NEW_LINE#@#  
The authors would like to thank Joshua Ladau, Nandita Garud, and other members of the Pollard and Turnbaugh groups, attendees of the 2017 Keystone meeting on the Microbiome in Health and Disease, and attendees of the Second Workshop in Statistics and Algorithmic Challenges in Microbiome Data Analysis (SACMDA2) for helpful suggestions and discussions.  #@NEW_LINE#@#  

References  #@NEW_LINE#@#  



